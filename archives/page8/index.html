<!DOCTYPE html>
<html lang="fr">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="apple-touch-icon" href="https://virtual-thom.github.io/archives/apple-touch-icon.png">
  <link rel="icon" href="https://virtual-thom.github.io/archives/favicon.ico" />
  <!-- Remplacé par Jekyll SEO (sinon apparait en double)
  <title>Virtual-Thom | Blog-notes VTOM et informatique</title>
  <meta name="description" content="Blog-notes VTOM, informatique, industrialisation, ordonnancement, DevOps">
  --> 
  
  <link rel="canonical" href="https://virtual-thom.github.io/archives/page8/">
  
  <link rel="stylesheet" media="screen" href="https://virtual-thom.github.io/archives/assets/main.css">
  
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Page 8 of 14 for Virtual-Thom Blog-notes VTOM et informatique | Blog-notes VTOM, informatique, industrialisation, ordonnancement, DevOps</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Virtual-Thom Blog-notes VTOM et informatique" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Blog-notes VTOM, informatique, industrialisation, ordonnancement, DevOps" />
<meta property="og:description" content="Blog-notes VTOM, informatique, industrialisation, ordonnancement, DevOps" />
<link rel="canonical" href="https://virtual-thom.github.io/archives/page8/" />
<meta property="og:url" content="https://virtual-thom.github.io/archives/page8/" />
<meta property="og:site_name" content="Virtual-Thom Blog-notes VTOM et informatique" />
<meta property="og:type" content="website" />
<link rel="prev" href="https://virtual-thom.github.io/archives/page7" />
<link rel="next" href="https://virtual-thom.github.io/archives/page9" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Virtual-Thom Blog-notes VTOM et informatique" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Blog-notes VTOM, informatique, industrialisation, ordonnancement, DevOps","headline":"Virtual-Thom Blog-notes VTOM et informatique","url":"https://virtual-thom.github.io/archives/page8/"}</script>
<!-- End Jekyll SEO tag -->

  
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z8Y7902GRV"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Z8Y7902GRV');
</script>


  <body>
    <div class="container">
      <header id="site-header">
  <h1>Blog-notes VTOM, informatique, industrialisation, ordonnancement, DevOps</h1>
  <nav>
    <ul>
      <li>
        <a href="https://virtual-thom.github.io/archives" title="Home">
          <svg class="svg-icon" viewbox="0 0 20 20">
            <path d="M18.121,9.88l-7.832-7.836c-0.155-0.158-0.428-0.155-0.584,0L1.842,9.913c-0.262,0.263-0.073,0.705,0.292,0.705h2.069v7.042c0,0.227,0.187,0.414,0.414,0.414h3.725c0.228,0,0.414-0.188,0.414-0.414v-3.313h2.483v3.313c0,0.227,0.187,0.414,0.413,0.414h3.726c0.229,0,0.414-0.188,0.414-0.414v-7.042h2.068h0.004C18.331,10.617,18.389,10.146,18.121,9.88 M14.963,17.245h-2.896v-3.313c0-0.229-0.186-0.415-0.414-0.415H8.342c-0.228,0-0.414,0.187-0.414,0.415v3.313H5.032v-6.628h9.931V17.245z M3.133,9.79l6.864-6.868l6.867,6.868H3.133z"></path>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://virtual-thom.github.io/archives/vos-commentaires-livre-d-or/" title="Commentaires - livre d'or">
          <svg class="svg-icon" viewbox="0 0 20 20">
            <path d="M17.657,2.982H2.342c-0.234,0-0.425,0.191-0.425,0.426v10.21c0,0.234,0.191,0.426,0.425,0.426h3.404v2.553c0,0.397,0.48,0.547,0.725,0.302l2.889-2.854h8.298c0.234,0,0.426-0.191,0.426-0.426V3.408C18.083,3.174,17.892,2.982,17.657,2.982M17.232,13.192H9.185c-0.113,0-0.219,0.045-0.3,0.124l-2.289,2.262v-1.96c0-0.233-0.191-0.426-0.425-0.426H2.767V3.833h14.465V13.192z M10,7.237c-0.821,0-1.489,0.668-1.489,1.489c0,0.821,0.668,1.489,1.489,1.489c0.821,0,1.488-0.668,1.488-1.489C11.488,7.905,10.821,7.237,10,7.237 M10,9.364c-0.352,0-0.638-0.288-0.638-0.638c0-0.351,0.287-0.638,0.638-0.638c0.351,0,0.638,0.287,0.638,0.638C10.638,9.077,10.351,9.364,10,9.364 M14.254,7.237c-0.821,0-1.489,0.668-1.489,1.489c0,0.821,0.668,1.489,1.489,1.489s1.489-0.668,1.489-1.489C15.743,7.905,15.075,7.237,14.254,7.237 M14.254,9.364c-0.351,0-0.638-0.288-0.638-0.638c0-0.351,0.287-0.638,0.638-0.638c0.352,0,0.639,0.287,0.639,0.638C14.893,9.077,14.605,9.364,14.254,9.364 M5.746,7.237c-0.821,0-1.489,0.668-1.489,1.489c0,0.821,0.668,1.489,1.489,1.489c0.821,0,1.489-0.668,1.489-1.489C7.234,7.905,6.566,7.237,5.746,7.237 M5.746,9.364c-0.351,0-0.638-0.288-0.638-0.638c0-0.351,0.287-0.638,0.638-0.638c0.351,0,0.638,0.287,0.638,0.638C6.384,9.077,6.096,9.364,5.746,9.364"></path>
          </svg>
        </a>
      </li>
      
      <li>
        <a href="https://virtual-thom.github.io/about" title="Curriculum Vitae Thom">
          <svg class="svg-icon" viewbox="0 0 20 20">
            <path d="M12.075,10.812c1.358-0.853,2.242-2.507,2.242-4.037c0-2.181-1.795-4.618-4.198-4.618S5.921,4.594,5.921,6.775c0,1.53,0.884,3.185,2.242,4.037c-3.222,0.865-5.6,3.807-5.6,7.298c0,0.23,0.189,0.42,0.42,0.42h14.273c0.23,0,0.42-0.189,0.42-0.42C17.676,14.619,15.297,11.677,12.075,10.812 M6.761,6.775c0-2.162,1.773-3.778,3.358-3.778s3.359,1.616,3.359,3.778c0,2.162-1.774,3.778-3.359,3.778S6.761,8.937,6.761,6.775 M3.415,17.69c0.218-3.51,3.142-6.297,6.704-6.297c3.562,0,6.486,2.787,6.705,6.297H3.415z"></path>
          </svg>
        </a>
      </li>
    </ul>
  </nav>
</header>

      <nav>
  <ul class="pagination">
    
    <li>
      <a href="/page7" class="Précédant">
        <span aria-hidden="true">«</span>
      </a>
    </li>
      
    <li>
      <a href="/archives/index.html">1</a>
    </li>
      
    <li>
      <a href="/archives/page2">2</a>
    </li>
      
    <li>
      <a href="/archives/page3">3</a>
    </li>
      
    <li>
      <a href="/archives/page4">4</a>
    </li>
      
    <li>
      <a href="/archives/page5">5</a>
    </li>
      
    <li>
      <a href="/archives/page6">6</a>
    </li>
      
    <li>
      <a href="/archives/page7">7</a>
    </li>
      
    <li class="active">
      <span>8</span>
    </li>
      
    <li>
      <a href="/archives/page9">9</a>
    </li>
      
    <li>
      <a href="/archives/page10">10</a>
    </li>
      
    <li>
      <a href="/archives/page11">11</a>
    </li>
      
    <li>
      <a href="/archives/page12">12</a>
    </li>
      
    <li>
      <a href="/archives/page13">13</a>
    </li>
      
    <li>
      <a href="/archives/page14">14</a>
    </li>
      
    <li>
      <a href="/page9" aria-label="Suivant">
        <span aria-hidden="true">»</span>
      </a>
    </li>
    
  </ul>
</nav>
<ul class="post-list post-list-with-type">
  
  <li>
    <a class="post-link" href="/archives/javascript-fonction-unique-distinct/">Javascript fonction unique (distinct) sur un tableau d'objet</a>
  </li>
  
  <li>
    <a class="post-link" href="/archives/vthttpd-dump-requete-sql/">vthttpd -dump et requêtes SQL - tlist ameliore - vtexport.xml to csv</a>
  </li>
  
  <li>
    <a class="post-link" href="/archives/ressource-pile/">Ressource pile</a>
  </li>
  
  <li>
    <a class="post-link" href="/archives/border-line-VTOM/">Border Line VTOM</a>
  </li>
  
  <li>
    <a class="post-link" href="/archives/formule-vtom/">Formules VTOM</a>
  </li>
  
  <li>
    <a class="post-link" href="/archives/date-exploitation-vtom/">Date d'exploitation VTOM ne bascule pas</a>
  </li>
  
  <li>
    <a class="post-link" href="/archives/platform-sh-orange-cloud/">Platform.sh premières impressions</a>
  </li>
  
  <li>
    <a class="post-link" href="/archives/vtplan/">vtplan VTOM</a>
  </li>
  
  <li>
    <a class="post-link" href="/archives/priorite-queue-batch-vtom/">Priorité queue batch VTOM</a>
  </li>
  
  <li>
    <a class="post-link" href="/archives/export-consignes-vtom-html-docker/">VTOM export consigne html - Docker et python</a>
  </li>
  
</ul>


<div id="page-first-post">

  <div itemscope itemtype="http://schema.org/Article" class="post">

    <article class="post-content" itemprop="articleBody">
      <h1 itemprop="name about headline" class="post-title">Javascript fonction unique (distinct) sur un tableau d'objet</h1>
      <h2 id="mon-besoin-en-javascript">Mon besoin en Javascript</h2>
<p>J’ai un tableau d’objets, et je veux récupérer un tableau de valeurs uniques d’objets ayant le même attribut.</p>

<h2 id="fonction">Fonction</h2>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">_distinctUniqueValuesInArray</span> <span class="o">=</span> <span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">prop</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">arr</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nx">obj</span> <span class="o">=&gt;</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]).</span><span class="nf">filter</span><span class="p">((</span><span class="nx">v</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">==</span> <span class="nx">i</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="exemple">Exemple</h2>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">monArray</span> <span class="o">=</span> <span class="p">[</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV1</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE25</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">15</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV2</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE15</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">58</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV2</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE35</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">18</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV2</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE25</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">50</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV5</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE36</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">2</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV5</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE26</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">10</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV7</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE26</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">81</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV7</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE36</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">47</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV7</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE16</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">71</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV8</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE25</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">45</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV8</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE15</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">31</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV8</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE35</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">62</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV13</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE36</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">2</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV13</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE16</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">2</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV13</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE26</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">2</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV14</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE16</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">56</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV14</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE36</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">29</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV14</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE26</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">77</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV15</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE26</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">164</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV15</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE36</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">90</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV15</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE16</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">139</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV16</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE16</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">113</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV16</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE36</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">123</span><span class="dl">"</span><span class="p">},</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">VTENVNAME</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ENV16</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MONDOMAINE26</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">NB_JOBS_NON_STATS</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">410</span><span class="dl">"</span><span class="p">}</span>
<span class="p">]</span>
<span class="nf">_distinctUniqueValuesInArray</span><span class="p">(</span><span class="nx">monArray</span><span class="p">,</span><span class="dl">"</span><span class="s2">VTDOMAINE</span><span class="dl">"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>["MONDOMAINE25", "MONDOMAINE15", "MONDOMAINE35", "MONDOMAINE36", "MONDOMAINE26", "MONDOMAINE16"]
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>_distinctUniqueValuesInArray(monArray,"VTENVNAME")
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>["ENV1", "ENV2", "ENV5", "ENV7", "ENV8", "ENV13", "ENV14", "ENV15", "ENV16"]
</code></pre></div></div>

<h2 id="pour-aller-plus-loin">Pour aller plus loin</h2>

<p><a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Objets_globaux/Array/map">Array.prototype.map()</a></p>

<p>Mon talbeau d’entrée étant constitué d’objets, et ne voulant qu’un tableau de valeurs pour une clé donnée, je créé un nouveau tableau avec map qui satisfait mes besoins.</p>

<p><code class="language-plaintext highlighter-rouge">(arr, prop) =&gt; arr.map(obj =&gt; obj[prop])</code></p>

<p><a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Objets_globaux/Array/filter">Array.prototype.filter()</a>
<a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Objets_globaux/Array/indexOf">Array.prototype.indexOf()</a></p>

<p>Comme map() retourne un tableau, je peux l’enchainer avec filter()</p>

<p>Je ne retourne que les élements qui vérifient ma condition.</p>

<p>v (valeur), i (index), a (le tableau complet, ici monnouveautableau qui correspond à arr.map(obj =&gt; obj[prop]))</p>

<p><code class="language-plaintext highlighter-rouge">monnouveautableau.filter((v, i, a) =&gt; a.indexOf(v) == i)</code></p>

<p>En français : on boucle sur tous les élements de monnouveautableau et on retourne chaque élément dans un nouveau tableau si son index (i) correspond à l’index du premier élément (indexOf) de monnouveautableau qui a la valeur v.</p>

<p>Je ne sais pas si c’est français, mais j’me comprends !</p>

<h1 id="sort-sur-un-tableau-de-tableaux-sur-plusieurs-index">sort sur un tableau de tableaux sur plusieurs index</h1>
<p><a href="https://stackoverflow.com/a/2784879">https://stackoverflow.com/a/2784879</a></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">deepSortAlpha</span><span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">itm</span><span class="p">,</span> <span class="nx">L</span><span class="o">=</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">order</span><span class="o">=</span><span class="nx">arguments</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">alphaSort</span><span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">){</span>
        <span class="nx">a</span><span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">toLowerCase</span><span class="p">();</span>
        <span class="nx">b</span><span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">toLowerCase</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">a</span><span class="o">==</span> <span class="nx">b</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">a</span><span class="o">&gt;</span> <span class="nx">b</span><span class="p">?</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">L</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="nx">alphaSort</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">tem</span><span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="nx">indx</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span><span class="nx">tem</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">indx</span><span class="o">&lt;</span><span class="nx">L</span><span class="p">){</span>
            <span class="nx">itm</span><span class="o">=</span><span class="nx">order</span><span class="p">[</span><span class="nx">indx</span><span class="p">];</span>
            <span class="nx">tem</span><span class="o">=</span> <span class="nf">alphaSort</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">itm</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nx">itm</span><span class="p">]);</span> 
            <span class="nx">indx</span><span class="o">+=</span><span class="mi">1</span><span class="p">;</span>        
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">tem</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">monArr</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">[</span><span class="dl">"</span><span class="s2">EVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléEVOLAN2</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">YES</span><span class="dl">"</span><span class="p">],</span>
  <span class="p">[</span><span class="dl">"</span><span class="s2">ALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléALIS2</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse2</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">YES</span><span class="dl">"</span><span class="p">],</span>
  <span class="p">[</span><span class="dl">"</span><span class="s2">ALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse2</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">YES</span><span class="dl">"</span><span class="p">],</span>
  <span class="p">[</span><span class="dl">"</span><span class="s2">ALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse3</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">NO</span><span class="dl">"</span><span class="p">],</span>
  <span class="p">[</span><span class="dl">"</span><span class="s2">EVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">YES</span><span class="dl">"</span><span class="p">],</span>
  <span class="p">[</span><span class="dl">"</span><span class="s2">IAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléIAM1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">YES</span><span class="dl">"</span><span class="p">],</span>
  <span class="p">[</span><span class="dl">"</span><span class="s2">IAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">YES</span><span class="dl">"</span><span class="p">],</span>
  <span class="p">[</span><span class="dl">"</span><span class="s2">OUI</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléOUI</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applOUI</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobOUI</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domOUI</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endOUI</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">YES</span><span class="dl">"</span><span class="p">],</span>
  <span class="p">[</span><span class="dl">"</span><span class="s2">ALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléALIS2</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse2</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">NO</span><span class="dl">"</span><span class="p">],</span>
  <span class="p">[</span><span class="dl">"</span><span class="s2">EVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléEVOLAN3</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">YES</span><span class="dl">"</span><span class="p">],</span>
  <span class="p">[</span><span class="dl">"</span><span class="s2">ALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">YES</span><span class="dl">"</span><span class="p">],</span>
  <span class="p">[</span><span class="dl">"</span><span class="s2">IAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléIAM3</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">NO</span><span class="dl">"</span><span class="p">],</span>
  <span class="p">[</span><span class="dl">"</span><span class="s2">IAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléIAM2</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">NO</span><span class="dl">"</span><span class="p">],</span>
  <span class="p">[</span><span class="dl">"</span><span class="s2">IAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse2</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">NO</span><span class="dl">"</span><span class="p">]</span>
<span class="p">]</span>
<span class="nx">monArr</span><span class="p">.</span><span class="nf">deepSortAlpha</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
<span class="p">(</span><span class="mi">14</span><span class="p">)</span> <span class="p">[</span><span class="nc">Array</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="nc">Array</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="nc">Array</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="nc">Array</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="nc">Array</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="nc">Array</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="nc">Array</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="nc">Array</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="nc">Array</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="nc">Array</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="nc">Array</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="nc">Array</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="nc">Array</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="nc">Array</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>
<span class="mi">0</span><span class="p">:(</span><span class="mi">8</span><span class="p">)</span> <span class="p">[</span><span class="dl">"</span><span class="s2">ALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse3</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">NO</span><span class="dl">"</span><span class="p">]</span>
<span class="mi">1</span><span class="p">:(</span><span class="mi">8</span><span class="p">)</span> <span class="p">[</span><span class="dl">"</span><span class="s2">ALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse2</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">YES</span><span class="dl">"</span><span class="p">]</span>
<span class="mi">2</span><span class="p">:(</span><span class="mi">8</span><span class="p">)</span> <span class="p">[</span><span class="dl">"</span><span class="s2">ALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">YES</span><span class="dl">"</span><span class="p">]</span>
<span class="mi">3</span><span class="p">:(</span><span class="mi">8</span><span class="p">)</span> <span class="p">[</span><span class="dl">"</span><span class="s2">ALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléALIS2</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse2</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">NO</span><span class="dl">"</span><span class="p">]</span>
<span class="mi">4</span><span class="p">:(</span><span class="mi">8</span><span class="p">)</span> <span class="p">[</span><span class="dl">"</span><span class="s2">ALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléALIS2</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse2</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endALIS</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">YES</span><span class="dl">"</span><span class="p">]</span>
<span class="mi">5</span><span class="p">:(</span><span class="mi">8</span><span class="p">)</span> <span class="p">[</span><span class="dl">"</span><span class="s2">EVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">YES</span><span class="dl">"</span><span class="p">]</span>
<span class="mi">6</span><span class="p">:(</span><span class="mi">8</span><span class="p">)</span> <span class="p">[</span><span class="dl">"</span><span class="s2">EVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléEVOLAN2</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">YES</span><span class="dl">"</span><span class="p">]</span>
<span class="mi">7</span><span class="p">:(</span><span class="mi">8</span><span class="p">)</span> <span class="p">[</span><span class="dl">"</span><span class="s2">EVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléEVOLAN3</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endEVOLAN</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">YES</span><span class="dl">"</span><span class="p">]</span>
<span class="mi">8</span><span class="p">:(</span><span class="mi">8</span><span class="p">)</span> <span class="p">[</span><span class="dl">"</span><span class="s2">IAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse2</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">NO</span><span class="dl">"</span><span class="p">]</span>
<span class="mi">9</span><span class="p">:(</span><span class="mi">8</span><span class="p">)</span> <span class="p">[</span><span class="dl">"</span><span class="s2">IAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">YES</span><span class="dl">"</span><span class="p">]</span>
<span class="mi">10</span><span class="p">:(</span><span class="mi">8</span><span class="p">)</span> <span class="p">[</span><span class="dl">"</span><span class="s2">IAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléIAM1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">YES</span><span class="dl">"</span><span class="p">]</span>
<span class="mi">11</span><span class="p">:(</span><span class="mi">8</span><span class="p">)</span> <span class="p">[</span><span class="dl">"</span><span class="s2">IAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléIAM2</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">NO</span><span class="dl">"</span><span class="p">]</span>
<span class="mi">12</span><span class="p">:(</span><span class="mi">8</span><span class="p">)</span> <span class="p">[</span><span class="dl">"</span><span class="s2">IAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléIAM3</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endIAM</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">NO</span><span class="dl">"</span><span class="p">]</span>
<span class="mi">13</span><span class="p">:(</span><span class="mi">8</span><span class="p">)</span> <span class="p">[</span><span class="dl">"</span><span class="s2">OUI</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">libéléOUI</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">applOUI</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">jobOUI</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">domOUI</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">caisse1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">endOUI</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">YES</span><span class="dl">"</span><span class="p">]</span>
</code></pre></div></div>

      (voir plus)
      <a class="post-link" href="/archives/javascript-fonction-unique-distinct/">Javascript fonction unique (distinct) sur un tableau d'objet</a>
      <p class="post-meta">
        <time class="post-meta" itemprop="datePublished dateModified" datetime="2016-10-25T22:10:04+00:00">25-10-2016</time>
      </p>
    </article>
  </div>
</div>




















<ul class="post-list">
  
  
  
  
  <li>
    <div class="card">
      <h4><a class="post-link" href="/archives/vthttpd-dump-requete-sql/">vthttpd -dump et requêtes SQL - tlist ameliore - vtexport.xml to csv</a></h4>
      <p></p>
<p>&lt;Article mis à jour&gt; J’ai rajouté pas mal de petites astuces sur cet article qui date de l’année dernière (filtre XSL - merci Joey pour l’inspiration !, parsing java, utilisation de Panda Python)</p>

<p>Une autre astuce avec le Webaccess VTOM vthttpd : on peut dump tout le contenu de la base VTOM en un fichier exploitable par SQLITE !</p>

<p>L’utilisation principale est de lister tous les jobs, à la manière d’un <code class="language-plaintext highlighter-rouge">tlist</code>mais avec beaucoup plus d’informations (dont les paramètres et le script)</p>

<p>Voici un petit exemple :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vthttpd -dump /var/tmp/vthttpd.dat
sqlite3 /var/tmp/vthttpd.dat
&gt;
.tables  -- liste toutes les tables
pragma table_info(JOBS) ; -- liste les champs de la table JOBS
.schema JOBS ; -- idem mais avec le type de la colonne (varchar(35) par ex.)
</code></pre></div></div>

<p>On peut exécuter un script .sql :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sqlite3 /var/tmp/vthttpd.dat &lt; /var/tmp/monfichier.sql
</code></pre></div></div>

<p>Et on grep sur ce qu’on souhaite</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">j</span><span class="p">.</span><span class="n">JOB_SID</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">j</span><span class="p">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">j</span><span class="p">.</span><span class="k">COMMENT</span><span class="p">,</span> <span class="n">j</span><span class="p">.</span><span class="n">FAMILY</span><span class="p">,</span> <span class="n">j</span><span class="p">.</span><span class="n">SCRIPT</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">q</span><span class="p">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">d</span><span class="p">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">GROUP_CONCAT</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">VALUE</span><span class="p">,</span><span class="s1">'|'</span><span class="p">)</span>
<span class="k">from</span> <span class="n">jobs</span> <span class="n">j</span>
<span class="k">left</span> <span class="k">join</span> <span class="n">applications</span> <span class="n">a</span> <span class="k">on</span> <span class="n">j</span><span class="p">.</span><span class="n">APP_SID</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">APP_SID</span>
<span class="k">left</span> <span class="k">join</span> <span class="n">environments</span> <span class="n">e</span> <span class="k">on</span> <span class="n">a</span><span class="p">.</span><span class="n">ENV_SID</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">ENV_SID</span>
<span class="k">left</span> <span class="k">join</span> <span class="n">hosts</span> <span class="n">h</span> <span class="k">on</span> <span class="n">j</span><span class="p">.</span><span class="n">HOST_SID</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">HOST_SID</span> <span class="k">or</span> <span class="p">(</span><span class="n">ifnull</span><span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">HOST_SID</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">and</span> <span class="p">(</span> <span class="n">a</span><span class="p">.</span><span class="n">HOST_SID</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">HOST_SID</span> <span class="k">or</span> <span class="p">(</span><span class="n">ifnull</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">HOST_SID</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">and</span> <span class="n">e</span><span class="p">.</span><span class="n">HOST_SID</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">HOST_SID</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
<span class="k">left</span> <span class="k">join</span> <span class="n">users</span> <span class="n">u</span> <span class="k">on</span> <span class="n">j</span><span class="p">.</span><span class="n">USER_SID</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">USER_SID</span> <span class="k">or</span> <span class="p">(</span><span class="n">ifnull</span><span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">USER_SID</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">and</span> <span class="p">(</span> <span class="n">a</span><span class="p">.</span><span class="n">USER_SID</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">USER_SID</span> <span class="k">or</span> <span class="p">(</span><span class="n">ifnull</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">USER_SID</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">and</span> <span class="n">e</span><span class="p">.</span><span class="n">USER_SID</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">USER_SID</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
<span class="k">left</span> <span class="k">join</span> <span class="n">queues</span> <span class="n">q</span> <span class="k">on</span> <span class="n">j</span><span class="p">.</span><span class="n">QUEUE_SID</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">QUEUE_SID</span> <span class="k">or</span> <span class="p">(</span><span class="n">ifnull</span><span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">QUEUE_SID</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">and</span> <span class="p">(</span> <span class="n">a</span><span class="p">.</span><span class="n">QUEUE_SID</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">QUEUE_SID</span> <span class="k">or</span> <span class="p">(</span><span class="n">ifnull</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">QUEUE_SID</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">and</span> <span class="n">e</span><span class="p">.</span><span class="n">QUEUE_SID</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">QUEUE_SID</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
<span class="k">left</span> <span class="k">join</span> <span class="n">dates</span> <span class="n">d</span> <span class="k">on</span> <span class="n">j</span><span class="p">.</span><span class="n">DATE_SID</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="n">DATE_SID</span> <span class="k">or</span> <span class="p">(</span><span class="n">ifnull</span><span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">DATE_SID</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">and</span> <span class="p">(</span> <span class="n">a</span><span class="p">.</span><span class="n">DATE_SID</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="n">DATE_SID</span> <span class="k">or</span> <span class="p">(</span><span class="n">ifnull</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">DATE_SID</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">and</span> <span class="n">e</span><span class="p">.</span><span class="n">DATE_SID</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="n">DATE_SID</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
<span class="k">left</span> <span class="k">join</span> <span class="n">job_parameters</span> <span class="n">p</span> <span class="k">on</span> <span class="n">j</span><span class="p">.</span><span class="n">JOB_SID</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">JOB_SID</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">j</span><span class="p">.</span><span class="n">JOB_SID</span>
<span class="p">;</span>
</code></pre></div></div>

<p>ex.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@acf59c2005cf:/mnt/workspace/temp# sqlite3 vthttpd.dat &lt; all_jobs.sql
JOBac1100030a411a8d570cf93000000004|exploitation|appli_test|job2|||jobok.bat|client_local|vtom|queue_ksh|date_exp|
JOBac1100033f6aedb3570cf93000000002|exploitation|appli_test|job1|||jobok.bat|client_local|vtom|queue_ksh|date_exp|param1|param2|param3
JOBac1100036f024b9d570cf93000000006|exploitation|appli_test|job3|||jobok.bat|client_local|vtom|queue_ksh|date_exp|
</code></pre></div></div>

<p>(exemple en Java, P.I je ne suis pas expert en Java - je suis tombé sur des machines qui n’avaient pas sqlite3 … Ca ne suit surement pas les bonnes pratiques JAva mais ça fonctionne)</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">top100_vthttpd_jobs_to_csv</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.sql.Connection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.DriverManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.ResultSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.Statement</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Top100Main</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Connection</span> <span class="n">c</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="nc">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="nc">String</span> <span class="n">sepCSV</span> <span class="o">=</span> <span class="s">","</span> <span class="o">;</span>
		
		<span class="k">try</span> <span class="o">{</span>
			<span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"org.sqlite.JDBC"</span><span class="o">);</span>
			<span class="n">c</span> <span class="o">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="s">"jdbc:sqlite:D:\\workspace\\java\\top100_vthttpd_jobs_to_csv\\vthttpd.dat"</span><span class="o">);</span>
			<span class="n">c</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
			<span class="n">stmt</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
			
			<span class="nc">String</span> <span class="n">allJobs</span> <span class="o">=</span> <span class="s">"select j.JOB_SID, e.NAME, a.NAME, j.NAME, j.COMMENT, j.FAMILY, j.SCRIPT, h.NAME, u.NAME, q.NAME, d.NAME, GROUP_CONCAT(p.VALUE,'|')"</span>
					<span class="o">+</span> <span class="s">" from jobs j"</span>
					<span class="o">+</span> <span class="s">" left join applications a on j.APP_SID = a.APP_SID"</span>
					<span class="o">+</span> <span class="s">" left join environments e on a.ENV_SID = e.ENV_SID"</span>
					<span class="o">+</span> <span class="s">" left join hosts h on j.HOST_SID = h.HOST_SID or (ifnull(j.HOST_SID,'') = '' and ( a.HOST_SID = h.HOST_SID or (ifnull(a.HOST_SID,'') = '' and e.HOST_SID = h.HOST_SID) ) )"</span>
					<span class="o">+</span> <span class="s">" left join users u on j.USER_SID = u.USER_SID or (ifnull(j.USER_SID,'') = '' and ( a.USER_SID = u.USER_SID or (ifnull(a.USER_SID,'') = '' and e.USER_SID = u.USER_SID) ) )"</span>
					<span class="o">+</span> <span class="s">" left join queues q on j.QUEUE_SID = q.QUEUE_SID or (ifnull(j.QUEUE_SID,'') = '' and ( a.QUEUE_SID = q.QUEUE_SID or (ifnull(a.QUEUE_SID,'') = '' and e.QUEUE_SID = q.QUEUE_SID) ) )"</span>
					<span class="o">+</span> <span class="s">" left join dates d on j.DATE_SID = d.DATE_SID or (ifnull(j.DATE_SID,'') = '' and ( a.DATE_SID = d.DATE_SID or (ifnull(a.DATE_SID,'') = '' and e.DATE_SID = d.DATE_SID) ) )"</span>
					<span class="o">+</span> <span class="s">" left join job_parameters p on j.JOB_SID = p.JOB_SID"</span>
					<span class="o">+</span> <span class="s">" group by j.JOB_SID"</span>
				<span class="c1">//	+ " limit 10"</span>
					<span class="o">+</span> <span class="s">" ;"</span>
			<span class="o">;</span>

			<span class="nc">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span> <span class="n">allJobs</span> <span class="o">);</span>
			
			
			<span class="k">while</span> <span class="o">(</span> <span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">()</span> <span class="o">)</span> <span class="o">{</span>
			   <span class="nc">String</span> <span class="n">jSID</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
			   <span class="nc">String</span> <span class="n">eName</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
			   <span class="nc">String</span> <span class="n">aName</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
			   <span class="nc">String</span> <span class="n">jName</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
			   <span class="nc">String</span> <span class="n">jComment</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
			   <span class="nc">String</span> <span class="n">jFamily</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">6</span><span class="o">);</span>
			   <span class="nc">String</span> <span class="n">jScript</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">7</span><span class="o">);</span>
			   <span class="nc">String</span> <span class="n">hName</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">8</span><span class="o">);</span>
			   <span class="nc">String</span> <span class="n">uName</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">9</span><span class="o">);</span>
			   <span class="nc">String</span> <span class="n">qName</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
			   <span class="nc">String</span> <span class="n">dName</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">11</span><span class="o">);</span>
			   <span class="nc">String</span> <span class="n">pValue</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">12</span><span class="o">);</span>
			   <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span> 
					   <span class="c1">//jSID + sepCSV + </span>
					   <span class="n">eName</span> <span class="o">+</span> <span class="n">sepCSV</span> <span class="o">+</span> <span class="n">aName</span> <span class="o">+</span> <span class="n">sepCSV</span> <span class="o">+</span> <span class="n">jName</span> <span class="o">+</span> <span class="n">sepCSV</span> <span class="o">+</span> <span class="n">jComment</span> <span class="o">+</span> <span class="n">sepCSV</span> <span class="o">+</span>
					   <span class="n">jFamily</span> <span class="o">+</span> <span class="n">sepCSV</span> <span class="o">+</span> <span class="n">jScript</span> <span class="o">+</span> <span class="n">sepCSV</span> <span class="o">+</span><span class="n">hName</span> <span class="o">+</span> <span class="n">sepCSV</span> <span class="o">+</span> <span class="n">uName</span> <span class="o">+</span> <span class="n">sepCSV</span> <span class="o">+</span>
					   <span class="n">qName</span> <span class="o">+</span> <span class="n">sepCSV</span> <span class="o">+</span> <span class="n">dName</span> <span class="o">+</span> <span class="n">sepCSV</span> <span class="o">+</span> <span class="n">pValue</span>
					<span class="o">);</span>
			   <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
			<span class="o">}</span>
		
			<span class="n">rs</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
			<span class="n">stmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
			<span class="n">c</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
			
		<span class="o">}</span><span class="k">catch</span> <span class="o">(</span> <span class="nc">Exception</span> <span class="n">e</span> <span class="o">)</span> <span class="o">{</span>
		  <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">e</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">()</span> <span class="o">);</span>
		  <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
		<span class="o">}</span>

	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="filtrer-directement-un-fichier-xml-avec-un-fichier-xsl-et-sortie-en-texte-pour-du-csv">Filtrer directement un fichier XML avec un fichier XSL et sortie en texte (pour du csv)</h3>

<p>J’avais déjà utilisé ce langage de transformation XSL mais il m’était complétement sorti de la tête. Merci à JOEY de m’avoir inspriré ! :)</p>

<p>Fichier XSL de transformation (à adapter selon vos besoin)</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;xsl:stylesheet</span> <span class="na">version=</span><span class="s">"2.0"</span> <span class="na">xmlns:xsl=</span><span class="s">"http://www.w3.org/1999/XSL/Transform"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;xsl:output</span> <span class="na">method=</span><span class="s">"text"</span> <span class="na">encoding=</span><span class="s">"utf-8"</span> <span class="nt">/&gt;</span>
  
  <span class="c">&lt;!-- j'utilise cette sortie pour constituer mon fichier CSV utilisé en tant que data pour load dans Oracle une table avec SQLLDR et un fichier de controle .ctl --&gt;</span>
  <span class="c">&lt;!--
  sqlldr do not set OPTIONALLY ENCLOSED BY '"' because this char appears in comments and params 

        LOAD DATA APPEND
        INTO TABLE nom_dela_table_oracle
        FIELDS TERMINATED BY "£"
        
        (
          "VTENVNAME"                     CHAR,
          "VTAPPLNAME"                    CHAR,
          "VTJOBNAME"                     CHAR,
          "APPMODE"                     CHAR,
          "JOBMODE"                     CHAR, 
          etc...
        )
  --&gt;</span>
  
  <span class="nt">&lt;xsl:param</span> <span class="na">name=</span><span class="s">"delimCSV"</span> <span class="na">select=</span><span class="s">"'£'"</span> <span class="nt">/&gt;</span><span class="c">&lt;!-- j'utilise ce char car il n'est pas utilisé dans mon référentiel VTOM --&gt;</span>
  <span class="nt">&lt;xsl:param</span> <span class="na">name=</span><span class="s">"delimParam"</span> <span class="na">select=</span><span class="s">"'§'"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;xsl:param</span> <span class="na">name=</span><span class="s">"break"</span> <span class="na">select=</span><span class="s">"'&amp;#xA;'"</span> <span class="nt">/&gt;</span>
  <span class="c">&lt;!--
  &lt;xsl:value-of select="$delimCSV" /&gt;
   --&gt;</span>

  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">"/"</span><span class="nt">&gt;</span>
	  <span class="nt">&lt;xsl:apply-templates</span> <span class="na">select=</span><span class="s">"Domain/Environments/Environment/Applications/Application/Jobs/Job"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/xsl:template&gt;</span>

  <span class="c">&lt;!-- All Job node for root node --&gt;</span>
  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">"Domain/Environments/Environment/Applications/Application/Jobs/Job"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"../../../../@name"</span> <span class="nt">/&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$delimCSV"</span> <span class="nt">/&gt;</span>              <span class="c">&lt;!-- EnvironmentName --&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"../../@name"</span> <span class="nt">/&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$delimCSV"</span> <span class="nt">/&gt;</span>                    <span class="c">&lt;!-- ApplicationName --&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"@name"</span> <span class="nt">/&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$delimCSV"</span> <span class="nt">/&gt;</span>                          <span class="c">&lt;!-- JobName --&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"../../@mode"</span> <span class="nt">/&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$delimCSV"</span> <span class="nt">/&gt;</span>                    <span class="c">&lt;!-- ApplicationMode --&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"@mode"</span> <span class="nt">/&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$delimCSV"</span> <span class="nt">/&gt;</span>                          <span class="c">&lt;!-- JobMode --&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"../../@onDemand"</span> <span class="nt">/&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$delimCSV"</span> <span class="nt">/&gt;</span>                <span class="c">&lt;!-- ApplicationOnDemand --&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"@onDemand"</span> <span class="nt">/&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$delimCSV"</span> <span class="nt">/&gt;</span>                      <span class="c">&lt;!-- JobOnDemand --&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"Script/text()"</span> <span class="nt">/&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$delimCSV"</span> <span class="nt">/&gt;</span>                  <span class="c">&lt;!-- Script --&gt;</span>
    <span class="nt">&lt;xsl:apply-templates</span> <span class="na">select=</span><span class="s">"Parameters/Parameter"</span> <span class="nt">/&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$delimCSV"</span> <span class="nt">/&gt;</span>    <span class="c">&lt;!-- Parameters --&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"../../../../../../@name"</span> <span class="nt">/&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$delimCSV"</span> <span class="nt">/&gt;</span>        <span class="c">&lt;!-- DomainName --&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$break"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/xsl:template&gt;</span>

  <span class="c">&lt;!-- All Parameter node for Job node --&gt;</span>
  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">"Parameters/Parameter"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"text()"</span> <span class="nt">/&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$delimParam"</span> <span class="nt">/&gt;</span>                       <span class="c">&lt;!-- Parameter --&gt;</span>
  <span class="nt">&lt;/xsl:template&gt;</span>  

<span class="nt">&lt;/xsl:stylesheet&gt;</span>
</code></pre></div></div>

<p>Pour appliquer le fichier XSL au fichier XML vtexport VTOM, on peut faire ça assez simplement avec une class Java (Stylizer) fournie par Oracle.</p>

<p>Si vous voulez plus d’information sur la classe et la télécharger, voici le lien Oracle <a href="https://docs.oracle.com/javase/tutorial/jaxp/xslt/transformingXML.html">Transforming XML Data with XSLT</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Compiler le code source java pour créer votre class Stylizer.class, A ne faire qu'une fois. La classe doit se trouver dans votre CLASSPATH (variable d'environnement)</span>
javac Stylizer.java

<span class="c"># Lancer la commande pour transformer votre XML avec le fichier XSL</span>
java Stylizer votrefichier.xsl vtorefichier.xml
</code></pre></div></div>

<h3 id="parser-le-vtexport-xml-vtom-en-pur-java-un-peu-long">Parser le vtexport XML VTOM en “pur” Java (un peu long)</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">vtexport_xml_to_csv</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileWriter</span> <span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.xml.parsers.DocumentBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.parsers.DocumentBuilderFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.parsers.ParserConfigurationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.xpath.XPath</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.xpath.XPathFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.xpath.XPathConstants</span> <span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.xpath.XPathExpressionException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.w3c.dom.Document</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.w3c.dom.NodeList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.w3c.dom.Node</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xml.sax.SAXException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">VtexportXML</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="nc">String</span> <span class="n">xmlPath</span> <span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="nc">Document</span> <span class="n">document</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">separateurCSV</span> <span class="o">=</span> <span class="s">"£"</span> <span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">separateurEscape</span> <span class="o">=</span> <span class="s">"§"</span> <span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="nc">String</span> <span class="n">domainName</span><span class="o">;</span>
	
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ParserConfigurationException</span><span class="o">,</span> <span class="nc">SAXException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">XPathExpressionException</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">setXmlPath</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
		<span class="o">}</span><span class="k">else</span><span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Usage : 1 paramètre nécessaire"</span><span class="o">);</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"1 : chemin complet du fichier xml"</span><span class="o">);</span>
	        <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
		<span class="o">}</span>

        <span class="kd">final</span> <span class="nc">DocumentBuilderFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="nc">DocumentBuilderFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>    	
        <span class="kd">final</span> <span class="nc">DocumentBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">newDocumentBuilder</span><span class="o">();</span>
	    <span class="n">setDocument</span><span class="o">(</span> <span class="n">builder</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span> <span class="n">getXmlPath</span><span class="o">()</span> <span class="o">)</span> <span class="o">)</span> <span class="o">);</span>
    	<span class="n">listAllJobs</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">getXmlPath</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">xmlPath</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setXmlPath</span><span class="o">(</span><span class="nc">String</span> <span class="n">xmlPath</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">VtexportXML</span><span class="o">.</span><span class="na">xmlPath</span> <span class="o">=</span> <span class="n">xmlPath</span><span class="o">;</span>
	<span class="o">}</span>
	
	<span class="kd">public</span> <span class="kd">static</span> <span class="nc">Document</span> <span class="nf">getDocument</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">document</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setDocument</span><span class="o">(</span><span class="nc">Document</span> <span class="n">document</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">VtexportXML</span><span class="o">.</span><span class="na">document</span> <span class="o">=</span> <span class="n">document</span><span class="o">;</span>
	<span class="o">}</span>
	
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">listAllJobs</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">XPathExpressionException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">{</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">())</span> <span class="o">;</span>
		
		<span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">getXmlPath</span><span class="o">()</span> <span class="o">+</span> <span class="s">".txt"</span><span class="o">);</span>
		<span class="c1">// creates the file</span>
		<span class="n">file</span><span class="o">.</span><span class="na">createNewFile</span><span class="o">();</span>
		<span class="c1">// creates a FileWriter Object</span>
		<span class="nc">FileWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileWriter</span><span class="o">(</span><span class="n">file</span><span class="o">);</span> 
		
		<span class="c1">// xPath instance</span>
		<span class="nc">XPath</span> <span class="n">xPath</span> <span class="o">=</span>  <span class="nc">XPathFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">().</span><span class="na">newXPath</span><span class="o">();</span>
		<span class="c1">// set DomainName </span>
		<span class="n">setDomainName</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">xPath</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">"/Domain/@name"</span><span class="o">).</span><span class="na">evaluate</span><span class="o">(</span> <span class="n">getDocument</span><span class="o">()</span> <span class="o">)</span> <span class="o">);</span>
		
		<span class="c1">// get all nodelist job</span>
		<span class="nc">NodeList</span> <span class="n">nodeList</span> <span class="o">=</span> <span class="o">(</span><span class="nc">NodeList</span><span class="o">)</span> <span class="n">xPath</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">"/Domain/Environments/Environment/Applications/Application/Jobs/Job"</span><span class="o">).</span><span class="na">evaluate</span><span class="o">(</span><span class="n">getDocument</span><span class="o">(),</span><span class="nc">XPathConstants</span><span class="o">.</span><span class="na">NODESET</span><span class="o">);</span>	
		
		<span class="kt">int</span> <span class="n">percentDone</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">;</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"0%."</span><span class="o">);</span>
		
		<span class="c1">// loop over nodelist job</span>
		<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nodeList</span><span class="o">.</span><span class="na">getLength</span><span class="o">()</span> <span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
			
			<span class="c1">// print evolution running script %</span>
			<span class="k">if</span><span class="o">(!</span> <span class="o">(</span> <span class="o">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">nodeList</span><span class="o">.</span><span class="na">getLength</span><span class="o">())</span> <span class="o">&lt;</span> <span class="n">percentDone</span> <span class="o">)</span> <span class="o">){</span>
				<span class="n">percentDone</span><span class="o">++</span> <span class="o">;</span>
				<span class="k">if</span><span class="o">(</span><span class="n">percentDone</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
					<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">percentDone</span> <span class="o">+</span> <span class="s">"%"</span><span class="o">);</span>
				<span class="o">}</span><span class="k">else</span><span class="o">{</span>
					<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"."</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			
			<span class="c1">// job node</span>
			<span class="nc">Node</span> <span class="n">jobNode</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Node</span><span class="o">)</span> <span class="n">nodeList</span><span class="o">.</span><span class="na">item</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">;</span>
			
			<span class="c1">// nodelist parameters</span>
			<span class="nc">NodeList</span> <span class="n">parametersNodes</span> <span class="o">=</span> <span class="o">(</span><span class="nc">NodeList</span><span class="o">)</span> <span class="n">xPath</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="s">"Parameters/Parameter"</span><span class="o">,</span><span class="n">jobNode</span><span class="o">,</span><span class="nc">XPathConstants</span><span class="o">.</span><span class="na">NODESET</span><span class="o">)</span> <span class="o">;</span>
			<span class="nc">String</span><span class="o">[]</span> <span class="n">parameters</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span> <span class="o">[</span> <span class="n">parametersNodes</span><span class="o">.</span><span class="na">getLength</span><span class="o">()</span> <span class="o">]</span> <span class="o">;</span>
			
			<span class="c1">// all parameters as an Array</span>
			<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">parametersNodes</span><span class="o">.</span><span class="na">getLength</span><span class="o">()</span> <span class="o">;</span> <span class="n">j</span><span class="o">++){</span>
				<span class="n">parameters</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="o">((</span><span class="nc">Node</span><span class="o">)</span> <span class="n">parametersNodes</span><span class="o">.</span><span class="na">item</span><span class="o">(</span><span class="n">j</span><span class="o">)).</span><span class="na">getTextContent</span><span class="o">()</span> <span class="o">;</span>
			<span class="o">}</span>
			
			<span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span>
				
				<span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">xPath</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="s">"../../../../@name"</span><span class="o">,</span> <span class="n">jobNode</span><span class="o">)</span> <span class="o">+</span> <span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">separateurCSV</span> <span class="o">+</span>	<span class="c1">// envName</span>
				<span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">xPath</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="s">"../../@name"</span><span class="o">,</span> <span class="n">jobNode</span><span class="o">)</span> <span class="o">+</span> <span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">separateurCSV</span> <span class="o">+</span>			<span class="c1">// appName</span>
				<span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">xPath</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="s">"@name"</span><span class="o">,</span> <span class="n">jobNode</span><span class="o">)</span> <span class="o">+</span> <span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">separateurCSV</span> <span class="o">+</span>				<span class="c1">// jobName</span>
				<span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">xPath</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="s">"../../@mode"</span><span class="o">,</span> <span class="n">jobNode</span><span class="o">)</span> <span class="o">+</span> <span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">separateurCSV</span> <span class="o">+</span>			<span class="c1">// AppMode</span>
				<span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">xPath</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="s">"@mode"</span><span class="o">,</span> <span class="n">jobNode</span><span class="o">)</span> <span class="o">+</span> <span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">separateurCSV</span> <span class="o">+</span>				<span class="c1">// JobMode</span>
				<span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">xPath</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="s">"../../@onDemand"</span><span class="o">,</span> <span class="n">jobNode</span><span class="o">)</span> <span class="o">+</span> <span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">separateurCSV</span> <span class="o">+</span>		<span class="c1">// AppOnDemand</span>
				<span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">xPath</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="s">"@onDemand"</span><span class="o">,</span> <span class="n">jobNode</span><span class="o">)</span> <span class="o">+</span> <span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">separateurCSV</span> <span class="o">+</span>			<span class="c1">// JobOnDemand</span>
				<span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">xPath</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="s">"Script"</span><span class="o">,</span><span class="n">jobNode</span><span class="o">)</span> <span class="o">+</span> <span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">separateurCSV</span> <span class="o">+</span>				<span class="c1">// Script</span>
				<span class="n">separateurEscape</span> <span class="o">+</span> <span class="nc">String</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"|"</span><span class="o">,</span> <span class="n">parameters</span><span class="o">)</span> <span class="o">+</span> <span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">separateurCSV</span> <span class="o">+</span> 					<span class="c1">// Parameters</span>
				<span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">getDomainName</span><span class="o">()</span> <span class="o">+</span> <span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">separateurCSV</span>									<span class="c1">// DomainName</span>
				<span class="o">+</span> <span class="s">"\n"</span>
			<span class="o">);</span>
			
		<span class="o">}</span>

		<span class="c1">// Flush the content to the file</span>
		<span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
		<span class="n">writer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		
		<span class="c1">// print prompt running script</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Fichier en sortie : "</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">());</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">()</span> <span class="o">+</span> <span class="s">" The end"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">getDomainName</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">domainName</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setDomainName</span><span class="o">(</span><span class="nc">String</span> <span class="n">domainName</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">VtexportXML</span><span class="o">.</span><span class="na">domainName</span> <span class="o">=</span> <span class="n">domainName</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h3 id="autre-pour-moi">Autre pour moi</h3>

<p>Reminder pour moi : consolidation des statistiques VTOM (en attendant que tout soit dans la base postgres, je passe par le vthttpd dump)</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">plateforme</span><span class="o">=</span>up2
<span class="nv">vthttpdDat</span><span class="o">=</span>vthttpd_<span class="k">${</span><span class="nv">plateforme</span><span class="k">}</span>.dat
<span class="nv">allJobsSQL</span><span class="o">=</span>all_jobs.sql
<span class="nv">allJobs1to1</span><span class="o">=</span>all_jobsSID_1to1Param_<span class="k">${</span><span class="nv">plateforme</span><span class="k">}</span>.txt
<span class="nv">allJobsManyTo1</span><span class="o">=</span>all_jobsSID_manyTo1Param_<span class="k">${</span><span class="nv">plateforme</span><span class="k">}</span>.txt
<span class="nv">outputStats</span><span class="o">=</span>stats_<span class="k">${</span><span class="nv">plateforme</span><span class="k">}</span>
<span class="nv">vtsgbdPort</span><span class="o">=</span>30509
<span class="nv">hostFilter</span><span class="o">=</span>HOST1

<span class="nb">test</span> <span class="nt">-f</span> <span class="nv">$vthttpdDat</span> <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nv">$vthttpdDat</span>
vthttpd <span class="nt">-dump</span> <span class="nv">$vthttpdDat</span>
sqlite3 <span class="nv">$vthttpdDat</span> &lt; <span class="nv">$allJobsSQL</span> |  <span class="nb">awk</span> <span class="s1">'BEGIN{ FS="|" ; OFS="|" } { l=length($10) ; if(l == 2) { $10="0"$10 ;} ;  if(l == 1){ $10="00"$10 }  ; print}'</span> | <span class="nb">sort</span> <span class="nt">-g</span>  <span class="o">&gt;</span>  <span class="nv">$allJobs1to1</span>

<span class="c">### All jobs manyto1 parameters</span>
<span class="nb">awk</span> <span class="nt">-F</span> <span class="s2">"|"</span> <span class="s1">'BEGIN{ job_sid=null;} {if($1 == job_sid){ printf "|%s",$11 }else{ if(job_sid != null){ printf "\n" } ; printf "%s|%s|%s|%s|%s|%s|%s|%s|%s|%s",$1,$2,$3,$4,$5,$6,$7,$8,$9,$11 } ; job_sid=$1 ;}'</span> <span class="nv">$allJobs1to1</span> | <span class="nb">sort</span> <span class="o">&gt;</span> <span class="nv">$allJobsManyTo1</span>

<span class="c"># get stats with filters (modify where clauses)   </span>
<span class="c"># select vtobjectsid,vtenvname, vtapplname, vtjobname, vtbegin, (vtend::timestamp - vtbegin::timestamp), vtend, vtexpdatevalue, vthostname, vtusername, vtbqueuename, vtdatename,vtstatus, vterrmess  </span>
~/sgbd/bin/psql <span class="nt">-d</span> vtom <span class="nt">-p</span> <span class="nv">$vtsgbdPort</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
</span><span class="se">\p</span><span class="sh">set tuples_only
</span><span class="se">\p</span><span class="sh">set footer off
</span><span class="se">\a</span><span class="sh">
</span><span class="se">\o</span><span class="sh"> </span><span class="nv">$outputStats</span><span class="sh">
select vtobjectsid,vtbegin,(vtend::timestamp - vtbegin::timestamp),vtend,vtexpdatevalue,vtstatus,vterrmess
from vt_stats_job 
where vthostname = '</span><span class="nv">$hostFilter</span><span class="sh">' 
and (vtend::timestamp - vtbegin::timestamp) &gt;= '00:10:00'
order by (vtend::timestamp - vtbegin::timestamp) 
;
</span><span class="no">EOF
</span></code></pre></div></div>

<p>Très long avec Awk (beaucoup d’itération :x)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk -v fic=$allJobsManyTo1 'BEGIN{
    OFS="|";FS="|";
    i=0 ;
    while ((getline line &lt; fic ) &gt; 0){
        tAllJobsManyTo1[i]=line ;
        i++ ;
    }
    close (fic) ;
    
}{
    if($1 ~ /^APP/){
      print $0;
      next
    }
    jobSID=$1 ;
    lineStats=$0 ;
    
    for (i in tAllJobsManyTo1){
        split(tAllJobsManyTo1[i],tLine,"|");
   
        if( tLine[1] == jobSID ){
          script=tLine[5] ;
          printf "%s|%s\n",lineStats,script ;
          delete  tAllJobsManyTo1[i] ;
          break; 
        }
    }
    
}' /var/tmp/stats
</code></pre></div></div>

<p>Beaucoup plus rapide avec Pandas - Python :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pandas</span>

<span class="n">my_cols_csv1</span> <span class="o">=</span> <span class="p">[</span> <span class="sh">"</span><span class="s">vtobjectsid</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">vtbegin</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">vtduration</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">vtend</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">vtexpdatevalue</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">vtstatus</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">vterrmess</span><span class="sh">"</span> <span class="p">]</span>
<span class="n">csv1</span> <span class="o">=</span> <span class="n">pandas</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">stats_up2</span><span class="sh">'</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="sa">r</span><span class="sh">"</span><span class="s">|</span><span class="sh">"</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">my_cols_csv1</span><span class="p">)</span>
<span class="n">my_cols</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">vtobjectsid</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">env</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">app</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">job</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">script</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">host</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">vtdatename</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">param</span><span class="sh">"</span><span class="p">]</span>
<span class="n">my_cols</span><span class="o">=</span><span class="n">my_cols</span> <span class="o">+</span> <span class="nf">range</span><span class="p">(</span><span class="mi">150</span><span class="p">)</span>
<span class="n">csv2</span> <span class="o">=</span> <span class="n">pandas</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">all_jobsSID_manyTo1Param_up2.txt</span><span class="sh">'</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">my_cols</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sh">"</span><span class="s">|</span><span class="sh">"</span><span class="p">)</span>
<span class="n">merge</span> <span class="o">=</span> <span class="n">pandas</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">csv1</span><span class="p">,</span><span class="n">csv2</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="sh">'</span><span class="s">vtobjectsid</span><span class="sh">'</span><span class="p">)</span>
<span class="n">merge</span><span class="p">.</span><span class="nf">to_csv</span><span class="p">(</span><span class="sh">"</span><span class="s">output.csv</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	vtobjectsid	vtbegin	vtduration	vtend	vtexpdatevalue	vtstatus	vterrmess	env	app	job	script	host	user	queue	vtdatename	param
0	JOB7ef5b39400006ad956a6113e00014e22	19/03/2016 03:58	00:10:00	19/03/2016 04:08	19/03/2016	3	Termine a 04:08:30	ENV1	poz12daj1	p800ostp1	PATH_DWH_SHELL/OSEF_odi.ksh	HOST1	prdwh12	queue_ksh	ENV1J_12_rdwh	
1	JOB7ef5b39400006ad956a6113e00014e22	03/03/2016 03:29	00:12:24	03/03/2016 03:42	03/03/2016	3	Termine a 03:42:17	ENV1	poz12daj1	p800ostp1	PATH_DWH_SHELL/OSEF_odi.ksh	HOST1	prdwh12	queue_ksh	ENV1_12_rdwh	
</code></pre></div></div>

      
    </div>

  </li>
  
  
  
  <li>
    <div class="card">
      <h4><a class="post-link" href="/archives/ressource-pile/">Ressource pile</a></h4>
      <p></p>
<h1 id="lister-le-contenu-de-la-ressource-pile-vtom">Lister le contenu de la ressource pile VTOM</h1>

<p><code class="language-plaintext highlighter-rouge">tpush -name &lt;nom ressource pile&gt; -info</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>valeur         : 1
contenu:
1
2
3
</code></pre></div></div>

<p>Le problème, c’est qu’on a des informations qu’on ne souhaite pas forcément. Pas très pratique pour faire une boucle for par exemple.</p>

<p>On filtre avec <code class="language-plaintext highlighter-rouge">awk</code> tous les élements de la ressource pile VTOM qui sont après le mot <code class="language-plaintext highlighter-rouge">contenu</code> et où la ligne n’est pas vide (dernière ligne vide dans le résultat de mon <code class="language-plaintext highlighter-rouge">tpush</code>)</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tpush</span><span class="w"> </span><span class="nt">-name</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">nom</span><span class="w"> </span><span class="nx">ressource</span><span class="w"> </span><span class="nx">pile</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-info</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-skip</span><span class="w"> </span><span class="nx">3</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">select-string</span><span class="w"> </span><span class="o">-NotMatch</span><span class="w"> </span><span class="s2">"^$"</span><span class="w">
</span></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tpush <span class="nt">-name</span> &lt;nom ressource pile&gt; <span class="nt">-info</span> | <span class="nb">awk</span> <span class="s1">'\
BEGIN{ligneContenu="x";nbValues=0;}\
($1 ~ /contenu/ || NR &gt; ligneContenu) &amp;&amp; $0 != ""\
{\
if(ligneContenu == "x"){ ligneContenu = NR ; next } ;\
print $0;\
}'</span>
1
2
3
</code></pre></div></div>

<h1 id="compter-le-nombre-déléments-dans-la-pile">Compter le nombre d’éléments dans la pile</h1>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">tpush</span><span class="w"> </span><span class="nt">-name</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">nom</span><span class="w"> </span><span class="nx">ressource</span><span class="w"> </span><span class="nx">pile</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-info</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-skip</span><span class="w"> </span><span class="nx">3</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">select-string</span><span class="w"> </span><span class="o">-NotMatch</span><span class="w"> </span><span class="s2">"^$"</span><span class="p">)</span><span class="o">.</span><span class="nf">count</span><span class="w">
</span></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tpush <span class="nt">-name</span> &lt;nom ressource pile&gt; <span class="nt">-info</span> | <span class="nb">awk</span> <span class="s1">'\
BEGIN{ligneContenu="x";nbValues=0;}\
($1 ~ /contenu/ || NR &gt; ligneContenu) &amp;&amp; $0 != ""\
{\
if(ligneContenu == "x"){ ligneContenu = NR ; next } ;\
nbValues++;\
}\
END{print nbValues}'</span>
3
</code></pre></div></div>

<h1 id="afficher-le-premier-élément-de-la-ressource-pile-vtom">Afficher le premier élément de la ressource pile VTOM</h1>

<p><code class="language-plaintext highlighter-rouge">tval -name &lt;nom ressource pile&gt;</code></p>

<h1 id="vider-le-premier-élément-de-la-ressource-pile-vtom">Vider le premier élément de la ressource pile VTOM</h1>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tpop -name &lt;nom ressource pile&gt;
OK: &lt;nom ressource pile&gt;

# le premier élément 1 que j'avais dans ma pile a été supprimé
tpush -name &lt;nom ressource pile&gt; -info
valeur         : 2
contenu:
2
3
</code></pre></div></div>

<h1 id="ajouter-un-élément-à-la-fin-de-la-ressource-pile-vtom">Ajouter un élément à la fin de la ressource pile VTOM</h1>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tpush -name &lt;nom ressource pile&gt; -value 1
OK: 1

# la valeur 1 a été rajoutée en fin de pile
tpush -name &lt;nom ressource pile&gt; -info
valeur         : 2
contenu:
2
3
1
</code></pre></div></div>

<h1 id="vider-tous-les-éléments-de-la-ressource-pile-vtom">Vider tous les éléments de la ressource pile VTOM</h1>

<p><code class="language-plaintext highlighter-rouge">tempty -name &lt;nom ressource pile&gt;</code></p>

<h1 id="a-quoi-ça-sert-">A quoi ça sert ?</h1>

<h2 id="dans-vtom">Dans VTOM</h2>

<h3 id="une-ressource-pile-vtom-peut-être-attendue-sur-une-application-ou-un-traitement">Une ressource pile VTOM peut être attendue sur une application ou un traitement</h3>

<ul>
  <li>Présent = au moins un élement dans la pile</li>
  <li>Absent = aucun élément dans la pile</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">mis à jour sur mon v5.7, on dit "Vide" et "Non vide" au lieu de présent/absent (plus logique remarquez)</code></p>

<p>Pratique par exemple pour exécuter une cyclique autant de fois que qu’il y a d’éléments dans une pile.</p>

<p><code class="language-plaintext highlighter-rouge">Sur une remarque de nagnag, je me rends compte que ce que je dis peut prêter à confusion. La pile ne se décharge pas automatiquement à chaque exécution de la cyclique. C'est bien un mécanisme perso par tpop (via un job/script) qui doit dépiler à chaque cycle.</code></p>

<p>Autre exemple plus tordu : on a une pile initialisée avec <code class="language-plaintext highlighter-rouge">n</code> éléments (avec n = nombre de couloirs attendus, ces couloirs sont sur des environnements ou des serveurs VTOM différents par exemple), à chaque fois qu’un couloir (une chaine) est terminé, on dépile d’1 élément la ressource ; une autre chaine attend que les <code class="language-plaintext highlighter-rouge">n</code> couloirs se soient exécutés (la tête de chaine attend la ressource pile à <code class="language-plaintext highlighter-rouge">Absent</code>)</p>

<h3 id="une-ressource-pile-vtom-peut-être-ajoutée-en-tant-que-paramètre-dun-traitement">Une ressource pile VTOM peut être ajoutée en tant que paramètre d’un traitement</h3>

<p>Le traitement peut prendre en paramètre la ressource pile qui aura comme valeur le premier élément de cette dernière <code class="language-plaintext highlighter-rouge">{nomressource}</code>, on peut aussi vouloir le nom de la ressource plutôt que sa valeur <code class="language-plaintext highlighter-rouge">{nomressource,name}</code>.</p>

<h2 id="dans-les-scripts">Dans les scripts</h2>

<p>Et pourquoi pas ?</p>

<p>Exemple : à l’issue d’une sauvegarde, vous empilez le nom de la sauvegarde et son statut (un genre de clé:valeur, <code class="language-plaintext highlighter-rouge">tpush -name &lt;nom de la ressource&gt; -value "masave1:OK"</code>). à l’issue de toutes vos sauvegardes, ou le matin, vous faites un reporting en dépilant tous les élements (<code class="language-plaintext highlighter-rouge">tval</code> pour récupérer la valeur courante, <code class="language-plaintext highlighter-rouge">tpop</code> pour supprimer la valeur courante). Ainsi, par exemple, on peut envoyé par mail un tableau avec le nom de la sauvegarde et OK vert ou KO rouge.</p>

<h1 id="les-axes-daméliorations-que-jaimerais-voir">Les axes d’améliorations que j’aimerais voir</h1>

<p>C’est bien dommage qu’on soit limité à <code class="language-plaintext highlighter-rouge">Présent</code> ou <code class="language-plaintext highlighter-rouge">Absent</code>. J’aimerais voir apparaître le <code class="language-plaintext highlighter-rouge">$#index [&lt;&gt;=!] value</code> et qui conditionnerait le lancement si le nombre total d’éléments ($#index) était égal (ou autre comparateur) à une certaine valeur (value).</p>

<p>Bien dommage aussi qu’on ne puisse pas supprimer l’index souhaité ou ajouter avant/après l’index souhaité, genre de <code class="language-plaintext highlighter-rouge">splice</code> (c’est du FIFO, premier arrivé, premier sorti)</p>

      
    </div>

  </li>
  
  
  
  <li>
    <div class="card">
      <h4><a class="post-link" href="/archives/border-line-VTOM/">Border Line VTOM</a></h4>
      <p></p>
<p>Si vous lisez ces mots, c’est que le côté obscur vous a déjà envahi et que le border line ne vous fait pas peur ! <img class="emoji" title=":smiling_imp:" alt=":smiling_imp:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f608.png" height="20" width="20"></p>

<p>Par conséquent, ce qui va suivre ne vous effraiera point et pourrait même vous intéresser <img class="emoji" title=":scream:" alt=":scream:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f631.png" height="20" width="20"></p>

<p><small>(mais quand même, attention à vos prod, ne jouez que sur vos bacs à sable !)</small></p>

<h2 id="ouvrir-les-dbf-ne-concerne-que-les-versions--v61-vtom">Ouvrir les DBF (ne concerne que les versions &lt; v6.1 VTOM)</h2>

<p>Les .dbf c’est les fichiers de Table qui constituent la base de données VTOM actuelle (bientôt full Postgres SQL, adieu les .dbf) dans votre répertoire TOM_BASES (ou de votre vtbackup)</p>

<ul>
  <li>installer simpledbf et pandas pour Python</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">simpledbf</span> <span class="kn">import</span> <span class="n">Dbf5</span>
<span class="n">dbf</span> <span class="o">=</span> <span class="nc">Dbf5</span><span class="p">(</span><span class="sh">'</span><span class="s">/mnt/workspace/temp/monvtbackup/appl.dbf</span><span class="sh">'</span><span class="p">,</span> <span class="n">codec</span><span class="o">=</span><span class="sh">'</span><span class="s">latin-1</span><span class="sh">'</span><span class="p">)</span>
<span class="n">dbf</span><span class="p">.</span><span class="nf">to_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">/mnt/workspace/temp/appl.csv</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="restaurer-votre-pg_dump_sgbdbackup-en-un-fichier-sql-exploitable">Restaurer votre pg_dump_sgbd.backup en un fichier SQL exploitable</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$TOM_HOME/sgbd/bin/pg_restore /mnt/workspace/temp/monvtbackup/pg_dump.bakcup &gt; /mnt/workspace/temp/pg_dump.sql
</code></pre></div></div>

<h2 id="vtexport-vthtools-vtstools-vtping-">vtexport, vthtools, vtstools, vtping …</h2>

<p>On peut tout faire à distance (ou localement pour changer d’instance VTOM si plusieurs VTOM d’installés sur le même serveur).</p>

<p>Il suffit de :</p>

<ul>
  <li>récupérer les ports dans /etc/services</li>
  <li>avoir à disposition les binaires (user vtom qui charge les variables d’environnement $TOM_ADMIN/vtom_init.ksh ou avoir copié quelque part les binaires)</li>
  <li>exporter les variables</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export TOM_REMOTE_SERVER=monserveurdistant
export TOM_PORT_vtsgbd=30509
export TOM_PORT_vtserver=30507

# quelques exemples de commandes qui afficheront les résultats comme si on était sur le serveur distant
vtping
vtstools -x -e "01-01-2000 00:00:00 07-06-2016 23:59:00" 
</code></pre></div></div>

<h3 id="plus-dangereux-vtaddaccount">plus dangereux, vtaddaccount</h3>

<p>Imaginons que j’importe la base de PROD sur mon bac à sable pour faire des tests (je suis un hacker gentil quand même hein).</p>

<p>Imaginons que je n’ai pas de user / mdp pour effectuer des modifications. On rajoute le user TOM avec un profil par défaut.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vtaddaccount -l 
vtom@36122a68438c:/mnt/workspace$ vtaddaccount -l
Nom           : ADM_prf
Commentaire   :

Nom           : PIL_PROD_prf
Commentaire   :

Nom           : TOM_prf
Commentaire   :

vtaddaccount -n TOM -p TOM -d ADM_prf
</code></pre></div></div>

<p>Et biensûr, je peux faire ça à distance avec la magie du <code class="language-plaintext highlighter-rouge">export TOM_REMOTE_SERVER etc.</code></p>

<h2 id="accéder-aux-stats-directement-depuis-la-base-vtom">Accéder aux stats directement depuis la base VTOM</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$TOM_HOME/sgbd/bin/psql -d vtom -p VOTRE_PORT_SGBD &lt;&lt; EOF
\pset tuples_only
\pset footer off
\a
select *
from vt_stats_job 
limit 1
;
EOF

# autre exemple de requête pour avoir tous les traitements TERMINE ou en ERREUR
\pset footer off
\t
\f ;
\a
\o /var/tmp/20160125-123246_export_stats.csv
select vtenvname,vtapplname,vtjobname,
CASE WHEN vtstatus=4 THEN 'EN-ERREUR'
  WHEN vtstatus=3 THEN 'TERMINE'
END,
to_char(vtbegin,'DD-MM-YYYY HH24:MI:SS'),to_char(vtend,'DD-MM-YYYY HH24:MI:SS'),vterrmess,to_char(vtexpdatevalue,'DD-MM-YYYY HH24:MI:SS'),'MONDOMAINE',vtfamily,vthostname,vtbqueuename,vtusername,vtcomment,''
from vt_stats_job
where vtjobname != ''
and (vtstatus = 3 or vtstatus = 4)
;
</code></pre></div></div>

      
    </div>

  </li>
  
  
  
  <li>
    <div class="card">
      <h4><a class="post-link" href="/archives/formule-vtom/">Formules VTOM</a></h4>
      <p></p>
<p>Je rassemble ici un recueil des formules VTOM qui valent le coup d’oeil.</p>

<p>Attention, une formule VTOM dépend du calendrier sur lequel elle s’appuie. (jours fériés et jour chômés)</p>

<ul>
  <li>Veille du premier jour ouvre mois : By Fred</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test{(aujourd'hui=1.jour.ouvr.mois-1.jour.cale) ou (aujourd'hui=dern.jour.cale.mois+1.jour.ouvr-1.jour.cale)}
</code></pre></div></div>

<ul>
  <li>Premier Lundi du mois s’il est ouvré, sinon le jour ouvré qui suit</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test { (aujourd'hui=prem.lu.cale.mois et aujourd'hui=ouvr) ou (prem.lu.cale.mois=chom et aujourd'hui=prem.lu.cale.mois+1.jour et aujourd'hui=ouvr) }
</code></pre></div></div>

<p>version corrigée par Hervé G.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test { (aujourd'hui=prem.lu.cale.mois et aujourd'hui=ouvr) ou (prem.lu.cale.mois=chom et aujourd'hui=prem.lu.cale.mois+1.jour.ouvr ) }
ou plus "simple"
test { aujourd'hui&gt;=prem.lu.cale.mois et aujourd'hui=ouvr et aujourd'hui-1.jour.ouvre&lt;prem.lu.cale.mois}
</code></pre></div></div>

<ul>
  <li>premier jour ouvré du mois sauf en Janvier, et dernier jour ouvré de Décembre :</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test{
(aujourd'hui = prem.jour.ouvr.mois et aujourd'hui &lt;&gt; janvier)
ou
(aujourd'hui = dern.jour.ouvr.annee)
}
</code></pre></div></div>

<ul>
  <li>les lendemains de jour ouvré avec les dimanches chomés et les jours fériés de france. Calendrier = Dimanche chômés + jours fériés France</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test{
 aujourd'hui - 1.jour.cale = ouvr
}
</code></pre></div></div>

<ul>
  <li>2ème dimanche du mois</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> test{ aujourd'hui = 2.di.cale.mois }
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Syntaxe d'une expression: base[ +/- nnn.jour[.type] ]
base
aujourd'hui
ordre.jour.type.durée
jj.mm[.aa]
libellé_jour
libellé_mois
type
ordre
premier
dernier
xxx (quantième du jour dans la durée associée)
jour
jour
libellé_jour
libellé_jour
(lu)ndi
(ma)rdi
(me)rcredi
(je)udi
(ve)ndredi
(sa)medi
(di)manche
type
(ouvr)é
(chom)é
(cale)endaire
durée
(trim)estre
(sem)estre
(anne)e
(mois)
(quin)zaine
(sema)ine
(peri)ode[ nom de la période ]
libellé_mois
libellé_mois
(janv)ier
(fevr)ier
(mars)
(avri)l
(mai)
(juin)
(juil)let
(aout)
(sept)embre
(octo)bre
(nove)mbre
(dece)mbre
A noter:
pour l'ordre et les libellés jours et mois, seule la partie entre parenthèses est à inscrire
les espaces, tabulations et retours à la ligne sont facultatifs
les lignes commençant par « # »sont traitées comme des commentaires
tous les mots-clefs sont en minuscules non accentuées
il est possible d'ajouter des parenthèses pour regrouper les comparaisons afin d'établir les priorités entre les opérateurs logiques (« et » &amp; « ou »).
Il est également possible d’étendre ce langage afin de décrire des contraintes de planification dans une terminologie propre à l’entreprise.
L’évaluation de la formule choisie se fera lors du contrôle de planification de l’application ou du traitement par le moteur de Visual TOM qui renverra un résultat de valeur VRAI ou FAUX.
Exemples:
# le dernier jeudi férié de l’année test {today=dern.je.chom.anne}
# les lundi fériés test {today=lu et today‹›ouvr}
# le premier jour ouvré du mois test {today=1.jour.ouvr.mois}
# le dernier jour ouvré de la semaine test {today=dern.jour.ouvr.sema}
# le vendredi avec report au jour ouvré suivant si férié test {today=4.jour.cale.sema+1.jour.ouvr} test {today=1.jour.cale.sema-4.jour.cale+1.jour.ouvr}
# le mercredi de la deuxième semaine complète test {today›8.jour.cale.mois et today‹15.jour.cale.mois et today=me}
# les jours ouvrés de janvier et fériés de décembre test {today=janv et today=ouvr} test {today=dece et today=chom}
# les jours fériés consécutifs qui précèdent un lundi test {today=chom et today+1.jour.ouvr=lu}
# les jours ouvrés du mois si le 1 est un lundi test {1.jour.cale.mois=lu et today=ouvr}
# les 3 derniers jours du mois s'ils sont ouvrés et si la semaine est incomplète test {today=dern.jour.cale.mois et today=ouvr et today‹›di} test {today=dern.jour.cale.mois-1.jour.cale et today=ouvr et today‹›sa} test {today=dern.jour.cale.mois-2.jour.cale et today=ouvr et today‹›ve}
# le jeudi qui précède le dernier jour ouvré du mois test {today‹dern.jour.ouvr.mois et today+8.jour.cale›dern.jour.ouvr.mois et today=je}
# le dernier jeudi ouvré du mois test {today=dern.je.ouvr.mois}
# les mardi et jeudi ouvrés test {today=ouvr et (today=ma ou today=je)}
# le 18 juin test {today=18.06}
</code></pre></div></div>

      
    </div>

  </li>
  
  
  
  <li>
    <div class="card">
      <h4><a class="post-link" href="/archives/date-exploitation-vtom/">Date d'exploitation VTOM ne bascule pas</a></h4>
      <p></p>
<p>Les outils pour débugger une date bloquée :</p>

<ul>
  <li>Vérifier ce qui bloque la date : tchkdate /nom=&lt;nom date&gt; (ou pour avoir un rapide coup d’oeil sur l’état des dates : <code class="language-plaintext highlighter-rouge">tlist date -v</code>
</li>
  <li>Analyse/Historique : rechercher sur la date pour voir quand et par quel moteur elle a basculé</li>
</ul>

<p>Pour rappel, une date commune à plusieurs environnements n’est vraiment pas recommandée.</p>

<p>Deux exemples de problèmes :</p>

<ul>
  <li>Des jobs de l’environnement A avec une date A sont à venir et attendent indéfiniment des ressources (pour x ou y raison)
    <ul>
      <li>la date ne basculera pas à J+1</li>
      <li>les jobs de l’environnement B avec la date A resteront bloqués à leur état tant que la date ne basculera pas</li>
    </ul>
  </li>
  <li>
    <p>A l’inverse, <strong>et au hasard</strong>, ça sera le premier moteur, A ou B, qui fera basculer la date A à J+1 (pour peu que tous les jobs liés à cette date soient statués)</p>

    <ul>
      <li>à J+1 le moteur qui n’aura pas fait basculer la date ne fera pas de treset (mise AVENIR) des jobs liés à cette date. Résultat, vous aurez des jobs à l’état TERMINE (par exemple) avec la date au 25/05 alors qu’ils n’ont tourné que, et seulement que, le 24/05</li>
    </ul>
  </li>
</ul>

<p>Une petite astuce pour lister les dates d’exploitation VTOM se retrouvant sur plusieurs jobs de différents environnements. (attention à bien désallouer une date affectée à un environnement non approprié mais à auncune app/job)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ tlist env/date | sort -k"2,2" | awk '{print $2}'| uniq -c | awk '$1 &gt; 1'

$  tlist jobs | sort -u -k"5,5" -k"1,1" | awk '{print $5}' | uniq -c | awk '$1 &gt; 1'
   2 datey
   2 datex
</code></pre></div></div>

<p>Attention aussi aux dates d’exploitation différentes au sein d’un même bloc d’applications (liées entre elles). C’est possible d’avoir des dates différentes (hebdo, mensuelle par ex.) mais il faut savoir ce qu’on fait.</p>

<p>De base, je dirais qu’un bloc d’application devrait avoir la même date d’exploitation (attention aux copiés/collés surtout).</p>

<p>Petit astuce pour les lister :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi env_app_date.sql
.separator /
<span class="k">select </span>e.NAME, a.NAME, d.NAME
from applications a
left <span class="nb">join </span>environments e on a.ENV_SID <span class="o">=</span> e.ENV_SID
left <span class="nb">join </span>dates d on a.DATE_SID <span class="o">=</span> d.DATE_SID or <span class="o">(</span>ifnull<span class="o">(</span>a.DATE_SID,<span class="s1">''</span><span class="o">)</span> <span class="o">=</span> <span class="s1">''</span> and e.DATE_SID <span class="o">=</span> d.DATE_SID<span class="o">)</span>
<span class="p">;</span>

vtexport <span class="nt">-x</span> <span class="o">&gt;</span> vtexport.xml
vthttpd <span class="nt">-dump</span> vthttpd.dat
sqlite3 vthttpd.dat &lt; env_app_date.sql <span class="o">&gt;</span> apps_dateexp.txt

<span class="k">while </span><span class="nb">read </span>line
<span class="k">do 
  </span><span class="nv">parent_dateexp</span><span class="o">=</span><span class="si">$(</span>egrep <span class="s2">"^</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$line</span> | <span class="nb">cut</span> <span class="nt">-f1</span> <span class="nt">-d</span><span class="s2">" "</span><span class="sb">`</span><span class="s2">/"</span> apps_dateexp.txt | <span class="nb">cut</span> <span class="nt">-f3</span> <span class="nt">-d</span><span class="s2">"/"</span><span class="si">)</span><span class="p">;</span>
  <span class="nv">child_dateexp</span><span class="o">=</span><span class="si">$(</span>egrep <span class="s2">"^</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$line</span> | <span class="nb">cut</span> <span class="nt">-f2</span> <span class="nt">-d</span><span class="s2">" "</span><span class="sb">`</span><span class="s2">/"</span> apps_dateexp.txt | <span class="nb">cut</span> <span class="nt">-f3</span> <span class="nt">-d</span><span class="s2">"/"</span><span class="si">)</span> <span class="p">;</span>
  <span class="k">if </span><span class="nb">test</span> <span class="s2">"</span><span class="nv">$child_dateexp</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">"</span><span class="nv">$parent_dateexp</span><span class="s2">"</span>
  <span class="k">then
    </span><span class="nb">echo</span> <span class="nv">$line</span> <span class="nv">$parent_dateexp</span> <span class="nv">$child_dateexp</span>
  <span class="k">fi
done</span> &lt; &lt;<span class="o">(</span><span class="nb">sed</span> <span class="nt">-e</span> <span class="s1">'s|^[        ]*&lt;Link parent="\([^"/]*/[^"/]*\)" child="\([^"]*\)".*$|\1 \2|g'</span> <span class="nt">-e</span> <span class="s1">'tx'</span> <span class="nt">-e</span> <span class="s1">'d'</span> <span class="nt">-e</span> <span class="s1">':x'</span> vtexport.xml<span class="o">)</span>
</code></pre></div></div>

      
    </div>

  </li>
  
  
  
  <li>
    <div class="card">
      <h4><a class="post-link" href="/archives/platform-sh-orange-cloud/">Platform.sh premières impressions</a></h4>
      <p></p>
<p>Avec <a href="https://platform.sh">platform.sh</a>, Orange Cloud for Business nous promet pour nos applications Web :</p>

<ul>
  <li>un PaaS performant et sécurisé (datacenters situés en France)</li>
  <li>jusqu’a 25% d’économies sur les couts de développements et sur le DevOps</li>
  <li>de permettre aux developpeurs de se concentrer sur le code et non sur la gestion du systeme</li>
  <li>de simplifier au maximum les workflow jusqu’à la livraison du projet</li>
</ul>

<p>A premiere vue, c’est tres orienté Web et comme il y a un free trial de 30 jours, je vais tester ça !</p>

<h2 id="comment-ça-fonctionne-">Comment ça fonctionne ?</h2>

<p>Quelques liens vers les <a href="https://platform.sh/product/enterprise/docs/">white papers et case studies</a> :</p>

<ul>
  <li><a href="https://platform.sh/files/fr/Platform.sh%20-%20Introduction_FR.pdf">Introduction</a></li>
  <li><a href="https://platform.sh/files/en/Platform.sh%20-%20Data%20Sheet.pdf">Data Sheet</a></li>
</ul>

<p>Ce qu’on pourrait retenir :</p>

<ul>
  <li>utilise principalement le mécanisme de Git :
    <ul>
      <li>permet le versioning</li>
      <li>permet la livraison entre les différents environnements avec le merging</li>
      <li>permet aux équipes une meilleure communication et moins de documentation a produire (il suffit de voir les différences entre les différentes versions dans l’outil directement)</li>
    </ul>
  </li>
  <li>fonctionne avec des micro-services comme conteneurs linux LXC (un peu comme Docker)
    <ul>
      <li>il suffit de référencer les services dans des fichiers de configuration (comme mysql, postgres, etc)</li>
    </ul>
  </li>
  <li>basiquement, on n’a besoin que de trois fichiers pour initier notre environnement : .platform-app-yaml.html + .platform/services.yaml + .platform/routes.yaml</li>
  <li>l’ensemble .platform-app-yaml.html + .platform/services.yaml ressemble fortement a ce qu’on pourrait faire avec docker-compose</li>
</ul>

<p>Rentrons dans le vif du sujet, et voyons si ça vaut le coup de s’intéresser a platform.sh.</p>

<h2 id="exemple--application-simple---bonjour">Exemple : application simple - bonjour</h2>

<h3 id="ladministration-des-projets-sur-platformsh">L’administration des projets sur platform.sh</h3>

<p>Je dois avouer que tout est pensé pour simplifier au maximum les actions et les configurations.</p>

<p>Je trouve l’interface plutôt sympathique et tres fonctionnelle.</p>

<p>En 4 clics, j’ai créé mon free trial account, créé mon projet “Demo Dev” avec sa branche “master” et sa branche “n-1” (pour la version n-1 par exemple). Je peux presque commencer a écrire ou déployer mon code.</p>

<h3 id="installer-platform-cli-pour-une-meilleure-gestion-des-projets-et-environnements">Installer platform CLI pour une meilleure gestion des projets et environnements</h3>

<p>Mais d’abord, j’installe mon environnement de dev. Je run mon image <a href="https://github.com/virtual-thom/docker_debian_dev_tools/blob/master/Dockerfile">Docker Dev</a> mais n’importe quel OS avec Git, php et vos outils de dev devrait suffire.</p>

<p>J’installe <code class="language-plaintext highlighter-rouge">platform CLI</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># install
curl -sS https://platform.sh/cli/installer | php

# configuration
# et je rentre mes informations de compte pour m'authentifier
platform
...

# Je configure mes clés ssh pour Git et acces ssh
platform ssh-keys
Your SSH keys are:
+-------+----------------------------+----------------------------------+
| ID    | Title                      | Fingerprint                      |
+-------+----------------------------+----------------------------------+
| 15718 | ssh-rsa AAAAB3NzaC1yc2EAAA | xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx |
| 15721 | 26d53a922bbd               | xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx |
+-------+----------------------------+----------------------------------+

Add a new SSH key with: platform ssh-key:add
Delete an SSH key with: platform ssh-key:delete [id]

platform ssh-key:add
...
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Je clone mon projet sur la branch n-1
git clone git clone --branch n-1 nkoaolx5osnio@git.eu.platform.sh:nkoaolx5osnio.git demo-dev
...
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># je regarde la configuration 
cd demo-dev
platform 
Welcome to Platform.sh!

Project title: Demo Dev
Project ID: nkoaolx5osnio
Project dashboard: https://eu.platform.sh/#/projects/nkoaolx5osnio

Your environments are:
+--------+--------+--------+
| ID     | Name   | Status |
+--------+--------+--------+
| master | Master | Active |
| n-1*   | n-1    | Active |
+--------+--------+--------+
* - Indicates the current environment

Check out a different environment by running platform checkout [id]
Branch a new environment by running platform environment:branch [new-name]
Make a snapshot of the current environment by running platform snapshot:create
Merge the current environment by running platform environment:merge
Sync the current environment by running platform environment:synchronize

You can list other projects by running platform projects

Manage your SSH keys by running platform ssh-keys

Type platform list to see all available commands.
</code></pre></div></div>

<h3 id="configuration-de-lapplication--platform-app-yamlhtml--platformservicesyaml--platformroutesyaml">Configuration de l’application : .platform-app-yaml.html + .platform/services.yaml + .platform/routes.yaml</h3>

<ul>
  <li><a href="https://docs.platform.sh/user_guide/reference/routes-yaml.html">routes.yaml</a></li>
  <li><a href="https://docs.platform.sh/user_guide/reference/services-yaml.html">services.yaml</a></li>
  <li><a href="https://docs.platform.sh/user_guide/reference/platform-app-yaml.html">platform app</a></li>
</ul>

<p>Pour mon application “bonjour” :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|-- .git
|-- .platform
|   |-- local
|   |   |-- README.txt
|   |   `-- project.yaml
|   |-- routes.yaml
|   `-- services.yaml
|-- .platform.app.yaml
|-- index.php

index.php
&lt;?php echo "bonjour" ; ?&gt;

.platform.app.yaml
name: bonjour
type: php
disk: 128
web:
    document_root: "/"
    passthru: "/index.php"

.platform/routes.yaml
"http://{default}/":
    type: upstream
    upstream: "bonjour:php"

"http://www.{default}/":
    type: redirect
    to: "http://{default}/"

.platform/services.yaml
vide (pas de dépendance a d'autres services)
par défaut,  : 
mysql:
    type: mysql:5.5
    disk: 2048

redis:
    type: redis:2.8

solr:
    type: solr:3.6
    disk: 1024
</code></pre></div></div>

<h3 id="mise-a-jour-de-lenvironnement-n-1">mise a jour de l’environnement n-1</h3>

<p>Il n’y a plus qu’a push ce qu’on a construit localement.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git add --all ; git commit -m "first app bonjour" ; git push
...
# on voit qu'il va plus loin qu'un simple push, il construit l'environnement et le lance comme conteneur (avec les instructions que j'ai défini dans les fichiers de configuration) 
</code></pre></div></div>

<h3 id="je-teste-et-je-merge-sur-la-branch-principale">Je teste et je merge sur la branch principale</h3>

<p>platform.sh s’occupe de tout. Il créé meme une url par environnement et par projet.</p>

<p>Je vérifie que j’ai bien mon rendu d’appli “bonjour” sur version-projet.eu.platform.sh ==&gt; OK !</p>

<p>Je merge l’environnement n-1 vers la branche master.</p>

<p><img src="https://virtual-thom.github.io/archives/assets/img/platform.sh.merge-n-1.jpg" alt="platform.sh.merge-n-1.jpg"></p>

<p>Et voila !</p>

<h2 id="autres-applications">Autres applications</h2>

<p>Il semblerait que les deux projets fournis de base soient Symfony ou Drupal pour le moment. J’ai testé deux minutes et ça semble fonctionner sans qu’on ne touche a rien.</p>

<p>Il n’y a plus  qu’a intégrer ses Bundles et a coder.</p>

<p>Pour le reste, il me semble que les services proposés sont suffisants et demandent peu de configuration :</p>

<ul>
  <li>PHP</li>
  <li>Python</li>
  <li>Ruby</li>
  <li>NodeJS</li>
  <li>Java (with integrated Maven and Ant support)</li>
  <li>Postgres, MySQL, Redis etc.</li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>platform.sh est vraiment intéressant pour les équipes de développements d’applications web de moyenne a grande envergure.</p>

<p>Tous les concepts sont connus (Git, CaaS (container as service), répartition de charge du trafic automatique, automatisation des tâches avec Grunt ou maintien des dépendances de librairies avec Composer, etc).</p>

<p>Ca n’est donc pas une révolution. Cependant, la promesse de simplifier les actions d’administration semble tenue.</p>

<p>Une fois qu’on a bien compris le fonctionnement des trois fichiers de configuration - .platform-app-yaml.html + .platform/services.yaml + .platform/routes.yaml - on peut, effectivement, se concentrer sur le code et la gestion des workflows.</p>


      
    </div>

  </li>
  
  
  
  <li>
    <div class="card">
      <h4><a class="post-link" href="/archives/vtplan/">vtplan VTOM</a></h4>
      <p></p>
<h2 id="vtplan-----affiche-la-planification-des-applications-ou-traitements">vtplan  -  affiche la planification des applications ou traitements</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Comme on pourrait le voir dans VTOM (clique droit &gt; planification)
vtom@9b99febd3506:/mnt/User/temp/install$ vtplan /filter TEST -a /format table /range "01-01-2016 31-12-2016"
[Du vendredi 1 janvier 2016 au samedi 31 decembre 2016 (366 jour(s))]

TEST/APP_1

    ANNEE 2016
    ==========

    J  F  M  A  M  J  J  A  S  O  N  D
---------------------------------------
 1  N  O  N  N  N  N  N  O  N  N  N  N
 2  N  N  N  N  O  N  N  N  N  N  N  N
 3  N  N  N  N  N  N  N  N  N  O  N  N
 4  O  N  N  O  N  N  O  N  N  N  N  N
 5  N  N  N  N  N  N  N  N  O  N  N  O
 6  N  N  N  N  N  O  N  N  N  N  N  N
 7  N  N  O  N  N  N  N  N  N  N  O  N
 8  N  N  N  N  N  N  N  N  N  N  N  N
 9  N  N  N  N  N  N  N  N  N  N  N  N
10  N  N  N  N  N  N  N  N  N  N  N  N
11  N  N  N  N  N  N  N  N  N  N  N  N
12  N  N  N  N  N  N  N  N  N  N  N  N
13  N  N  N  N  N  N  N  N  N  N  N  N
14  N  N  N  N  N  N  N  N  N  N  N  N
15  N  N  N  N  N  N  N  N  N  N  N  N
16  N  N  N  N  N  N  N  N  N  N  N  N
17  N  N  N  N  N  N  N  N  N  N  N  N
18  N  N  N  N  N  N  N  N  N  N  N  N
19  N  N  N  N  N  N  N  N  N  N  N  N
20  N  N  N  N  N  N  N  N  N  N  N  N
21  N  N  N  N  N  N  N  N  N  N  N  N
22  N  N  N  N  N  N  N  N  N  N  N  N
23  N  N  N  N  N  N  N  N  N  N  N  N
24  N  N  N  N  N  N  N  N  N  N  N  N
25  N  N  N  N  N  N  N  N  N  N  N  N
26  N  N  N  N  N  N  N  N  N  N  N  N
27  N  N  N  N  N  N  N  N  N  N  N  N
28  N  N  N  N  N  N  N  N  N  N  N  N
29  N  N  N  N  N  N  N  N  N  N  N  N
30  N  -  N  N  N  N  N  N  N  N  N  N
31  N  -  N  -  N  -  N  N  -  N  -  N

# Avec les dates
vtom@9b99febd3506:/mnt/User/temp/install$ vtplan /filter TEST -a /format date /range "01-01-2016 31-12-2016"
[Du vendredi 1 janvier 2016 au samedi 31 decembre 2016 (366 jour(s))]

TEST/APP_1
01-jan-2016 = NON
02-jan-2016 = NON
03-jan-2016 = NON
04-jan-2016 = OUI
05-jan-2016 = NON
06-jan-2016 = NON
07-jan-2016 = NON
08-jan-2016 = NON
09-jan-2016 = NON
10-jan-2016 = NON
11-jan-2016 = NON
12-jan-2016 = NON
13-jan-2016 = NON
14-jan-2016 = NON
15-jan-2016 = NON
16-jan-2016 = NON
17-jan-2016 = NON
18-jan-2016 = NON
19-jan-2016 = NON
20-jan-2016 = NON
21-jan-2016 = NON
22-jan-2016 = NON
... (tronqué)

# EN CSV
vtom@9b99febd3506:/mnt/User/temp/install$ vtplan /filter TEST -a /format csv /range "01-01-2016 31-12-2016"
[Du vendredi 1 janvier 2016 au samedi 31 decembre 2016 (366 jour(s))]
TEST;APP_1;0;0;0;1;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;1;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;1;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;1;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;1;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;1;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;1;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;1;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;1;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;1;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;1;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;1;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0
</code></pre></div></div>

      
    </div>

  </li>
  
  
  
  <li>
    <div class="card">
      <h4><a class="post-link" href="/archives/priorite-queue-batch-vtom/">Priorité queue batch VTOM</a></h4>
      <p></p>
<p>&lt;EDIT&gt;
<small>
Une option de priorité a été ajoutée depuis 5.7+ et se gère au niveau des objets Applications et Traitements. (case à cocher “Priorité” de 0 jusqu’à 127, 0 étant le moins prioritaire). Cette nouvelle fonctionnalité palie à la décision arbitraire du moteur de mettre tel ou tel job (ou application) à ENCOURS avant tel ou tel autre, mais ne remplace pas la priorité de la queue batch dans la file d’attente.</small></p>

<h2 id="problématique-des-gros-environnements-de-production">Problématique des gros environnements de production</h2>

<p>Certains clients VTOM à forte charge d’ordonnancement voient leurs files d’attente saturées, et des traitements non prioritaires qui durent des heures bloquent le passage de traitements “rapides” (qui pourraient débloquer des chaînes bien plus prioritaires).</p>

<h2 id="priorité-dans-la-file-dattente--principe">Priorité dans la file d’attente : principe</h2>

<p>Tous les jobs dont le moteur a validé les contraintes (horaires, liens, ressources) passent à « EN COURS » dans VTOM selon un ordre  propre au moteur. (ex. JOB_1 commence avant JOB_2 qui commence avant JOB_3 etc. quelque soit la priorité de vos queues).</p>

<p>« EN COURS » dans VTOM != d’en cours d’exécution sur le host.</p>

<p>Seuls les n premiers jobs (nombre de jobs simultanés configuré dans le queue.conf) s’exécutent réellement, le reste passe en file d’attente (souvent illimitée -1).</p>

<p>Dès qu’un job se termine, il libère une place et les jobs avec la queue batch la plus prioritaire se déclenchent.</p>

<h2 id="mise-en-place-des-queues-prioritaires">Mise en place des queues prioritaires</h2>

<p>La gestion des priorités est prise en charge suite à :</p>

<ul>
  <li>Paramétrage du fichier vtom.ini,</li>
  <li>Déclaration des queues batch dans le référentiel.</li>
</ul>

<p>Paramètre ABM_QUEUES_PRIORITY_INCREMENT dans le vtom.ini sous [BDAEMON] sont les suivants :</p>

<ul>
  <li>DISABLED : 	la gestion est désactivée.</li>
  <li>BY_ONE : 	après chaque fin de Traitement, la priorité des travaux présents dans la file est incrémentée de 1. (activé par défaut)</li>
  <li>BY_PRIORITY : 	après chaque fin de Traitement, la priorité des travaux présents dans la file est incrémentée de la priorité initiale.</li>
</ul>

<p>Ex. priorité sur la queue batch « queue_ksh » :</p>

<ul>
  <li>queue_ksh.0 » pour les Traitements non prioritaires,</li>
  <li>queue_ksh.3 » pour les Traitements peu prioritaires,</li>
  <li>queue_ksh[.5] » par défaut,</li>
  <li>queue_ksh.7 » pour les Traitements relativement prioritaires,</li>
  <li>queue_ksh.10 » pour les Traitements prioritaires.</li>
</ul>

<p>Remarques :</p>

<ul>
  <li>Les Traitements ayant une priorité initiale à 10 la conservent et sont prioritaires quelque soit la priorité des autres Traitements.</li>
  <li>Les Traitements ayant une priorité initiale à 0 la conservent.</li>
</ul>

<h2 id="solutions-pour-améliorer-votre-file-dattente">Solutions pour améliorer votre file d’attente</h2>

<ul>
  <li>mettre en place ce système de priorisation des queues batch &lt;nom queue&gt;.[0-10]</li>
  <li>analyser vos jobs, et éviter d’exécuter des jobs sur des clients de traitement/applicatif alors qu’ils pourraient/devraient tourner sur les clients du serveur VTOM (valorisation de ressource par exemple)</li>
  <li>éviter les scripts qui ne font rien d’autres que temporiser ou attendre des ressources (typiquement le job : exit 0, qui attend que telle ou telle ressource soit dispo)
    <ul>
      <li>à une époque, il était pratique d’avoir la log d’exécution sur le traitement pour connaître les heures de passage, mais maintenant avec les statistiques sélectives, on s’en passe</li>
      <li>soit on remplace par un job en simulation (pas de passage dans la file d’attente), soit on essaye de positionner les ressources au niveau de l’application plutôt que du job (si c’est faisable)</li>
    </ul>
  </li>
  <li>multiplier les queues d’exécution :
    <ul>
      <li>1 queue pour les traitements techniques “rapides”</li>
      <li>1 queue pour les traitements applicatifs “longs”</li>
    </ul>
  </li>
</ul>

<h2 id="rappel-queue-batch">rappel queue batch</h2>

<ul>
  <li>1 file d’attente = 1 queue batch VTOM sur 1 client VTOM</li>
  <li>
    <p>1 client VTOM = 1 process bdaemon sur 1 machine (si plusieurs bdaemon sur une machine, ce sont des clients VTOM différents - port qui change)</p>
  </li>
  <li>Les queues sont configurées dans $ABM/config/queues du client
    <ul>
      <li>1 répertoire / queue :</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> <span class="nv">$ABM</span>/config/queues
drwxr-xr-x    2 u1vtom   vtom            256 Jun  7 2012  <span class="nv">$job</span><span class="err">$</span>
drwxr-xr-x    2 u1vtom   vtom            256 Jun  7 2012  <span class="nv">$none</span><span class="err">$</span>
drwxr-xr-x    2 u1vtom   vtom            256 Jun  7 2012  queue_csh
drwxr-xr-x    2 u1vtom   vtom            256 Jun  7 2012  queue_ksh
drwxr-xr-x    2 u1vtom   vtom            256 Jun  7 2012  queue_perl
drwxr-xr-x    2 u1vtom   vtom            256 Jun  7 2012  queue_rexx
drwxr-xr-x    2 u1vtom   vtom            256 Jun 30 2014  queue_sap
drwxr-xr-x    2 u1vtom   vtom            256 Jun  7 2012  queue_sh
drwxr-xr-x    2 u1vtom   vtom            256 Jun  7 2012  queue_tcsh
</code></pre></div></div>
<ul>
  <li>1 queue.conf + 1 users / répertoire :</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> <span class="nv">$ABM</span>/config/queues/queue_ksh/queue.conf
queue_ksh     nom de la queue
10            nombre max. de <span class="nb">jobs </span>en simultané
<span class="nt">-1</span>            nombre max. de <span class="nb">jobs </span>dans la file d’attente <span class="o">(</span><span class="nt">-1</span> illimité<span class="o">)</span>
/bin/ksh      binaire pour lancer la queue
20            obsolète
<span class="nv">$ </span><span class="nb">cat</span> <span class="nv">$ABM</span>/config/queues/queue_ksh/users
any:-1:-1     on peut surdéfinir la priorité par utilisateur unix : user:nb max. parall:nb max. file
</code></pre></div></div>

<ul>
  <li>1 job en cours dans VTOM = 1 fichier dans $ABM_SPOOL (+ .env si dans la file)</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ls</span> <span class="nv">$ABM_SPOOL</span>
10      12      14      16      18      20      21      22      23      24      25      26      27      28      29      30      31      32
11      13      15      17      19      20.env  21.env  22.env  23.env  24.env  25.env  26.env  27.env  28.env  29.env  30.env  31.env  32.env
</code></pre></div></div>

<p><a href="https://virtual-thom.github.io/archives/ecrire-sa-queue-batch-vtom-cygwin-php-perl/">Ecrire sa queue batch VTOM</a></p>

      
    </div>

  </li>
  
  
  
  <li>
    <div class="card">
      <h4><a class="post-link" href="/archives/export-consignes-vtom-html-docker/">VTOM export consigne html - Docker et python</a></h4>
      <p></p>
<p>Voici mon premier Tuto en image ! soyez indulgents :) 
Si ça plait, j’en ferai d’autres (mieux, avec le son etc)</p>

<p>Ce tuto permet d’exporter les consignes VTOM et d’appréhender Docker.</p>

<p>J’utilise Docker pour l’environenemnt de test (voir mon tuto sur Docker : <a href="https://virtual-thom.github.io/archives/docker-installation-serveur-vtom-test/">Environnement de test VTOM avec Docker</a> )</p>

<p>Et python pour le code d’export des consignes VTOM.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/QfWva3NoZCE" frameborder="0" allowfullscreen=""></iframe>

<h3 id="code-et-commandes-utilisés-">Code et commandes utilisés :</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># construire l'image à partir du DockerFile</span>
docker built &lt;répertoire&gt;

<span class="c"># lister les images docker</span>
docker images

<span class="c"># lancer un conteneur de votre image en interactif tty et en redirigeant les ports de votre machine vers le conteneur (IHM)</span>
docker run <span class="nt">-ti</span> <span class="nt">-p</span> 30007-30008:30007-30008 &lt;nomImage|ID&gt;

<span class="c"># les instances de container qui sont en cours</span>
docker ps

<span class="c"># connaitre l'adresse IP de votre machine docker (utile sous Windows)</span>
docker-machine ip

<span class="c"># pour donner un nom à votre image</span>
docker tag imageID imageName

<span class="c"># pour supprimer l'image</span>
docker rmi <span class="nt">-f</span> monImage

<span class="c"># Export de la base VTOM en xml</span>
vtexport <span class="nt">-x</span> <span class="o">&gt;</span> /var/tmp/vtexport.xml
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">encodings</span>
<span class="kn">from</span> <span class="n">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
<span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="sh">'</span><span class="s">/var/tmp/vtexport.xml</span><span class="sh">'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">Instruction</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">.</span><span class="nf">xpath</span><span class="p">(</span><span class="sh">'</span><span class="s">/Domain/Instructions/Instruction</span><span class="sh">'</span><span class="p">):</span>
		<span class="n">nameFileConsigne</span> <span class="o">=</span> <span class="n">Instruction</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">Content</span> <span class="ow">in</span> <span class="n">Instruction</span><span class="p">.</span><span class="nf">xpath</span><span class="p">(</span><span class="sh">'</span><span class="s">Content</span><span class="sh">'</span><span class="p">):</span>
			<span class="n">f</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">nameFileConsigne</span> <span class="o">+</span>  <span class="sh">"</span><span class="s">.html</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">Content</span><span class="p">.</span><span class="n">text</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">base64</span><span class="sh">'</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">zlib</span><span class="sh">'</span><span class="p">)</span>
			<span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
			<span class="n">f</span><span class="p">.</span><span class="n">close</span>
</code></pre></div></div>

<p>Au fait, comment j’en suis arrivé là ?!</p>

<p>C’est sur la demande d’un client qui voulait toutes les consignes VTOM.</p>

<p>J’ai vraiment galéré pour décoder les consignes qui sont encodées.</p>

<p>En fait, ma piste a pris le bon chemin quand j’ai fait un <code class="language-plaintext highlighter-rouge">strings $TOM_BIN/vthttpd</code> car j’ai vu que le web access le décodait à la volée. Et là, on voit qu’il y a du <code class="language-plaintext highlighter-rouge">abs_zipbase64</code> et du <code class="language-plaintext highlighter-rouge">base64Binary</code>.</p>

<p>Autant le base64, c’était assez clair, la chaîne avait une bonne tête de base64.</p>

<p>Autant, je peux vous dire que j’en ai essayé des encodages pour trouver le zlib ! et j’ai perdu mon temps sur les sites de décodages du net car ils me supprimaient des caractères à chaque fois.</p>

<p>Heureusement que python est là !</p>

<p>A l’inverse, si vous voulez intégrer massivement des consignes à partir de fichiers html, c’est possible - à vos risques et périls, testez toujours en environnement de test -  en encodant en (‘zlib’) puis en (‘base64’) et en intégrant un node &lt;Instruction&gt; dans le vtexport.xml.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">encodings</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="n">f</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">monfichier.html</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
<span class="n">s</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">zlib</span><span class="sh">'</span><span class="p">).</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">base64</span><span class="sh">'</span><span class="p">)</span>
<span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(attention aux sauts de ligne, ils sont importants)
eJyzyTC0c8rPy8ovLVLwKc1OVVC00QcKcdkU2HmlKhSXZhYrlOTnKdgk2QW8KEq10U8CSukX2HEB
APm2EWI=
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Instructions&gt;
...
  
    &lt;Instruction name="MA_CONSIGNE_1" comment="ceci est un commentaire"&gt;
      &lt;Content&gt;&lt;![CDATA[eJyzyTC0c8rPy8ovLVLwKc1OVVC00QcKcdkU2HmlKhSXZhYrlOTnKdgk2QW8KEq10U8CSukX2HEB
APm2EWI=]]&gt;&lt;/Content&gt;
    &lt;/Instruction&gt;
...
&lt;/Instructions&gt;
</code></pre></div></div>

<p>Pour le web access si ça vous intéresse, regarder mon tuto <a href="https://virtual-thom.github.io/archives/api-vtom-web-access/">Web Access API VTOM</a>  :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>api/instruction/getAll 
</code></pre></div></div>

      
    </div>

  </li>
  
  
</ul>
<!-- Pagination links -->
<nav>
  <ul class="pagination">
    
    <li>
      <a href="/page7" class="Précédant">
        <span aria-hidden="true">«</span>
      </a>
    </li>
      
    <li>
      <a href="/archives/index.html">1</a>
    </li>
      
    <li>
      <a href="/archives/page2">2</a>
    </li>
      
    <li>
      <a href="/archives/page3">3</a>
    </li>
      
    <li>
      <a href="/archives/page4">4</a>
    </li>
      
    <li>
      <a href="/archives/page5">5</a>
    </li>
      
    <li>
      <a href="/archives/page6">6</a>
    </li>
      
    <li>
      <a href="/archives/page7">7</a>
    </li>
      
    <li class="active">
      <span>8</span>
    </li>
      
    <li>
      <a href="/archives/page9">9</a>
    </li>
      
    <li>
      <a href="/archives/page10">10</a>
    </li>
      
    <li>
      <a href="/archives/page11">11</a>
    </li>
      
    <li>
      <a href="/archives/page12">12</a>
    </li>
      
    <li>
      <a href="/archives/page13">13</a>
    </li>
      
    <li>
      <a href="/archives/page14">14</a>
    </li>
      
    <li>
      <a href="/page9" aria-label="Suivant">
        <span aria-hidden="true">»</span>
      </a>
    </li>
    
  </ul>
</nav>

      <footer id="site-footer">
    <div>©<a href="https://github.com/virtual-thom/" title="Github Virtual-Thom">Virtual-Thom</a>
</div>
    <div>
            <a href="https://virtual-thom.github.io/archives/plan" title="Plan du site">sitemap</a> | <a href="https://virtual-thom.github.io/about" rel="publisher author" title="Curriculum vitae Thom">A propos</a>
    </div>
    <div>
        <a id="goto-site-header" href="#site-header" title="Retourner au début">⇑ Top</a>
    </div>
    <div id="footer-disclaimer">
        <p>Avertissement : vous ne devez pas prendre pour argent comptant le contenu de ce site. Testez toujours la solution en environnement de test.</p>
        <p>Malgré le sérieux que je m'efforce de mettre dans le contenu de ces billets, je ne pourrai être tenu responsable d'éventuelles erreurs que cela pourrait engendrer.</p>
    </div>
    <div>
        <a class="hidden" href="https://virtual-thom.github.io/archives/sitemap.xml" title="SiteMap">sitemap</a>
    </div>
</footer>

    </div>
  </body>

</html>