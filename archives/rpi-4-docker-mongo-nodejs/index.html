<!DOCTYPE html>
<html lang="fr">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="apple-touch-icon" href="https://virtual-thom.github.io/archives/apple-touch-icon.png">
  <link rel="icon" href="https://virtual-thom.github.io/archives/favicon.ico" />
  <!-- Remplacé par Jekyll SEO (sinon apparait en double)
  <title>Balance ton Paille !</title>
  <meta name="description" content="Edit 2021Je laisse l’article mais pas mal de trucs sont outdated.J’ai vraiment l’impression que beaucoup de logiciels sont portés sur l’architecture arm depu...">
  --> 
  
  <link rel="canonical" href="https://virtual-thom.github.io/archives/rpi-4-docker-mongo-nodejs/">
  
  <link rel="stylesheet" media="screen" href="https://virtual-thom.github.io/archives/assets/main.css">
  
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Balance ton Paille ! | Virtual-Thom Blog-notes VTOM et informatique</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Balance ton Paille !" />
<meta name="author" content="Virtual Thom" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Edit 2021 Je laisse l’article mais pas mal de trucs sont outdated. J’ai vraiment l’impression que beaucoup de logiciels sont portés sur l’architecture arm depuis que NVIDIA et Apple en ont parlé. Du coup, c’est maintenant ultra simple d’installer Visual Studio Code et Docker sur son RPI4 avec l’OS de base fourni par Raspberrypi.org. RPI4 is Here ! Petit retour d’expérience sur mon nouveau pc, le raspberry pi 4. Pourquoi une framboise à la maison ?! un cloud personnel, aussi bien compute que file, et même, pourquoi pas, un serveur web perso en activant le domaine gratuit free (soit par la box “Nom de domaine”, soit par le compte free) consommation ridicule (bien pour la planète et mon portefeuille ~ 5€ par an) une interface avec le monde (GPIO, ces petites broches d’entrée/sortie qui nous permettent de faire de la domotique, des stations météos, etc.) je joue de moins en moins sur ma grosse machine, il n’est pas impossible qu’il devienne mon pc principal avec une GUI Les galères du début Tout dépend de votre utilisation, mais pour ma part, “ma vie a changé” depuis que je suis passé de la distribution Raspbian à l’Ubuntu. Entendez-moi bien, la Raspbian est super stable, elle fait le taff à merveille pour un pc standard et du dev standard 99% du temps. Mais alors quand il s’agit de monter un docker, la moitié des images du Hub ne fonctionnent pas, certains paquets apt non plus (style mongodb) Bref, tout ça pour dire, vive Ubuntu Server !" />
<meta property="og:description" content="Edit 2021 Je laisse l’article mais pas mal de trucs sont outdated. J’ai vraiment l’impression que beaucoup de logiciels sont portés sur l’architecture arm depuis que NVIDIA et Apple en ont parlé. Du coup, c’est maintenant ultra simple d’installer Visual Studio Code et Docker sur son RPI4 avec l’OS de base fourni par Raspberrypi.org. RPI4 is Here ! Petit retour d’expérience sur mon nouveau pc, le raspberry pi 4. Pourquoi une framboise à la maison ?! un cloud personnel, aussi bien compute que file, et même, pourquoi pas, un serveur web perso en activant le domaine gratuit free (soit par la box “Nom de domaine”, soit par le compte free) consommation ridicule (bien pour la planète et mon portefeuille ~ 5€ par an) une interface avec le monde (GPIO, ces petites broches d’entrée/sortie qui nous permettent de faire de la domotique, des stations météos, etc.) je joue de moins en moins sur ma grosse machine, il n’est pas impossible qu’il devienne mon pc principal avec une GUI Les galères du début Tout dépend de votre utilisation, mais pour ma part, “ma vie a changé” depuis que je suis passé de la distribution Raspbian à l’Ubuntu. Entendez-moi bien, la Raspbian est super stable, elle fait le taff à merveille pour un pc standard et du dev standard 99% du temps. Mais alors quand il s’agit de monter un docker, la moitié des images du Hub ne fonctionnent pas, certains paquets apt non plus (style mongodb) Bref, tout ça pour dire, vive Ubuntu Server !" />
<link rel="canonical" href="https://virtual-thom.github.io/archives/rpi-4-docker-mongo-nodejs/" />
<meta property="og:url" content="https://virtual-thom.github.io/archives/rpi-4-docker-mongo-nodejs/" />
<meta property="og:site_name" content="Virtual-Thom Blog-notes VTOM et informatique" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-11-01T17:34:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Balance ton Paille !" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Virtual Thom"},"dateModified":"2019-11-01T17:34:00+00:00","datePublished":"2019-11-01T17:34:00+00:00","description":"Edit 2021 Je laisse l’article mais pas mal de trucs sont outdated. J’ai vraiment l’impression que beaucoup de logiciels sont portés sur l’architecture arm depuis que NVIDIA et Apple en ont parlé. Du coup, c’est maintenant ultra simple d’installer Visual Studio Code et Docker sur son RPI4 avec l’OS de base fourni par Raspberrypi.org. RPI4 is Here ! Petit retour d’expérience sur mon nouveau pc, le raspberry pi 4. Pourquoi une framboise à la maison ?! un cloud personnel, aussi bien compute que file, et même, pourquoi pas, un serveur web perso en activant le domaine gratuit free (soit par la box “Nom de domaine”, soit par le compte free) consommation ridicule (bien pour la planète et mon portefeuille ~ 5€ par an) une interface avec le monde (GPIO, ces petites broches d’entrée/sortie qui nous permettent de faire de la domotique, des stations météos, etc.) je joue de moins en moins sur ma grosse machine, il n’est pas impossible qu’il devienne mon pc principal avec une GUI Les galères du début Tout dépend de votre utilisation, mais pour ma part, “ma vie a changé” depuis que je suis passé de la distribution Raspbian à l’Ubuntu. Entendez-moi bien, la Raspbian est super stable, elle fait le taff à merveille pour un pc standard et du dev standard 99% du temps. Mais alors quand il s’agit de monter un docker, la moitié des images du Hub ne fonctionnent pas, certains paquets apt non plus (style mongodb) Bref, tout ça pour dire, vive Ubuntu Server !","headline":"Balance ton Paille !","mainEntityOfPage":{"@type":"WebPage","@id":"https://virtual-thom.github.io/archives/rpi-4-docker-mongo-nodejs/"},"url":"https://virtual-thom.github.io/archives/rpi-4-docker-mongo-nodejs/"}</script>
<!-- End Jekyll SEO tag -->

  
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z8Y7902GRV"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Z8Y7902GRV');
</script>


  <body>
    <div class="container">
      <header id="site-header">
  <h1>Blog-notes VTOM, informatique, industrialisation, ordonnancement, DevOps</h1>
  <nav>
    <ul>
      <li>
        <a href="https://virtual-thom.github.io/archives" title="Home">
          <svg class="svg-icon" viewBox="0 0 20 20">
            <path d="M18.121,9.88l-7.832-7.836c-0.155-0.158-0.428-0.155-0.584,0L1.842,9.913c-0.262,0.263-0.073,0.705,0.292,0.705h2.069v7.042c0,0.227,0.187,0.414,0.414,0.414h3.725c0.228,0,0.414-0.188,0.414-0.414v-3.313h2.483v3.313c0,0.227,0.187,0.414,0.413,0.414h3.726c0.229,0,0.414-0.188,0.414-0.414v-7.042h2.068h0.004C18.331,10.617,18.389,10.146,18.121,9.88 M14.963,17.245h-2.896v-3.313c0-0.229-0.186-0.415-0.414-0.415H8.342c-0.228,0-0.414,0.187-0.414,0.415v3.313H5.032v-6.628h9.931V17.245z M3.133,9.79l6.864-6.868l6.867,6.868H3.133z"></path>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://virtual-thom.github.io/archives/vos-commentaires-livre-d-or/" title="Commentaires - livre d'or">
          <svg class="svg-icon" viewBox="0 0 20 20">
            <path d="M17.657,2.982H2.342c-0.234,0-0.425,0.191-0.425,0.426v10.21c0,0.234,0.191,0.426,0.425,0.426h3.404v2.553c0,0.397,0.48,0.547,0.725,0.302l2.889-2.854h8.298c0.234,0,0.426-0.191,0.426-0.426V3.408C18.083,3.174,17.892,2.982,17.657,2.982M17.232,13.192H9.185c-0.113,0-0.219,0.045-0.3,0.124l-2.289,2.262v-1.96c0-0.233-0.191-0.426-0.425-0.426H2.767V3.833h14.465V13.192z M10,7.237c-0.821,0-1.489,0.668-1.489,1.489c0,0.821,0.668,1.489,1.489,1.489c0.821,0,1.488-0.668,1.488-1.489C11.488,7.905,10.821,7.237,10,7.237 M10,9.364c-0.352,0-0.638-0.288-0.638-0.638c0-0.351,0.287-0.638,0.638-0.638c0.351,0,0.638,0.287,0.638,0.638C10.638,9.077,10.351,9.364,10,9.364 M14.254,7.237c-0.821,0-1.489,0.668-1.489,1.489c0,0.821,0.668,1.489,1.489,1.489s1.489-0.668,1.489-1.489C15.743,7.905,15.075,7.237,14.254,7.237 M14.254,9.364c-0.351,0-0.638-0.288-0.638-0.638c0-0.351,0.287-0.638,0.638-0.638c0.352,0,0.639,0.287,0.639,0.638C14.893,9.077,14.605,9.364,14.254,9.364 M5.746,7.237c-0.821,0-1.489,0.668-1.489,1.489c0,0.821,0.668,1.489,1.489,1.489c0.821,0,1.489-0.668,1.489-1.489C7.234,7.905,6.566,7.237,5.746,7.237 M5.746,9.364c-0.351,0-0.638-0.288-0.638-0.638c0-0.351,0.287-0.638,0.638-0.638c0.351,0,0.638,0.287,0.638,0.638C6.384,9.077,6.096,9.364,5.746,9.364"></path>
          </svg>
        </a>
      </li>
      
      <li>
        <a href="https://virtual-thom.github.io/about" title="Curriculum Vitae Thom">
          <svg class="svg-icon" viewBox="0 0 20 20">
            <path d="M12.075,10.812c1.358-0.853,2.242-2.507,2.242-4.037c0-2.181-1.795-4.618-4.198-4.618S5.921,4.594,5.921,6.775c0,1.53,0.884,3.185,2.242,4.037c-3.222,0.865-5.6,3.807-5.6,7.298c0,0.23,0.189,0.42,0.42,0.42h14.273c0.23,0,0.42-0.189,0.42-0.42C17.676,14.619,15.297,11.677,12.075,10.812 M6.761,6.775c0-2.162,1.773-3.778,3.358-3.778s3.359,1.616,3.359,3.778c0,2.162-1.774,3.778-3.359,3.778S6.761,8.937,6.761,6.775 M3.415,17.69c0.218-3.51,3.142-6.297,6.704-6.297c3.562,0,6.486,2.787,6.705,6.297H3.415z"></path>
          </svg>
        </a>
      </li>
    </ul>
  </nav>
</header>

      <div itemscope itemtype ="http://schema.org/Article" class="post">
  
  <header class="post-header">
    <h1 itemprop="name about headline" class="post-title">Balance ton Paille !</h1>
    <p class="post-meta">
      <time itemprop="datePublished dateModified" datetime="2019-11-01T17:34:00+00:00">01-11-2019</time></p>
  </header>

  <article class="post-content" itemprop="articleBody">
    <h1 class="hidden">Balance ton Paille !</h1>
    <h1 id="edit-2021">Edit 2021</h1>
<p>Je laisse l’article mais pas mal de trucs sont outdated.<br />
J’ai vraiment l’impression que beaucoup de logiciels sont portés sur l’architecture arm depuis que NVIDIA et Apple en ont parlé.<br />
Du coup, c’est maintenant ultra simple d’installer Visual Studio Code et Docker sur son RPI4 avec l’OS de base fourni par <a href="https://www.raspberrypi.org/software/operating-systems/">Raspberrypi.org</a>.</p>

<h1 id="rpi4-is-here-">RPI4 is Here !</h1>
<p>Petit retour d’expérience sur mon nouveau pc, le raspberry pi 4.</p>
<h2 id="pourquoi-une-framboise-à-la-maison-">Pourquoi une framboise à la maison ?!</h2>
<ul>
  <li>un cloud personnel, aussi bien compute que file, et même, pourquoi pas, un serveur web perso en activant le domaine gratuit free (soit par la box “Nom de domaine”, soit par le compte free)</li>
  <li>consommation ridicule (bien pour la planète et mon portefeuille ~ 5€ par an)</li>
  <li>une interface avec le monde (GPIO, ces petites broches d’entrée/sortie qui nous permettent de faire de la domotique, des stations météos, etc.)</li>
  <li>je joue de moins en moins sur ma grosse machine, il n’est pas impossible qu’il devienne mon pc principal avec une GUI</li>
</ul>

<h2 id="les-galères-du-début">Les galères du début</h2>
<p>Tout dépend de votre utilisation, mais pour ma part, “ma vie a changé” depuis que je suis passé de la distribution <a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian</a> à l’<a href="https://ubuntu.com/download/iot/raspberry-pi">Ubuntu</a>.
Entendez-moi bien, la Raspbian est super stable, elle fait le taff à merveille pour un pc standard et du dev standard 99% du temps. Mais alors quand il s’agit de monter un docker, la moitié des images du Hub ne fonctionnent pas, certains paquets apt non plus (style mongodb)</p>

<p>Bref, tout ça pour dire, vive Ubuntu Server !</p>

<!--more-->

<p>Pour passer en arm64, <code class="language-plaintext highlighter-rouge">rpi-update</code> et rajouter <code class="language-plaintext highlighter-rouge">arm_64bit=1</code> dans /boot/config.txt :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo rpi-update
sudo vi /boot/config.txt
...
[all]
arm_64bit=1
...
</code></pre></div></div>

<p>Install vscode
<a href="https://github.com/futurejones/code-oss-aarch64/blob/master/raspbian-buster-pi4/README.md">https://github.com/futurejones/code-oss-aarch64/blob/master/raspbian-buster-pi4/README.md</a></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># https://packagecloud.io/swift-arm/vscode, c'est dispo' pour buster maintenant
curl -s https://packagecloud.io/install/repositories/swift-arm/vscode/script.deb.sh | sudo bash
sudo apt-get install code-oss
</code></pre></div></div>

<p>Install Docker-ce
https://docs.docker.com/install/linux/docker-ce/debian/
https://download.docker.com/linux/debian/dists/buster/stable/</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt update
sudo apt-get install \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg2 \
    software-properties-common
curl -fsSL https://download.docker.com/linux/raspbian/gpg | sudo apt-key add -
echo "deb https://download.docker.com/linux/raspbian/ buster stable" &gt; /etc/apt/sources.list.d/docker.list
# ou dans /etc/apt/sources.list, rajouter la ligne deb [arch=arm64] https://download.docker.com/linux/raspbian/ buster stable
sudo apt update
sudo apt install docker-ce docker-compose docker-ce-cli containerd.io
</code></pre></div></div>
<p>le seul truc c’est que le package aufs-dkms essaie de s’installer en recommandé et plante sur le RPI. Mais ça n’affecte pas l’installation de Docker-CE. (à voir pour <code class="language-plaintext highlighter-rouge">sudo apt install --no-install-recommends docker-ce</code>, pas testé)</p>

<p>Je ferme la parenthèse pour Raspbian :)</p>

<p>&gt;</p>

<h1 id="premiers-pas">Premiers pas</h1>
<p>Pour info’, j’ai la version 4Go RAM du rpi4, avec un boitier ventilé (tout petit ventilo suffit, je tourne à 52°C en charge ~)</p>
<h2 id="install-ubuntu-server">Install Ubuntu Server</h2>
<p>Toutes les instructions sont là en fait : <a href="https://ubuntu.com/download/iot/raspberry-pi">Ubuntu</a>.</p>
<h3 id="petit-bug">Petit bug</h3>
<p><a href="https://bugs.launchpad.net/ubuntu/+source/linux-raspi2/+bug/1848703">bug (reconnu, officiel pour les 4Go RAM)</a> que j’ai rencontré : le clavier ne fonctionne pas (tout l’usb en fait)</p>

<p>Un peu embêtant sur une fresh install, j’en conviens. Premier truc à faire pour pallier (en attendant le patch sur l’image 19.10) :</p>
<ul>
  <li>soit, temporairement, rajouter une limite à la RAM (fonctionne j’ai testé). Il suffit de monter sa carte SD sur un autre pc, et de modifier un des fichiers config ex. <code class="language-plaintext highlighter-rouge">/boot/usercfg.txt</code>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total_mem=3072
</code></pre></div>    </div>
  </li>
  <li>soit, se passer dans un premier temps, des sorties usb. Il faut dans ce cas, connecter le rpi en ethernet sur sa box. Le DHCP fonctionne (pour moi en tous cas, il a eu une IP en auto’. Il suffit de se rendre sur l’admin de sa box et de regarder l’IP attribuée <a href="http://mafreebox.freebox.fr/#Fbx.os.app.settings.Dhcp">http://mafreebox.freebox.fr/#Fbx.os.app.settings.Dhcp</a>). Et se connecter en ssh (via Putty par ex. sur windows ou depuis un pc en linux)
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh ubuntu@192.168.1.17 # ou l'ip attribuée par le DHCP de la box # password: ubuntu
</code></pre></div>    </div>
  </li>
  <li>puis passer le patch (ne faites cette opération que si l’image n’a pas encore été patch ! pour info, ce billet date du 01.11.18)
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># il se peut que le paquet ait évolué, se rendre sur  https://people.canonical.com/~hwang4/rpiv2 pour lister les .deb</span>
wget https://people.canonical.com/~hwang4/rpiv2/arm64/linux-image-5.3.0-1008-raspi2_5.3.0-1008.9+newupdate_arm64.deb
wget https://people.canonical.com/~hwang4/rpiv2/arm64/linux-modules-5.3.0-1008-raspi2_5.3.0-1008.9+newupdate_arm64.deb
<span class="nb">sudo </span>dpkg <span class="nt">-i</span> linux-modules-5.3.0-1008-raspi2_5.3.0-1008.9+newupdate_arm64.deb
<span class="nb">sudo </span>dpkg <span class="nt">-i</span> linux-image-5.3.0-1008-raspi2_5.3.0-1008.9+newupdate_arm64.deb
<span class="nb">sudo </span>reboot
</code></pre></div>    </div>
    <p>ne pas oublier de supprimer la ligne <code class="language-plaintext highlighter-rouge">total_mem=3072</code> une fois patché.</p>
    <h3 id="first-thing-first">First Thing First</h3>
  </li>
  <li>modifier le clavier en français (utile quand on se connecte en direct clavier/hdmi) :
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>dpkg-reconfigure keyboard-configuration
<span class="nb">sudo </span>loadkeys fr
</code></pre></div>    </div>
  </li>
  <li>wifi : <a href="https://www.linuxbabe.com/ubuntu/connect-to-wi-fi-from-terminal-on-ubuntu-18-04-19-04-with-wpa-supplicant">https://www.linuxbabe.com/ubuntu/connect-to-wi-fi-from-terminal-on-ubuntu-18-04-19-04-with-wpa-supplicant</a></li>
</ul>

<p>Je mets les grandes lignes mais le mieux reste de suivre les instructions du lien ci-dessus</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt install wireless-tools
rfkill list # pour débloquer éventuellement le wifi du rpi
iwconfig # gives me
wlan0     IEEE 802.11  ESSID:off/any
          Mode:Managed  Access Point: Not-Associated
          Retry short limit:7   RTS thr:off   Fragment thr:off
          Power Management:on
sudo ip link set wlan0 up
sudo iwlist wlan0 scan | grep ESSID
  ESSID:"Freebox-XXXXXX"
sudo apt install wpasupplicant
wpa_passphrase "Freebox-XXXXXX" "clewifiwpa" | sudo tee /etc/wpa_supplicant.conf
sudo wpa_supplicant -B -c /etc/wpa_supplicant.conf -i wlan0
sudo dhclient wlan0
ip addr show
# wifi au boot
sudo cp /lib/systemd/system/wpa_supplicant.service /etc/systemd/system/wpa_supplicant.service
sudo vi /etc/systemd/system/wpa_supplicant.service
ExecStart=/sbin/wpa_supplicant -u -s -c /etc/wpa_supplicant.conf -i wlan0
#Alias=dbus-fi.w1.wpa_supplicant1.service
sudo systemctl enable wpa_supplicant.service
# dhcp client au boot pour l'interface wifi
sudo vi /etc/systemd/system/dhclient.service
[Unit]
Description= DHCP Client
Before=network.target
After=wpa_supplicant.service

[Service]
Type=simple
ExecStart=/sbin/dhclient wlan0

[Install]
WantedBy=multi-user.target
sudo systemctl enable dhclient.service

# rajout d'un serveur dns 
vi /etc/netplan/01-wifi.yaml
network:
    ethernets:
        wlan0:
            gateway4: 192.168.1.254
            nameservers:
                addresses: [192.168.1.254,8.8.8.8, 8.8.4.4]
            dhcp4: true
            dhcp6: true
    version: 2
sudo netplan apply
</code></pre></div></div>

<ul>
  <li>mise à jour : il est possible que ça soit fait en auto par la crontab (ça a été mon cas dès que j’ai branché le net). Sinon <code class="language-plaintext highlighter-rouge">sudo apt update &amp;&amp; sudo apt upgrade</code></li>
  <li>sécurité :
    <ul>
      <li>changer son password ubuntu (mais normalement c’est demandé lors de la première connexion)</li>
      <li>accès ssh avec clé uniquement (à noter que ça ne change rien à la connexion en direct sur le rpi) :
        <ul>
          <li>Créer un couple clé privé/publique avec PuttyGen (avec une passphrase, c’est mieux) <img src="https://virtual-thom.github.io/archives/wp-content/uploads/puttygen.png" alt="puttygen" /></li>
          <li>copier/coller la clé publique (ssh-rsa xxxxxx) dans <code class="language-plaintext highlighter-rouge">~/.ssh/authorized_keys</code> (attention ce fichier ne doit pas avoir de droits trop permissif, 600 c’est une valeur sûre)</li>
          <li>configurer <code class="language-plaintext highlighter-rouge">sudo vi /etc/ssh/sshd_config</code>
            <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#PubkeyAuthentication yes
PubkeyAuthentication yes
#PasswordAuthentication yes
PasswordAuthentication no
</code></pre></div>            </div>
            <p><code class="language-plaintext highlighter-rouge">sudo /etc/init.d/ssh restart</code></p>
          </li>
          <li>utiliser la clé privé lors de la connexion ssh <code class="language-plaintext highlighter-rouge">ssh -i chemin/cleprive.ppk ubunbut@192.168.1.17</code> ou dans les settings de Putty (Connection &gt; SSH &gt; Auth &gt; Browse Private key)</li>
        </ul>
      </li>
      <li>installer fail2ban <code class="language-plaintext highlighter-rouge">sudo apt install fail2ban</code></li>
    </ul>
  </li>
  <li>(optionnel) monter le nas freebox. Ca peut être très intéressant pour configurer un repository git perso, stocker des données, etc. :
    <ul>
      <li>activer le samba (<a href="https://www.youtube.com/watch?v=HAiHEQblKeQ">fusionné</a>) : <a href="http://mafreebox.freebox.fr/#Fbx.os.app.settings.ShareSamba">http://mafreebox.freebox.fr/#Fbx.os.app.settings.ShareSamba</a>
 <img src="https://virtual-thom.github.io/archives/wp-content/uploads/freebox_samba.png" alt="freebox_samba.png" /></li>
      <li>config fstab
        <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>cifs-utils
<span class="nb">sudo mkdir</span> /free
<span class="nb">sudo </span>vi /root/.smbcredentials
<span class="nv">username</span><span class="o">=</span>celuiquevousavezmisdanslapremiereetape
<span class="nv">password</span><span class="o">=</span>celuiquevousavezmisdanslapremiereetape
<span class="nb">sudo </span>vi /etc/fstab
//192.168.1.254/Disque<span class="se">\0</span>40dur /free cifs <span class="nv">credentials</span><span class="o">=</span>/root/.smbcredentials,uid<span class="o">=</span>0,gid<span class="o">=</span>0,vers<span class="o">=</span>1.0 0 0
</code></pre></div>        </div>
      </li>
      <li>tester avant de reboot
        <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>mount <span class="nt">-a</span>
</code></pre></div>        </div>
      </li>
    </ul>

    <p>c’est vraiment important car une erreur de syntaxe peut bloquer votre boot. Au cas où si ça vous arrive :</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>You can repair most such problems on the Pi by rebooting to a root shell.

Append init=/bin/sh at the end of cmdline.txt and reboot.
After booting you will be at the prompt in a root shell.
Your root file system is mounted as readonly now, so remount it as read/write
mount -n -o remount,rw /
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="installation-environnement-de-dev">Installation environnement de Dev</h2>
<h3 id="quelques-paquets-prérequis">Quelques paquets prérequis</h3>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="se">\</span>
    apt-transport-https <span class="se">\</span>
    ca-certificates <span class="se">\</span>
    curl <span class="se">\</span>
    software-properties-common
</code></pre></div></div>
<h3 id="nodejs">Nodejs</h3>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-sL</span> https://deb.nodesource.com/setup_13.x | <span class="nb">sudo</span> <span class="nt">-E</span> bash -
<span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> nodejs
</code></pre></div></div>
<h3 id="docker">Docker</h3>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg | <span class="nb">sudo </span>apt-key add 
<span class="c"># la version Ubutun 19.10 Eoan n'existe pas à l'heure où j'écris mais la 19.04 Disco fonctionne chez moi</span>
<span class="nb">sudo </span>add-apt-repository <span class="se">\</span>
   <span class="s2">"deb https://download.docker.com/linux/ubuntu </span><span class="se">\</span><span class="s2">
   disco </span><span class="se">\</span><span class="s2">
   stable"</span>
<span class="c"># vérifier dans /etc/apt/sources.list que la ligne a été ajoutée</span>
<span class="nb">sudo </span>apt udpate 
<span class="nb">sudo </span>apt <span class="nb">install </span>docker-ce
<span class="nb">sudo </span>apt <span class="nb">install </span>docker-compose
</code></pre></div></div>
<h3 id="visual-studio-code-insiders">Visual Studio Code Insiders</h3>
<p>S’il y a bien un truc qui rox, c’est ça. Et ça ne voulait pas fonctionner avec la Raspbian pour une raison qui m’échappe.</p>

<p>Là, tout fonctionne (répertoire à distance, gestion du git, docker etc) ! On dev à distance sur le rpi depuis un autre poste avec <a href="https://code.visualstudio.com/insiders/">Visual Studio Code Insiders</a></p>

<p>config .ssh/config sur votre poste :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Host rpi
    User ubuntu
    HostName 192.168.1.17
    IdentityFile d:/cle/rpi_priv
</code></pre></div></div>

<p>Attention, il faut deux choses importantes :</p>
<ul>
  <li>le fichier en format PuttyGen .ppk ne fonctionne pas, il faut l’exporter (vraiment mettez une passephrase sur votre clé). Depuis PuttyGen &gt; menu Conversions &gt; Exporter Open SSH key d:/cle/rpi_priv</li>
  <li>ce fichier (cle_priv) doit être sécurisé et accessbile uniquement à vous (600 en windows c’est : Clique droit &gt; Propriétés &gt; Sécurité &gt; Avancé &gt; Désactiver l’héritage &gt; supprimer tout &gt; ne rajouter que votre utilisateur en control total)</li>
</ul>

<h1 id="mon-premier-projet-avec-docker">Mon premier projet avec Docker</h1>
<h2 id="dépôt-de-partage-git-sur-le-nas-de-la-freebox">Dépôt de partage git sur le NAS de la Freebox</h2>

<p>Juste parce que ça peut être sympa d’avoir plusieurs remote (un sur github et un sur le NAS par exemple). Ou si on ne veut pas partager son code en phase de Dev, on le garde en local + NAS de la Box (sans faire de pub, la freebox est vraiment pas mal pour ça, assez rapide et capacité correcte).</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /free
<span class="nb">sudo mkdir </span>git
<span class="nb">cd </span>git
<span class="nb">sudo </span>git init <span class="nt">--shared</span> <span class="nt">--bare</span> monpremierprojet.git
Initialized empty shared Git repository <span class="k">in</span> /free/git/monpremierprojet.git/
</code></pre></div></div>
<h2 id="init-projet-docker-pour-un-paysage-varié-bdd-front-api-traefik-pour-le-reverse-proxy-et-lets-encrypt-https">init projet (docker pour un paysage varié bdd, front, api, traefik pour le reverse proxy et let’s encrypt https)</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~
git clone /free/git/monpremierprojet.git
<span class="nb">cd </span>monpremierprojet
<span class="c"># ou sur un projet déjà existant</span>
<span class="nb">cd</span> ~/monprojetexistant
git init
git remote add origin /free/git/monpremierprojet.git
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">vi Dockerfile-alpine-nodejs</code></p>
<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> alpine:latest</span>
<span class="k">RUN </span>apk add <span class="nt">--no-cache</span> npm
</code></pre></div></div>

<p>Le traefik a un point d’entrée (:80). Ma box redirige évidemment le port 80 vers le port 80 de mon rpi.</p>

<p>Le traefik se charge ensuite de rediriger en interne les flux et agit comme un reverse proxy.</p>

<p><code class="language-plaintext highlighter-rouge">vi docker-compose.yml</code></p>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>

<span class="na">networks</span><span class="pi">:</span>
  <span class="na">default</span><span class="pi">:</span>
  <span class="na">traefik_proxy</span><span class="pi">:</span>
    <span class="na">external</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">traefik_proxy</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">traefik</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">traefik:v2.0</span>
    <span class="na">command</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">--providers.docker=true</span>
      <span class="pi">-</span> <span class="s">--providers.docker.exposedByDefault=false</span>
      <span class="pi">-</span> <span class="s">--entrypoints.web.address=:80</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8383:80"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./acme.json:/acme.json</span>
      <span class="pi">-</span> <span class="s">/var/run/docker.sock:/var/run/docker.sock:ro</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">default</span>
      <span class="pi">-</span> <span class="s">traefik_proxy</span>

  <span class="na">front</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">node</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./front:/app/front</span>
    <span class="na">working_dir</span><span class="pi">:</span> <span class="s">/app/front</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">npm run dev</span> 
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">traefik_proxy</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">traefik.docker.network=traefik_proxy</span>
      <span class="pi">-</span> <span class="s">traefik.http.services.front.loadbalancer.server.port=1234</span>
      <span class="pi">-</span> <span class="s">traefik.enable=true</span>
      <span class="pi">-</span> <span class="s">traefik.http.routers.front.rule=Host(`monsiteperso.hd.free.fr`)</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">api</span> 

  <span class="na">nodebb</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nodebb:thomas</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./nodebb:/app/nodebb</span>
    <span class="na">working_dir</span><span class="pi">:</span> <span class="s">/app/nodebb</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">./nodebb dev</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">traefik_proxy</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">traefik.docker.network=traefik_proxy</span>
      <span class="pi">-</span> <span class="s">traefik.http.services.nodebb.loadbalancer.server.port=4567</span>
      <span class="pi">-</span> <span class="s">traefik.enable=true</span>
      <span class="pi">-</span> <span class="s">traefik.http.routers.nodebb.rule=Host(`monsiteperso.hd.free.fr`) &amp;&amp; PathPrefix(`/forum`)</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">mongo</span> 

  <span class="na">api</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s">.</span>
      <span class="na">dockerfile</span><span class="pi">:</span> <span class="s">Dockerfile-alpine-nodejs</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">alpine:nodejs</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./api:/app/api</span>
    <span class="na">working_dir</span><span class="pi">:</span> <span class="s">/app/api</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">npm run start</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">traefik_proxy</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">traefik.docker.network=traefik_proxy</span>
      <span class="pi">-</span> <span class="s">traefik.http.services.api.loadbalancer.server.port=2345</span>
      <span class="pi">-</span> <span class="s">traefik.enable=true</span>
      <span class="pi">-</span> <span class="s">traefik.http.routers.api.rule=Host(`monsiteperso.hd.free.fr`) &amp;&amp; PathPrefix(`/api`)</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">mongo</span>
  
  <span class="na">apiv2</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s">.</span>
      <span class="na">dockerfile</span><span class="pi">:</span> <span class="s">Dockerfile-alpine-nodejs</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">alpine:nodejs</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./apiv2:/app/api</span>
    <span class="na">working_dir</span><span class="pi">:</span> <span class="s">/app/api</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">npm run start</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">traefik_proxy</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">traefik.docker.network=traefik_proxy</span>
      <span class="pi">-</span> <span class="s">traefik.http.services.apiv2.loadbalancer.server.port=3456</span>
      <span class="pi">-</span> <span class="s">traefik.enable=true</span>
      <span class="pi">-</span> <span class="s">traefik.http.routers.apiv2.rule=Host(`monsiteperso.hd.free.fr`) &amp;&amp; PathPrefix(`/apiv2`)</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">mongo</span>

  <span class="na">mongo</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">mongo</span> 
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">traefik_proxy</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">traefik.docker.network=traefik_proxy</span>
      <span class="pi">-</span> <span class="s">traefik.http.services.mongo.loadbalancer.server.port=27017</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./mongod.conf:/etc/mongod.conf</span>
      <span class="pi">-</span> <span class="s">./data/db:/data/db</span>
      <span class="pi">-</span> <span class="s">./data/configdb:/data/configdb</span>

<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">mongo</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">local</span>
  <span class="na">api</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">local</span>
  <span class="na">front</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">local</span>
  <span class="na">nodebb</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">local</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker-compose up
</code></pre></div></div>

<h1 id="pour-en-faire-un-pc-de-bureau">Pour en faire un pc de bureau</h1>
<p>Attention 3,5 Go en plus
<code class="language-plaintext highlighter-rouge">sudo apt-get install lubuntu-desktop</code></p>

  </article>
  
<nav>
  <ul class="pager">
    
     
    <li class="previous">
      <a href="https://virtual-thom.github.io/archives/list-job-parent-vtom-xsl/"><span aria-hidden="true">&larr;</span> Lister des jobs VTOM avec un vtexport xml et un filtre XSL (another one)</a> 
    </li>
    
     
     <li class="next">
      <a class="next" href="https://virtual-thom.github.io/archives/netlify-deploiement-continu/">Netlify déploiement continu gratuit <span aria-hidden="true">&rarr;</span></a> 
    </li>
     
    
  </ul>
</nav>


  <footer class="post-footer">
    
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>rpi</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>raspberry pi</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>rpi 4</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>docker</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>devOps</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>nodejs</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>parcel</a>
      
    
    <span  itemprop="author publisher" class="hidden">Virtual Thom</span>
  </footer>
  
  <div id="disqus_thread" ></div>
  <script>
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'thomas-asnar'; // required: replace example with your forum shortname
  
      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
</div>

      <footer id="site-footer">
    <div>&copy;<a href="https://github.com/virtual-thom/" title="Github Virtual-Thom">Virtual-Thom</a></div>
    <div>
            <a href="https://virtual-thom.github.io/archives/plan" title="Plan du site">sitemap</a> | <a href="https://virtual-thom.github.io/about" rel="publisher author" title="Curriculum vitae Thom">A propos</a>
    </div>
    <div>
        <a id="goto-site-header" href="#site-header" title="Retourner au début">&uArr; Top</a>
    </div>
    <div id="footer-disclaimer">
        <p>Avertissement : vous ne devez pas prendre pour argent comptant le contenu de ce site. Testez toujours la solution en environnement de test.</p>
        <p>Malgré le sérieux que je m'efforce de mettre dans le contenu de ces billets, je ne pourrai être tenu responsable d'éventuelles erreurs que cela pourrait engendrer.</p>
    </div>
    <div>
        <a class="hidden" href="https://virtual-thom.github.io/archives/sitemap.xml" title="SiteMap">sitemap</a>
    </div>
</footer>

    </div>
  </body>

</html>