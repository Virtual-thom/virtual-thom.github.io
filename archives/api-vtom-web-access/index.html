<!DOCTYPE html>
<html lang="fr">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="apple-touch-icon" href="https://virtual-thom.github.io/archives/apple-touch-icon.png">
  <link rel="icon" href="https://virtual-thom.github.io/archives/favicon.ico" />
  <!-- Remplacé par Jekyll SEO (sinon apparait en double)
  <title>API VTOM webaccess</title>
  <meta name="description" content="Vous n’êtes pas sans savoir que VTOM fournit, depuis quelques versions maintenant, un webaccess (un portail web d’accès à VTOM / vthttpd).Sur une question de...">
  --> 
  
  <link rel="canonical" href="https://virtual-thom.github.io/archives/api-vtom-web-access/">
  
  <link rel="stylesheet" media="screen" href="https://virtual-thom.github.io/archives/assets/main.css">
  
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>API VTOM webaccess | Virtual-Thom Blog-notes VTOM et informatique</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="API VTOM webaccess" />
<meta name="author" content="Virtual Thom" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Vous n’êtes pas sans savoir que VTOM fournit, depuis quelques versions maintenant, un webaccess (un portail web d’accès à VTOM / vthttpd). Sur une question de Stephane, je me suis penché sur son fonctionnement. Voici quelques API VTOM glannées dans les pages du webaccess. Peu importe comment vous y accédez, ici en curl (user:passwd à changer) mais on peut très bien faire ça avec POSTMAN. Liste de tous les environnements curl -k -u user:passwd &quot;http://localhost:30080/api/environment/list&quot; -X GET | python -m json.tool Liste de toutes les applications curl -k -u user:passwd &quot;http://localhost:30080/api/application/list&quot; -X GET | python -m json.tool curl -k -u user:passwd &quot;http://localhost:30080/api/application/list?envSId=ENV7f00000102a3106054b8e57700000014&quot; -X GET | python -m json.tool curl -k -u user:passwd &quot;http://localhost:30080/api/application/list?environmentName=VAGUE5_INT&quot; -X GET | python -m json.tool Liste de tous les jobs curl -k -u user:passwd &quot;http://localhost:30080/api/job/list&quot; -X GET | python -m json.tool curl -k -u user:passwd &quot;http://localhost:30080/api/job/list?appSId=APP7f00000129a98189539f1cb000000023&quot; -X GET | python -m json.tool curl -k -u user:passwd &quot;http://localhost:30080/api/job/list?applicationName=BASCULE_DATE&quot; -X GET | python -m json.tool Détails d’un job curl -k -u user:passwd &quot;http://localhost:30080/api/job/getById?id=JOB7f0000012b10ca88539f1cb4000000c2&quot; -X GET | python -m json.tool Détails de tous les jobs (ou autres items) curl -k -u user:passwd &quot;http://localhost:30080/api/job/getAll&quot; -X GET | python -m json.tool Exemple de résultat { &quot;rc&quot;: 0, &quot;result&quot;: { &quot;ExpectedContexts&quot;: [], &quot;ExpectedResources&quot;: [], &quot;Script&quot;: &quot;D:\\Script\\rotation_log_dxserver\\Rotate_log_dxserver.bat&quot;, &quot;appInErr&quot;: &quot;1&quot;, &quot;applicationSId&quot;: &quot;APP7f00000129a98189539f1cb000000023&quot;, &quot;blockDate&quot;: &quot;0&quot;, &quot;cycle&quot;: &quot;00:00:00&quot;, &quot;cycleEnabled&quot;: &quot;0&quot;, &quot;descOnErr&quot;: &quot;0&quot;, &quot;exploited&quot;: &quot;E&quot;, &quot;frequency&quot;: &quot;D&quot;, &quot;id&quot;: &quot;JOB7f0000012b10ca88539f1cb4000000c2&quot;, &quot;information&quot;: &quot; &quot;, &quot;isAsked&quot;: &quot;0&quot;, &quot;maxStart&quot;: &quot;37:59:00&quot;, &quot;minStart&quot;: &quot;25:30:00&quot;, &quot;mode&quot;: &quot;E&quot;, &quot;movementTime&quot;: &quot;0&quot;, &quot;name&quot;: &quot;ROT_LOG_DXSERVER&quot;, &quot;onDemand&quot;: &quot;0&quot;, &quot;restartCount&quot;: &quot;0&quot;, &quot;restartLabel&quot;: &quot;0&quot;, &quot;restartMax&quot;: &quot;1&quot;, &quot;restartType&quot;: &quot;M&quot;, &quot;retained&quot;: &quot;0&quot;, &quot;retcode&quot;: &quot;-1&quot;, &quot;status&quot;: &quot;W&quot;, &quot;timeBegin&quot;: &quot;1421112600&quot;, &quot;timeEnd&quot;: &quot;1421112630&quot;, &quot;xid&quot;: &quot;JOBc2&quot; } } On a vérifié avec Stephane, les attributs sont hiérarchisés comme dans le vtexport xml (si pas dans Job, on remonte dans Application, si pas dans Application, on remonte sur Environnement). carrément le contenu du script !!! curl -k -u user:passwd &quot;http://localhost:30080/api/job/getScript?id=JOB7f0000012b10ca88539f1cb4000000c2&quot; -X GET | python -m json.tool Liste des Logs (utiliser le job xid et non l’id tout court) curl -k -u user:passwd &quot;http://localhost:30080/api/log/getLogList?id=JOBc2&quot; -X GET | python -m json.tool Si je résume : Pour avoir toutes les informations détaillées d&#39;un ensemble d&#39;items (environment, application, job, date, host, instruction - pour info instruction c&#39;est les consignes - etc) http://localhost:30080/api/&lt;item&gt;/getAll Pour avoir toute la liste d&#39;un ensemble d&#39;items mais avec moins de détails http://localhost:30080/api/&lt;item&gt;/list Pour avoir le détail d&#39;un item en particulier http://localhost:30080/api/&lt;item&gt;/getById?id=&lt;id&gt; Pour filtrer la liste d&#39;un ensemble d&#39;item sur un attribut particulier http://localhost:30080/api/&lt;item&gt;/list?&lt;attribut&gt;=&lt;valeur&gt; Si l&#39;attribut n&#39;est pas présent dans l&#39;item le plus bas (job), il faut remonter d&#39;un cran (application) et encore d&#39;un cran si besoin (environment). Notion de hiérarchie, notamment pour les dates, host, queue, user. On peut aussi utiliser cette méthode pour s’authentifier, en passant par le header http : # echo -n &quot;user:password&quot; | base64, ici TOM:TOM curl -H &#39;Authorization: Basic VE9NOlRPTQ==&#39; On peut aussi se pré-authentifier avec /api/utilities/login POST { login: “xxx”, password: “xxx” }. Ca renvoie un cookie avec vtsession et webdoc_account_id qu’il faudra rajouter aux futures requêtes. Ce qui est bien avec cette méthode, c’est que les utilisateurs LDAP passent, alors que l’Authorization Basic ne fonctionne qu’avec des utilisateurs “locaux”. Vous en voulez plus ? Aucune doc Absyss ne référence toutes les APIs. Donc petite astuce : Ouvrez votre navigateur Chrome F12 et aller dans l’onglet Network pour voir les appels aux API. Baladez vous sur l’interface Web du web access et glannez les différentes adresses et requêtes XHR. Petite astuce côté client pour effectuer une request REST sur l’api VTOM sans utiliser jQuery var serveurVtom = &quot;http://monserveurvtom:30080&quot; ; var xhr = new XMLHttpRequest(); xhr.onreadystatechange = function(){ var status = xhr.status; if (status == 200) { if(xhr.response != null) { // toute la réponse avec les columns et les rows console.log( xhr.response ) ; // on récupère le nom par exemple et on l&#39;affiche dans la console xhr.response.result.rows.forEach(function(entry){ console.log(entry.name); }); } } else { console.log(&quot;error&quot;); console.log(status); } } xhr.open(&#39;GET&#39;, serveurVtom + &#39;/api/job/list&#39;); xhr.responseType = &#39;json&#39;; // attention sous unix echo &quot;user:passwdord&quot; | base64 interprète le saut de ligne du echo et vous donne une mauvaise authentification // il faut utiliser l&#39;option -n, echo -n &quot;user:password&quot; | base64 // on peut utiliser un encodage base64 via javascript directement mais dans ce cas le user:mdp est en clair dans le code // ex. VE9NOlRPTQ== =&gt; base64 pour TOM:TOM xhr.setRequestHeader(&#39;Authorization&#39;, &#39;Basic VE9NOlRPTQ==&#39;); xhr.send(); Un exemple pour lister tous les jobs, il faut changer l’ip, le port et encoder le user:password &lt;html lang=fr&quot;&gt; &lt;head&gt; &lt;meta charset=&quot;utf-8&quot; /&gt; &lt;/head&gt; &lt;body&gt; &lt;button id=&quot;refresh-button&quot;&gt;Refresh&lt;/button&gt; &lt;table id=&quot;list-jobs&quot;&gt;&lt;/table&gt; &lt;script&gt; // Variables Globales var serveurVtom = &quot;http://192.168.99.100:30080&quot; ; // A changer ! var authVtom = &quot;VE9NOlRPTQ==&quot; ; //base64 user:password var itemsVtom = [ &quot;environment&quot;, &quot;application&quot;, &quot;job&quot;, &quot;date&quot;, &quot;host&quot;, &quot;queue&quot; ] ; itemsVtom.forEach(function(item){ eval(&quot;window.API_&quot; + item + &quot;_LIST = null ;&quot;) ; }); // Fonctions function findItemById(source, id){ return source.filter(function( obj ) { return obj.id == id; })[ 0 ]; } function debutAffichage(){ window.API_job_LIST.result.forEach(function(entry){ var application = findItemById(window.API_application_LIST.result, entry.applicationSId) ; var environment = findItemById(window.API_environment_LIST.result, application.environmentSId) ; var host = findItemById(window.API_host_LIST.result, entry.host) ; if(!host){ var host = findItemById(window.API_host_LIST.result, application.host) ; if(!host){ var host = findItemById(window.API_host_LIST.result, environment.host) ; } } var dateVtom = findItemById(window.API_date_LIST.result, entry.date) ; if(!dateVtom){ var dateVtom = findItemById(window.API_date_LIST.result, application.date) ; if(!dateVtom){ var dateVtom = findItemById(window.API_date_LIST.result, environment.date) ; } } var queue = findItemById(window.API_queue_LIST.result, entry.queue) ; if(!queue){ var queue = findItemById(window.API_queue_LIST.result, application.queue) ; if(!queue){ var queue = findItemById(window.API_queue_LIST.result, environment.queue) ; } } var tableListJobs = document.querySelector(&#39;table#list-jobs&#39;) ; var this_tr = document.createElement(&quot;tr&quot;); this_tr.innerHTML = &quot;&lt;td&gt;&quot; + environment.name + &quot;&lt;/td&gt;&quot; + &quot;&lt;td&gt;&quot; + application.name + &quot;&lt;/td&gt;&quot; + &quot;&lt;td&gt;&quot; + entry.name + &quot;&lt;/td&gt;&quot; + &quot;&lt;td&gt;&quot; + dateVtom.name + &quot;&lt;/td&gt;&quot; + &quot;&lt;td&gt;&quot; + queue.name + &quot;&lt;/td&gt;&quot; + &quot;&lt;td&gt;&quot; + host.name + &quot;&lt;/td&gt;&quot; + &quot;&lt;td&gt;&quot; + entry.Script + &quot;&lt;/td&gt;&quot; ; if(entry.Parameters){ this_tr.innerHTML = this_tr.innerHTML + &quot;&lt;td&gt;&quot; ; entry.Parameters.forEach(function(parameter){ this_tr.innerHTML = this_tr.innerHTML + parameter + &quot;&lt;br&gt;&quot; ; }); this_tr.innerHTML = this_tr.innerHTML + &quot;&lt;/td&gt;&quot; ; } tableListJobs.appendChild(this_tr); }); //eof foreach job list } // eof debutAffichage function getItemsVtom(){ if(typeof(Storage) !== &quot;undefined&quot;) { var isAllItemsInStorage = true ; itemsVtom.forEach(function(item){ if(sessionStorage[&quot;API_&quot;+item+&quot;_LIST&quot;]){ eval(&#39;window.API_&#39;+item+&#39;_LIST = JSON.parse(sessionStorage.getItem(&quot;API_&#39;+item+&#39;_LIST&quot;)) ;&#39;) ; }else{ isAllItemsInStorage = false ; } }); if(! isAllItemsInStorage){ getItemsVtomAPI() ; } }else{ getItemsVtomAPI() ; } } // eof getItemsVtom function removeItemsFromSessionStorage(){ itemsVtom.forEach(function(item){ sessionStorage.removeItem(&quot;API_&quot;+item+&quot;_LIST&quot;); }); } // http://www.html5rocks.com/en/tutorials/cors/ // cross domain function getItemsVtomAPI(){ itemsVtom.forEach(function(item){ eval(&#39;var xhr&#39;+item+&#39; = new XMLHttpRequest();&#39;) ; var strCode = &#39;xhr&#39;+item+&#39;.onreadystatechange = function(){&#39; + &#39;var status = xhr&#39;+item+&#39;.status;&#39; + &#39;if (status == 200) {&#39;+ &#39;if(xhr&#39;+item+&#39;.response != null) {&#39; + &#39;window.API_&#39;+item+&#39;_LIST = xhr&#39;+item+&#39;.response ;&#39; + &#39;if(typeof(Storage) !== &quot;undefined&quot;) {&#39; + &#39;sessionStorage.setItem(&quot;API_&#39;+item+&#39;_LIST&quot;,JSON.stringify(window.API_&#39;+item+&#39;_LIST)) ;&#39; + &#39;}&#39; + &#39;}&#39; + &#39;}&#39; + &#39;}&#39; ; eval(strCode); eval(&#39;xhr&#39;+item+&quot;.open(&#39;GET&#39;, serveurVtom + &#39;/api/&quot;+item+&quot;/getAll&#39;,true);&quot;) ; eval(&#39;xhr&#39;+item+&quot;.responseType = &#39;json&#39;;&quot;) ; eval(&#39;xhr&#39;+item+&quot;.setRequestHeader(&#39;Authorization&#39;, &#39;Basic &#39; + authVtom);&quot;); eval(&#39;xhr&#39;+item+&#39;.send();&#39;) ; }); } // eof getItemsVtomAPI // On récupère les items getItemsVtom() ; function _isAllItemsLoaded(){ console.log((new Date()).getTime()); // debug to make sure we pass through this var isAllItemsLoaded = true ; itemsVtom.forEach(function(item){ if(eval(&#39;window.API_&#39;+item+&#39;_LIST&#39;) == null){ isAllItemsLoaded = false ; }else if(eval(&#39;window.API_&#39;+item+&#39;_LIST.rc&#39;) == 4){ isAllItemsLoaded = false ; console.log(eval(&#39;window.API_&#39;+item+&#39;_LIST.errmsg&#39;)) ; clearInterval(window.intervalDebutAffichage); } }); if( isAllItemsLoaded ) { console.log(&quot;loaded&quot;); // debug to make sure we pass through this clearInterval(window.intervalDebutAffichage); debutAffichage(); return true ; }else{ return false ; } } if(! _isAllItemsLoaded()){ // si les items ne sont pas chargés au démarrage, on lance une boucle interval // On vérifie qu&#39;on a bien chargé toutes les données, on affiche quand c&#39;est ok window.intervalDebutAffichage = setInterval(_isAllItemsLoaded,1000); // quoi qu&#39;il arrive on sort de la boucle au bout de x secondes setTimeout(function(){ clearInterval(window.intervalDebutAffichage); }, 60000); } // Events // Refresh data document.querySelector(&#39;#refresh-button&#39;).addEventListener(&#39;click&#39;,function(e){ removeItemsFromSessionStorage(); window.location = window.location ; }) ; &lt;/script&gt; &lt;/body&gt; &lt;/html&gt; Bon évidemment ça ne donnera rien mais importer cette page chez vous, et changer l’IP, le port et le mot de passe pour que ça fonctionne. Exemple pour lister toutes les consignes # on récupère les données en JSON depuis l&#39;API web access VTOM curl -k -u user:passwd &quot;http://localhost:30080/api/instruction/getAll &gt; /var/tmp/instructions.json # on créé le script qui va générer les consignes au format HTML vi /var/tmp/create_instructions_html.py #!/usr/bin/python import json import sys import io jdata = open(sys.argv[1]) data = json.load(jdata) for result in data[&quot;result&quot;]: with io.open(result[&quot;name&quot;] + &quot;.html&quot;, &quot;w&quot;, encoding=&#39;utf-8&#39;) as f: f.write(result[&quot;content&quot;]) f.close() jdata.close() # On exécute le script chmod +x /var/tmp/create_instructions_html.py /var/tmp/create_instructions_html.py /var/tmp/instructions.json" />
<meta property="og:description" content="Vous n’êtes pas sans savoir que VTOM fournit, depuis quelques versions maintenant, un webaccess (un portail web d’accès à VTOM / vthttpd). Sur une question de Stephane, je me suis penché sur son fonctionnement. Voici quelques API VTOM glannées dans les pages du webaccess. Peu importe comment vous y accédez, ici en curl (user:passwd à changer) mais on peut très bien faire ça avec POSTMAN. Liste de tous les environnements curl -k -u user:passwd &quot;http://localhost:30080/api/environment/list&quot; -X GET | python -m json.tool Liste de toutes les applications curl -k -u user:passwd &quot;http://localhost:30080/api/application/list&quot; -X GET | python -m json.tool curl -k -u user:passwd &quot;http://localhost:30080/api/application/list?envSId=ENV7f00000102a3106054b8e57700000014&quot; -X GET | python -m json.tool curl -k -u user:passwd &quot;http://localhost:30080/api/application/list?environmentName=VAGUE5_INT&quot; -X GET | python -m json.tool Liste de tous les jobs curl -k -u user:passwd &quot;http://localhost:30080/api/job/list&quot; -X GET | python -m json.tool curl -k -u user:passwd &quot;http://localhost:30080/api/job/list?appSId=APP7f00000129a98189539f1cb000000023&quot; -X GET | python -m json.tool curl -k -u user:passwd &quot;http://localhost:30080/api/job/list?applicationName=BASCULE_DATE&quot; -X GET | python -m json.tool Détails d’un job curl -k -u user:passwd &quot;http://localhost:30080/api/job/getById?id=JOB7f0000012b10ca88539f1cb4000000c2&quot; -X GET | python -m json.tool Détails de tous les jobs (ou autres items) curl -k -u user:passwd &quot;http://localhost:30080/api/job/getAll&quot; -X GET | python -m json.tool Exemple de résultat { &quot;rc&quot;: 0, &quot;result&quot;: { &quot;ExpectedContexts&quot;: [], &quot;ExpectedResources&quot;: [], &quot;Script&quot;: &quot;D:\\Script\\rotation_log_dxserver\\Rotate_log_dxserver.bat&quot;, &quot;appInErr&quot;: &quot;1&quot;, &quot;applicationSId&quot;: &quot;APP7f00000129a98189539f1cb000000023&quot;, &quot;blockDate&quot;: &quot;0&quot;, &quot;cycle&quot;: &quot;00:00:00&quot;, &quot;cycleEnabled&quot;: &quot;0&quot;, &quot;descOnErr&quot;: &quot;0&quot;, &quot;exploited&quot;: &quot;E&quot;, &quot;frequency&quot;: &quot;D&quot;, &quot;id&quot;: &quot;JOB7f0000012b10ca88539f1cb4000000c2&quot;, &quot;information&quot;: &quot; &quot;, &quot;isAsked&quot;: &quot;0&quot;, &quot;maxStart&quot;: &quot;37:59:00&quot;, &quot;minStart&quot;: &quot;25:30:00&quot;, &quot;mode&quot;: &quot;E&quot;, &quot;movementTime&quot;: &quot;0&quot;, &quot;name&quot;: &quot;ROT_LOG_DXSERVER&quot;, &quot;onDemand&quot;: &quot;0&quot;, &quot;restartCount&quot;: &quot;0&quot;, &quot;restartLabel&quot;: &quot;0&quot;, &quot;restartMax&quot;: &quot;1&quot;, &quot;restartType&quot;: &quot;M&quot;, &quot;retained&quot;: &quot;0&quot;, &quot;retcode&quot;: &quot;-1&quot;, &quot;status&quot;: &quot;W&quot;, &quot;timeBegin&quot;: &quot;1421112600&quot;, &quot;timeEnd&quot;: &quot;1421112630&quot;, &quot;xid&quot;: &quot;JOBc2&quot; } } On a vérifié avec Stephane, les attributs sont hiérarchisés comme dans le vtexport xml (si pas dans Job, on remonte dans Application, si pas dans Application, on remonte sur Environnement). carrément le contenu du script !!! curl -k -u user:passwd &quot;http://localhost:30080/api/job/getScript?id=JOB7f0000012b10ca88539f1cb4000000c2&quot; -X GET | python -m json.tool Liste des Logs (utiliser le job xid et non l’id tout court) curl -k -u user:passwd &quot;http://localhost:30080/api/log/getLogList?id=JOBc2&quot; -X GET | python -m json.tool Si je résume : Pour avoir toutes les informations détaillées d&#39;un ensemble d&#39;items (environment, application, job, date, host, instruction - pour info instruction c&#39;est les consignes - etc) http://localhost:30080/api/&lt;item&gt;/getAll Pour avoir toute la liste d&#39;un ensemble d&#39;items mais avec moins de détails http://localhost:30080/api/&lt;item&gt;/list Pour avoir le détail d&#39;un item en particulier http://localhost:30080/api/&lt;item&gt;/getById?id=&lt;id&gt; Pour filtrer la liste d&#39;un ensemble d&#39;item sur un attribut particulier http://localhost:30080/api/&lt;item&gt;/list?&lt;attribut&gt;=&lt;valeur&gt; Si l&#39;attribut n&#39;est pas présent dans l&#39;item le plus bas (job), il faut remonter d&#39;un cran (application) et encore d&#39;un cran si besoin (environment). Notion de hiérarchie, notamment pour les dates, host, queue, user. On peut aussi utiliser cette méthode pour s’authentifier, en passant par le header http : # echo -n &quot;user:password&quot; | base64, ici TOM:TOM curl -H &#39;Authorization: Basic VE9NOlRPTQ==&#39; On peut aussi se pré-authentifier avec /api/utilities/login POST { login: “xxx”, password: “xxx” }. Ca renvoie un cookie avec vtsession et webdoc_account_id qu’il faudra rajouter aux futures requêtes. Ce qui est bien avec cette méthode, c’est que les utilisateurs LDAP passent, alors que l’Authorization Basic ne fonctionne qu’avec des utilisateurs “locaux”. Vous en voulez plus ? Aucune doc Absyss ne référence toutes les APIs. Donc petite astuce : Ouvrez votre navigateur Chrome F12 et aller dans l’onglet Network pour voir les appels aux API. Baladez vous sur l’interface Web du web access et glannez les différentes adresses et requêtes XHR. Petite astuce côté client pour effectuer une request REST sur l’api VTOM sans utiliser jQuery var serveurVtom = &quot;http://monserveurvtom:30080&quot; ; var xhr = new XMLHttpRequest(); xhr.onreadystatechange = function(){ var status = xhr.status; if (status == 200) { if(xhr.response != null) { // toute la réponse avec les columns et les rows console.log( xhr.response ) ; // on récupère le nom par exemple et on l&#39;affiche dans la console xhr.response.result.rows.forEach(function(entry){ console.log(entry.name); }); } } else { console.log(&quot;error&quot;); console.log(status); } } xhr.open(&#39;GET&#39;, serveurVtom + &#39;/api/job/list&#39;); xhr.responseType = &#39;json&#39;; // attention sous unix echo &quot;user:passwdord&quot; | base64 interprète le saut de ligne du echo et vous donne une mauvaise authentification // il faut utiliser l&#39;option -n, echo -n &quot;user:password&quot; | base64 // on peut utiliser un encodage base64 via javascript directement mais dans ce cas le user:mdp est en clair dans le code // ex. VE9NOlRPTQ== =&gt; base64 pour TOM:TOM xhr.setRequestHeader(&#39;Authorization&#39;, &#39;Basic VE9NOlRPTQ==&#39;); xhr.send(); Un exemple pour lister tous les jobs, il faut changer l’ip, le port et encoder le user:password &lt;html lang=fr&quot;&gt; &lt;head&gt; &lt;meta charset=&quot;utf-8&quot; /&gt; &lt;/head&gt; &lt;body&gt; &lt;button id=&quot;refresh-button&quot;&gt;Refresh&lt;/button&gt; &lt;table id=&quot;list-jobs&quot;&gt;&lt;/table&gt; &lt;script&gt; // Variables Globales var serveurVtom = &quot;http://192.168.99.100:30080&quot; ; // A changer ! var authVtom = &quot;VE9NOlRPTQ==&quot; ; //base64 user:password var itemsVtom = [ &quot;environment&quot;, &quot;application&quot;, &quot;job&quot;, &quot;date&quot;, &quot;host&quot;, &quot;queue&quot; ] ; itemsVtom.forEach(function(item){ eval(&quot;window.API_&quot; + item + &quot;_LIST = null ;&quot;) ; }); // Fonctions function findItemById(source, id){ return source.filter(function( obj ) { return obj.id == id; })[ 0 ]; } function debutAffichage(){ window.API_job_LIST.result.forEach(function(entry){ var application = findItemById(window.API_application_LIST.result, entry.applicationSId) ; var environment = findItemById(window.API_environment_LIST.result, application.environmentSId) ; var host = findItemById(window.API_host_LIST.result, entry.host) ; if(!host){ var host = findItemById(window.API_host_LIST.result, application.host) ; if(!host){ var host = findItemById(window.API_host_LIST.result, environment.host) ; } } var dateVtom = findItemById(window.API_date_LIST.result, entry.date) ; if(!dateVtom){ var dateVtom = findItemById(window.API_date_LIST.result, application.date) ; if(!dateVtom){ var dateVtom = findItemById(window.API_date_LIST.result, environment.date) ; } } var queue = findItemById(window.API_queue_LIST.result, entry.queue) ; if(!queue){ var queue = findItemById(window.API_queue_LIST.result, application.queue) ; if(!queue){ var queue = findItemById(window.API_queue_LIST.result, environment.queue) ; } } var tableListJobs = document.querySelector(&#39;table#list-jobs&#39;) ; var this_tr = document.createElement(&quot;tr&quot;); this_tr.innerHTML = &quot;&lt;td&gt;&quot; + environment.name + &quot;&lt;/td&gt;&quot; + &quot;&lt;td&gt;&quot; + application.name + &quot;&lt;/td&gt;&quot; + &quot;&lt;td&gt;&quot; + entry.name + &quot;&lt;/td&gt;&quot; + &quot;&lt;td&gt;&quot; + dateVtom.name + &quot;&lt;/td&gt;&quot; + &quot;&lt;td&gt;&quot; + queue.name + &quot;&lt;/td&gt;&quot; + &quot;&lt;td&gt;&quot; + host.name + &quot;&lt;/td&gt;&quot; + &quot;&lt;td&gt;&quot; + entry.Script + &quot;&lt;/td&gt;&quot; ; if(entry.Parameters){ this_tr.innerHTML = this_tr.innerHTML + &quot;&lt;td&gt;&quot; ; entry.Parameters.forEach(function(parameter){ this_tr.innerHTML = this_tr.innerHTML + parameter + &quot;&lt;br&gt;&quot; ; }); this_tr.innerHTML = this_tr.innerHTML + &quot;&lt;/td&gt;&quot; ; } tableListJobs.appendChild(this_tr); }); //eof foreach job list } // eof debutAffichage function getItemsVtom(){ if(typeof(Storage) !== &quot;undefined&quot;) { var isAllItemsInStorage = true ; itemsVtom.forEach(function(item){ if(sessionStorage[&quot;API_&quot;+item+&quot;_LIST&quot;]){ eval(&#39;window.API_&#39;+item+&#39;_LIST = JSON.parse(sessionStorage.getItem(&quot;API_&#39;+item+&#39;_LIST&quot;)) ;&#39;) ; }else{ isAllItemsInStorage = false ; } }); if(! isAllItemsInStorage){ getItemsVtomAPI() ; } }else{ getItemsVtomAPI() ; } } // eof getItemsVtom function removeItemsFromSessionStorage(){ itemsVtom.forEach(function(item){ sessionStorage.removeItem(&quot;API_&quot;+item+&quot;_LIST&quot;); }); } // http://www.html5rocks.com/en/tutorials/cors/ // cross domain function getItemsVtomAPI(){ itemsVtom.forEach(function(item){ eval(&#39;var xhr&#39;+item+&#39; = new XMLHttpRequest();&#39;) ; var strCode = &#39;xhr&#39;+item+&#39;.onreadystatechange = function(){&#39; + &#39;var status = xhr&#39;+item+&#39;.status;&#39; + &#39;if (status == 200) {&#39;+ &#39;if(xhr&#39;+item+&#39;.response != null) {&#39; + &#39;window.API_&#39;+item+&#39;_LIST = xhr&#39;+item+&#39;.response ;&#39; + &#39;if(typeof(Storage) !== &quot;undefined&quot;) {&#39; + &#39;sessionStorage.setItem(&quot;API_&#39;+item+&#39;_LIST&quot;,JSON.stringify(window.API_&#39;+item+&#39;_LIST)) ;&#39; + &#39;}&#39; + &#39;}&#39; + &#39;}&#39; + &#39;}&#39; ; eval(strCode); eval(&#39;xhr&#39;+item+&quot;.open(&#39;GET&#39;, serveurVtom + &#39;/api/&quot;+item+&quot;/getAll&#39;,true);&quot;) ; eval(&#39;xhr&#39;+item+&quot;.responseType = &#39;json&#39;;&quot;) ; eval(&#39;xhr&#39;+item+&quot;.setRequestHeader(&#39;Authorization&#39;, &#39;Basic &#39; + authVtom);&quot;); eval(&#39;xhr&#39;+item+&#39;.send();&#39;) ; }); } // eof getItemsVtomAPI // On récupère les items getItemsVtom() ; function _isAllItemsLoaded(){ console.log((new Date()).getTime()); // debug to make sure we pass through this var isAllItemsLoaded = true ; itemsVtom.forEach(function(item){ if(eval(&#39;window.API_&#39;+item+&#39;_LIST&#39;) == null){ isAllItemsLoaded = false ; }else if(eval(&#39;window.API_&#39;+item+&#39;_LIST.rc&#39;) == 4){ isAllItemsLoaded = false ; console.log(eval(&#39;window.API_&#39;+item+&#39;_LIST.errmsg&#39;)) ; clearInterval(window.intervalDebutAffichage); } }); if( isAllItemsLoaded ) { console.log(&quot;loaded&quot;); // debug to make sure we pass through this clearInterval(window.intervalDebutAffichage); debutAffichage(); return true ; }else{ return false ; } } if(! _isAllItemsLoaded()){ // si les items ne sont pas chargés au démarrage, on lance une boucle interval // On vérifie qu&#39;on a bien chargé toutes les données, on affiche quand c&#39;est ok window.intervalDebutAffichage = setInterval(_isAllItemsLoaded,1000); // quoi qu&#39;il arrive on sort de la boucle au bout de x secondes setTimeout(function(){ clearInterval(window.intervalDebutAffichage); }, 60000); } // Events // Refresh data document.querySelector(&#39;#refresh-button&#39;).addEventListener(&#39;click&#39;,function(e){ removeItemsFromSessionStorage(); window.location = window.location ; }) ; &lt;/script&gt; &lt;/body&gt; &lt;/html&gt; Bon évidemment ça ne donnera rien mais importer cette page chez vous, et changer l’IP, le port et le mot de passe pour que ça fonctionne. Exemple pour lister toutes les consignes # on récupère les données en JSON depuis l&#39;API web access VTOM curl -k -u user:passwd &quot;http://localhost:30080/api/instruction/getAll &gt; /var/tmp/instructions.json # on créé le script qui va générer les consignes au format HTML vi /var/tmp/create_instructions_html.py #!/usr/bin/python import json import sys import io jdata = open(sys.argv[1]) data = json.load(jdata) for result in data[&quot;result&quot;]: with io.open(result[&quot;name&quot;] + &quot;.html&quot;, &quot;w&quot;, encoding=&#39;utf-8&#39;) as f: f.write(result[&quot;content&quot;]) f.close() jdata.close() # On exécute le script chmod +x /var/tmp/create_instructions_html.py /var/tmp/create_instructions_html.py /var/tmp/instructions.json" />
<link rel="canonical" href="https://virtual-thom.github.io/archives/api-vtom-web-access/" />
<meta property="og:url" content="https://virtual-thom.github.io/archives/api-vtom-web-access/" />
<meta property="og:site_name" content="Virtual-Thom Blog-notes VTOM et informatique" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-02-10T20:45:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="API VTOM webaccess" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Virtual Thom"},"dateModified":"2015-02-10T20:45:00+00:00","datePublished":"2015-02-10T20:45:00+00:00","description":"Vous n’êtes pas sans savoir que VTOM fournit, depuis quelques versions maintenant, un webaccess (un portail web d’accès à VTOM / vthttpd). Sur une question de Stephane, je me suis penché sur son fonctionnement. Voici quelques API VTOM glannées dans les pages du webaccess. Peu importe comment vous y accédez, ici en curl (user:passwd à changer) mais on peut très bien faire ça avec POSTMAN. Liste de tous les environnements curl -k -u user:passwd &quot;http://localhost:30080/api/environment/list&quot; -X GET | python -m json.tool Liste de toutes les applications curl -k -u user:passwd &quot;http://localhost:30080/api/application/list&quot; -X GET | python -m json.tool curl -k -u user:passwd &quot;http://localhost:30080/api/application/list?envSId=ENV7f00000102a3106054b8e57700000014&quot; -X GET | python -m json.tool curl -k -u user:passwd &quot;http://localhost:30080/api/application/list?environmentName=VAGUE5_INT&quot; -X GET | python -m json.tool Liste de tous les jobs curl -k -u user:passwd &quot;http://localhost:30080/api/job/list&quot; -X GET | python -m json.tool curl -k -u user:passwd &quot;http://localhost:30080/api/job/list?appSId=APP7f00000129a98189539f1cb000000023&quot; -X GET | python -m json.tool curl -k -u user:passwd &quot;http://localhost:30080/api/job/list?applicationName=BASCULE_DATE&quot; -X GET | python -m json.tool Détails d’un job curl -k -u user:passwd &quot;http://localhost:30080/api/job/getById?id=JOB7f0000012b10ca88539f1cb4000000c2&quot; -X GET | python -m json.tool Détails de tous les jobs (ou autres items) curl -k -u user:passwd &quot;http://localhost:30080/api/job/getAll&quot; -X GET | python -m json.tool Exemple de résultat { &quot;rc&quot;: 0, &quot;result&quot;: { &quot;ExpectedContexts&quot;: [], &quot;ExpectedResources&quot;: [], &quot;Script&quot;: &quot;D:\\\\Script\\\\rotation_log_dxserver\\\\Rotate_log_dxserver.bat&quot;, &quot;appInErr&quot;: &quot;1&quot;, &quot;applicationSId&quot;: &quot;APP7f00000129a98189539f1cb000000023&quot;, &quot;blockDate&quot;: &quot;0&quot;, &quot;cycle&quot;: &quot;00:00:00&quot;, &quot;cycleEnabled&quot;: &quot;0&quot;, &quot;descOnErr&quot;: &quot;0&quot;, &quot;exploited&quot;: &quot;E&quot;, &quot;frequency&quot;: &quot;D&quot;, &quot;id&quot;: &quot;JOB7f0000012b10ca88539f1cb4000000c2&quot;, &quot;information&quot;: &quot; &quot;, &quot;isAsked&quot;: &quot;0&quot;, &quot;maxStart&quot;: &quot;37:59:00&quot;, &quot;minStart&quot;: &quot;25:30:00&quot;, &quot;mode&quot;: &quot;E&quot;, &quot;movementTime&quot;: &quot;0&quot;, &quot;name&quot;: &quot;ROT_LOG_DXSERVER&quot;, &quot;onDemand&quot;: &quot;0&quot;, &quot;restartCount&quot;: &quot;0&quot;, &quot;restartLabel&quot;: &quot;0&quot;, &quot;restartMax&quot;: &quot;1&quot;, &quot;restartType&quot;: &quot;M&quot;, &quot;retained&quot;: &quot;0&quot;, &quot;retcode&quot;: &quot;-1&quot;, &quot;status&quot;: &quot;W&quot;, &quot;timeBegin&quot;: &quot;1421112600&quot;, &quot;timeEnd&quot;: &quot;1421112630&quot;, &quot;xid&quot;: &quot;JOBc2&quot; } } On a vérifié avec Stephane, les attributs sont hiérarchisés comme dans le vtexport xml (si pas dans Job, on remonte dans Application, si pas dans Application, on remonte sur Environnement). carrément le contenu du script !!! curl -k -u user:passwd &quot;http://localhost:30080/api/job/getScript?id=JOB7f0000012b10ca88539f1cb4000000c2&quot; -X GET | python -m json.tool Liste des Logs (utiliser le job xid et non l’id tout court) curl -k -u user:passwd &quot;http://localhost:30080/api/log/getLogList?id=JOBc2&quot; -X GET | python -m json.tool Si je résume : Pour avoir toutes les informations détaillées d&#39;un ensemble d&#39;items (environment, application, job, date, host, instruction - pour info instruction c&#39;est les consignes - etc) http://localhost:30080/api/&lt;item&gt;/getAll Pour avoir toute la liste d&#39;un ensemble d&#39;items mais avec moins de détails http://localhost:30080/api/&lt;item&gt;/list Pour avoir le détail d&#39;un item en particulier http://localhost:30080/api/&lt;item&gt;/getById?id=&lt;id&gt; Pour filtrer la liste d&#39;un ensemble d&#39;item sur un attribut particulier http://localhost:30080/api/&lt;item&gt;/list?&lt;attribut&gt;=&lt;valeur&gt; Si l&#39;attribut n&#39;est pas présent dans l&#39;item le plus bas (job), il faut remonter d&#39;un cran (application) et encore d&#39;un cran si besoin (environment). Notion de hiérarchie, notamment pour les dates, host, queue, user. On peut aussi utiliser cette méthode pour s’authentifier, en passant par le header http : # echo -n &quot;user:password&quot; | base64, ici TOM:TOM curl -H &#39;Authorization: Basic VE9NOlRPTQ==&#39; On peut aussi se pré-authentifier avec /api/utilities/login POST { login: “xxx”, password: “xxx” }. Ca renvoie un cookie avec vtsession et webdoc_account_id qu’il faudra rajouter aux futures requêtes. Ce qui est bien avec cette méthode, c’est que les utilisateurs LDAP passent, alors que l’Authorization Basic ne fonctionne qu’avec des utilisateurs “locaux”. Vous en voulez plus ? Aucune doc Absyss ne référence toutes les APIs. Donc petite astuce : Ouvrez votre navigateur Chrome F12 et aller dans l’onglet Network pour voir les appels aux API. Baladez vous sur l’interface Web du web access et glannez les différentes adresses et requêtes XHR. Petite astuce côté client pour effectuer une request REST sur l’api VTOM sans utiliser jQuery var serveurVtom = &quot;http://monserveurvtom:30080&quot; ; var xhr = new XMLHttpRequest(); xhr.onreadystatechange = function(){ var status = xhr.status; if (status == 200) { if(xhr.response != null) { // toute la réponse avec les columns et les rows console.log( xhr.response ) ; // on récupère le nom par exemple et on l&#39;affiche dans la console xhr.response.result.rows.forEach(function(entry){ console.log(entry.name); }); } } else { console.log(&quot;error&quot;); console.log(status); } } xhr.open(&#39;GET&#39;, serveurVtom + &#39;/api/job/list&#39;); xhr.responseType = &#39;json&#39;; // attention sous unix echo &quot;user:passwdord&quot; | base64 interprète le saut de ligne du echo et vous donne une mauvaise authentification // il faut utiliser l&#39;option -n, echo -n &quot;user:password&quot; | base64 // on peut utiliser un encodage base64 via javascript directement mais dans ce cas le user:mdp est en clair dans le code // ex. VE9NOlRPTQ== =&gt; base64 pour TOM:TOM xhr.setRequestHeader(&#39;Authorization&#39;, &#39;Basic VE9NOlRPTQ==&#39;); xhr.send(); Un exemple pour lister tous les jobs, il faut changer l’ip, le port et encoder le user:password &lt;html lang=fr&quot;&gt; &lt;head&gt; &lt;meta charset=&quot;utf-8&quot; /&gt; &lt;/head&gt; &lt;body&gt; &lt;button id=&quot;refresh-button&quot;&gt;Refresh&lt;/button&gt; &lt;table id=&quot;list-jobs&quot;&gt;&lt;/table&gt; &lt;script&gt; // Variables Globales var serveurVtom = &quot;http://192.168.99.100:30080&quot; ; // A changer ! var authVtom = &quot;VE9NOlRPTQ==&quot; ; //base64 user:password var itemsVtom = [ &quot;environment&quot;, &quot;application&quot;, &quot;job&quot;, &quot;date&quot;, &quot;host&quot;, &quot;queue&quot; ] ; itemsVtom.forEach(function(item){ eval(&quot;window.API_&quot; + item + &quot;_LIST = null ;&quot;) ; }); // Fonctions function findItemById(source, id){ return source.filter(function( obj ) { return obj.id == id; })[ 0 ]; } function debutAffichage(){ window.API_job_LIST.result.forEach(function(entry){ var application = findItemById(window.API_application_LIST.result, entry.applicationSId) ; var environment = findItemById(window.API_environment_LIST.result, application.environmentSId) ; var host = findItemById(window.API_host_LIST.result, entry.host) ; if(!host){ var host = findItemById(window.API_host_LIST.result, application.host) ; if(!host){ var host = findItemById(window.API_host_LIST.result, environment.host) ; } } var dateVtom = findItemById(window.API_date_LIST.result, entry.date) ; if(!dateVtom){ var dateVtom = findItemById(window.API_date_LIST.result, application.date) ; if(!dateVtom){ var dateVtom = findItemById(window.API_date_LIST.result, environment.date) ; } } var queue = findItemById(window.API_queue_LIST.result, entry.queue) ; if(!queue){ var queue = findItemById(window.API_queue_LIST.result, application.queue) ; if(!queue){ var queue = findItemById(window.API_queue_LIST.result, environment.queue) ; } } var tableListJobs = document.querySelector(&#39;table#list-jobs&#39;) ; var this_tr = document.createElement(&quot;tr&quot;); this_tr.innerHTML = &quot;&lt;td&gt;&quot; + environment.name + &quot;&lt;/td&gt;&quot; + &quot;&lt;td&gt;&quot; + application.name + &quot;&lt;/td&gt;&quot; + &quot;&lt;td&gt;&quot; + entry.name + &quot;&lt;/td&gt;&quot; + &quot;&lt;td&gt;&quot; + dateVtom.name + &quot;&lt;/td&gt;&quot; + &quot;&lt;td&gt;&quot; + queue.name + &quot;&lt;/td&gt;&quot; + &quot;&lt;td&gt;&quot; + host.name + &quot;&lt;/td&gt;&quot; + &quot;&lt;td&gt;&quot; + entry.Script + &quot;&lt;/td&gt;&quot; ; if(entry.Parameters){ this_tr.innerHTML = this_tr.innerHTML + &quot;&lt;td&gt;&quot; ; entry.Parameters.forEach(function(parameter){ this_tr.innerHTML = this_tr.innerHTML + parameter + &quot;&lt;br&gt;&quot; ; }); this_tr.innerHTML = this_tr.innerHTML + &quot;&lt;/td&gt;&quot; ; } tableListJobs.appendChild(this_tr); }); //eof foreach job list } // eof debutAffichage function getItemsVtom(){ if(typeof(Storage) !== &quot;undefined&quot;) { var isAllItemsInStorage = true ; itemsVtom.forEach(function(item){ if(sessionStorage[&quot;API_&quot;+item+&quot;_LIST&quot;]){ eval(&#39;window.API_&#39;+item+&#39;_LIST = JSON.parse(sessionStorage.getItem(&quot;API_&#39;+item+&#39;_LIST&quot;)) ;&#39;) ; }else{ isAllItemsInStorage = false ; } }); if(! isAllItemsInStorage){ getItemsVtomAPI() ; } }else{ getItemsVtomAPI() ; } } // eof getItemsVtom function removeItemsFromSessionStorage(){ itemsVtom.forEach(function(item){ sessionStorage.removeItem(&quot;API_&quot;+item+&quot;_LIST&quot;); }); } // http://www.html5rocks.com/en/tutorials/cors/ // cross domain function getItemsVtomAPI(){ itemsVtom.forEach(function(item){ eval(&#39;var xhr&#39;+item+&#39; = new XMLHttpRequest();&#39;) ; var strCode = &#39;xhr&#39;+item+&#39;.onreadystatechange = function(){&#39; + &#39;var status = xhr&#39;+item+&#39;.status;&#39; + &#39;if (status == 200) {&#39;+ &#39;if(xhr&#39;+item+&#39;.response != null) {&#39; + &#39;window.API_&#39;+item+&#39;_LIST = xhr&#39;+item+&#39;.response ;&#39; + &#39;if(typeof(Storage) !== &quot;undefined&quot;) {&#39; + &#39;sessionStorage.setItem(&quot;API_&#39;+item+&#39;_LIST&quot;,JSON.stringify(window.API_&#39;+item+&#39;_LIST)) ;&#39; + &#39;}&#39; + &#39;}&#39; + &#39;}&#39; + &#39;}&#39; ; eval(strCode); eval(&#39;xhr&#39;+item+&quot;.open(&#39;GET&#39;, serveurVtom + &#39;/api/&quot;+item+&quot;/getAll&#39;,true);&quot;) ; eval(&#39;xhr&#39;+item+&quot;.responseType = &#39;json&#39;;&quot;) ; eval(&#39;xhr&#39;+item+&quot;.setRequestHeader(&#39;Authorization&#39;, &#39;Basic &#39; + authVtom);&quot;); eval(&#39;xhr&#39;+item+&#39;.send();&#39;) ; }); } // eof getItemsVtomAPI // On récupère les items getItemsVtom() ; function _isAllItemsLoaded(){ console.log((new Date()).getTime()); // debug to make sure we pass through this var isAllItemsLoaded = true ; itemsVtom.forEach(function(item){ if(eval(&#39;window.API_&#39;+item+&#39;_LIST&#39;) == null){ isAllItemsLoaded = false ; }else if(eval(&#39;window.API_&#39;+item+&#39;_LIST.rc&#39;) == 4){ isAllItemsLoaded = false ; console.log(eval(&#39;window.API_&#39;+item+&#39;_LIST.errmsg&#39;)) ; clearInterval(window.intervalDebutAffichage); } }); if( isAllItemsLoaded ) { console.log(&quot;loaded&quot;); // debug to make sure we pass through this clearInterval(window.intervalDebutAffichage); debutAffichage(); return true ; }else{ return false ; } } if(! _isAllItemsLoaded()){ // si les items ne sont pas chargés au démarrage, on lance une boucle interval // On vérifie qu&#39;on a bien chargé toutes les données, on affiche quand c&#39;est ok window.intervalDebutAffichage = setInterval(_isAllItemsLoaded,1000); // quoi qu&#39;il arrive on sort de la boucle au bout de x secondes setTimeout(function(){ clearInterval(window.intervalDebutAffichage); }, 60000); } // Events // Refresh data document.querySelector(&#39;#refresh-button&#39;).addEventListener(&#39;click&#39;,function(e){ removeItemsFromSessionStorage(); window.location = window.location ; }) ; &lt;/script&gt; &lt;/body&gt; &lt;/html&gt; Bon évidemment ça ne donnera rien mais importer cette page chez vous, et changer l’IP, le port et le mot de passe pour que ça fonctionne. Exemple pour lister toutes les consignes # on récupère les données en JSON depuis l&#39;API web access VTOM curl -k -u user:passwd &quot;http://localhost:30080/api/instruction/getAll &gt; /var/tmp/instructions.json # on créé le script qui va générer les consignes au format HTML vi /var/tmp/create_instructions_html.py #!/usr/bin/python import json import sys import io jdata = open(sys.argv[1]) data = json.load(jdata) for result in data[&quot;result&quot;]: with io.open(result[&quot;name&quot;] + &quot;.html&quot;, &quot;w&quot;, encoding=&#39;utf-8&#39;) as f: f.write(result[&quot;content&quot;]) f.close() jdata.close() # On exécute le script chmod +x /var/tmp/create_instructions_html.py /var/tmp/create_instructions_html.py /var/tmp/instructions.json","headline":"API VTOM webaccess","mainEntityOfPage":{"@type":"WebPage","@id":"https://virtual-thom.github.io/archives/api-vtom-web-access/"},"url":"https://virtual-thom.github.io/archives/api-vtom-web-access/"}</script>
<!-- End Jekyll SEO tag -->

  
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z8Y7902GRV"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Z8Y7902GRV');
</script>


  <body>
    <div class="container">
      <header id="site-header">
  <h1>Blog-notes VTOM, informatique, industrialisation, ordonnancement, DevOps</h1>
  <nav>
    <ul>
      <li>
        <a href="https://virtual-thom.github.io/archives" title="Home">
          <svg class="svg-icon" viewBox="0 0 20 20">
            <path d="M18.121,9.88l-7.832-7.836c-0.155-0.158-0.428-0.155-0.584,0L1.842,9.913c-0.262,0.263-0.073,0.705,0.292,0.705h2.069v7.042c0,0.227,0.187,0.414,0.414,0.414h3.725c0.228,0,0.414-0.188,0.414-0.414v-3.313h2.483v3.313c0,0.227,0.187,0.414,0.413,0.414h3.726c0.229,0,0.414-0.188,0.414-0.414v-7.042h2.068h0.004C18.331,10.617,18.389,10.146,18.121,9.88 M14.963,17.245h-2.896v-3.313c0-0.229-0.186-0.415-0.414-0.415H8.342c-0.228,0-0.414,0.187-0.414,0.415v3.313H5.032v-6.628h9.931V17.245z M3.133,9.79l6.864-6.868l6.867,6.868H3.133z"></path>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://virtual-thom.github.io/archives/vos-commentaires-livre-d-or/" title="Commentaires - livre d'or">
          <svg class="svg-icon" viewBox="0 0 20 20">
            <path d="M17.657,2.982H2.342c-0.234,0-0.425,0.191-0.425,0.426v10.21c0,0.234,0.191,0.426,0.425,0.426h3.404v2.553c0,0.397,0.48,0.547,0.725,0.302l2.889-2.854h8.298c0.234,0,0.426-0.191,0.426-0.426V3.408C18.083,3.174,17.892,2.982,17.657,2.982M17.232,13.192H9.185c-0.113,0-0.219,0.045-0.3,0.124l-2.289,2.262v-1.96c0-0.233-0.191-0.426-0.425-0.426H2.767V3.833h14.465V13.192z M10,7.237c-0.821,0-1.489,0.668-1.489,1.489c0,0.821,0.668,1.489,1.489,1.489c0.821,0,1.488-0.668,1.488-1.489C11.488,7.905,10.821,7.237,10,7.237 M10,9.364c-0.352,0-0.638-0.288-0.638-0.638c0-0.351,0.287-0.638,0.638-0.638c0.351,0,0.638,0.287,0.638,0.638C10.638,9.077,10.351,9.364,10,9.364 M14.254,7.237c-0.821,0-1.489,0.668-1.489,1.489c0,0.821,0.668,1.489,1.489,1.489s1.489-0.668,1.489-1.489C15.743,7.905,15.075,7.237,14.254,7.237 M14.254,9.364c-0.351,0-0.638-0.288-0.638-0.638c0-0.351,0.287-0.638,0.638-0.638c0.352,0,0.639,0.287,0.639,0.638C14.893,9.077,14.605,9.364,14.254,9.364 M5.746,7.237c-0.821,0-1.489,0.668-1.489,1.489c0,0.821,0.668,1.489,1.489,1.489c0.821,0,1.489-0.668,1.489-1.489C7.234,7.905,6.566,7.237,5.746,7.237 M5.746,9.364c-0.351,0-0.638-0.288-0.638-0.638c0-0.351,0.287-0.638,0.638-0.638c0.351,0,0.638,0.287,0.638,0.638C6.384,9.077,6.096,9.364,5.746,9.364"></path>
          </svg>
        </a>
      </li>
      
      <li>
        <a href="https://virtual-thom.github.io/about" title="Curriculum Vitae Thom">
          <svg class="svg-icon" viewBox="0 0 20 20">
            <path d="M12.075,10.812c1.358-0.853,2.242-2.507,2.242-4.037c0-2.181-1.795-4.618-4.198-4.618S5.921,4.594,5.921,6.775c0,1.53,0.884,3.185,2.242,4.037c-3.222,0.865-5.6,3.807-5.6,7.298c0,0.23,0.189,0.42,0.42,0.42h14.273c0.23,0,0.42-0.189,0.42-0.42C17.676,14.619,15.297,11.677,12.075,10.812 M6.761,6.775c0-2.162,1.773-3.778,3.358-3.778s3.359,1.616,3.359,3.778c0,2.162-1.774,3.778-3.359,3.778S6.761,8.937,6.761,6.775 M3.415,17.69c0.218-3.51,3.142-6.297,6.704-6.297c3.562,0,6.486,2.787,6.705,6.297H3.415z"></path>
          </svg>
        </a>
      </li>
    </ul>
  </nav>
</header>

      <div itemscope itemtype ="http://schema.org/Article" class="post">
  
  <header class="post-header">
    <h1 itemprop="name about headline" class="post-title">API VTOM webaccess</h1>
    <p class="post-meta">
      <time itemprop="datePublished dateModified" datetime="2015-02-10T20:45:00+00:00">10-02-2015</time></p>
  </header>

  <article class="post-content" itemprop="articleBody">
    <h1 class="hidden">API VTOM webaccess</h1>
    <p>Vous n’êtes pas sans savoir que VTOM fournit, depuis quelques versions maintenant, un webaccess (un portail web d’accès à VTOM / vthttpd).</p>

<p>Sur une question de Stephane, je me suis penché sur son fonctionnement.</p>

<p>Voici quelques API VTOM glannées dans les pages du webaccess.</p>

<p>Peu importe comment vous y accédez, ici en curl (user:passwd à changer) mais on peut très bien faire ça avec POSTMAN.</p>

<h1 id="liste-de-tous-les-environnements">Liste de tous les environnements</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-k</span> <span class="nt">-u</span> user:passwd <span class="s2">"http://localhost:30080/api/environment/list"</span> <span class="nt">-X</span> GET  | python <span class="nt">-m</span> json.tool
</code></pre></div></div>

<h1 id="liste-de-toutes-les-applications">Liste de toutes les applications</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-k</span> <span class="nt">-u</span> user:passwd <span class="s2">"http://localhost:30080/api/application/list"</span> <span class="nt">-X</span> GET  | python <span class="nt">-m</span> json.tool
curl <span class="nt">-k</span> <span class="nt">-u</span> user:passwd <span class="s2">"http://localhost:30080/api/application/list?envSId=ENV7f00000102a3106054b8e57700000014"</span> <span class="nt">-X</span> GET  | python <span class="nt">-m</span> json.tool
curl <span class="nt">-k</span> <span class="nt">-u</span> user:passwd <span class="s2">"http://localhost:30080/api/application/list?environmentName=VAGUE5_INT"</span> <span class="nt">-X</span> GET  | python <span class="nt">-m</span> json.tool
</code></pre></div></div>

<h1 id="liste-de-tous-les-jobs">Liste de tous les jobs</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-k</span> <span class="nt">-u</span> user:passwd <span class="s2">"http://localhost:30080/api/job/list"</span> <span class="nt">-X</span> GET  | python <span class="nt">-m</span> json.tool
curl <span class="nt">-k</span> <span class="nt">-u</span> user:passwd <span class="s2">"http://localhost:30080/api/job/list?appSId=APP7f00000129a98189539f1cb000000023"</span> <span class="nt">-X</span> GET  | python <span class="nt">-m</span> json.tool
curl <span class="nt">-k</span> <span class="nt">-u</span> user:passwd <span class="s2">"http://localhost:30080/api/job/list?applicationName=BASCULE_DATE"</span> <span class="nt">-X</span> GET  | python <span class="nt">-m</span> json.tool
</code></pre></div></div>

<h1 id="détails-dun-job">Détails d’un job</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-k</span> <span class="nt">-u</span> user:passwd <span class="s2">"http://localhost:30080/api/job/getById?id=JOB7f0000012b10ca88539f1cb4000000c2"</span> <span class="nt">-X</span> GET  | python <span class="nt">-m</span> json.tool
</code></pre></div></div>

<h1 id="détails-de-tous-les-jobs-ou-autres-items">Détails de tous les jobs (ou autres items)</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-k</span> <span class="nt">-u</span> user:passwd <span class="s2">"http://localhost:30080/api/job/getAll"</span> <span class="nt">-X</span> GET  | python <span class="nt">-m</span> json.tool
</code></pre></div></div>

<h2 id="exemple-de-résultat">Exemple de résultat</h2>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"rc"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> 
    </span><span class="nl">"result"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"ExpectedContexts"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> 
        </span><span class="nl">"ExpectedResources"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> 
        </span><span class="nl">"Script"</span><span class="p">:</span><span class="w"> </span><span class="s2">"D:</span><span class="se">\\</span><span class="s2">Script</span><span class="se">\\</span><span class="s2">rotation_log_dxserver</span><span class="se">\\</span><span class="s2">Rotate_log_dxserver.bat"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"appInErr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"applicationSId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"APP7f00000129a98189539f1cb000000023"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"blockDate"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"cycle"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00:00:00"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"cycleEnabled"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"descOnErr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"exploited"</span><span class="p">:</span><span class="w"> </span><span class="s2">"E"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"frequency"</span><span class="p">:</span><span class="w"> </span><span class="s2">"D"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"JOB7f0000012b10ca88539f1cb4000000c2"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"information"</span><span class="p">:</span><span class="w"> </span><span class="s2">" "</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"isAsked"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"maxStart"</span><span class="p">:</span><span class="w"> </span><span class="s2">"37:59:00"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"minStart"</span><span class="p">:</span><span class="w"> </span><span class="s2">"25:30:00"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"mode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"E"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"movementTime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ROT_LOG_DXSERVER"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"onDemand"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"restartCount"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"restartLabel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"restartMax"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"restartType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"M"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"retained"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"retcode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"-1"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"W"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"timeBegin"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1421112600"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"timeEnd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1421112630"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"xid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"JOBc2"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>On a vérifié avec Stephane, les attributs sont hiérarchisés comme dans le vtexport xml (si pas dans Job, on remonte dans Application, si pas dans Application, on remonte sur Environnement).</p>

<h1 id="carrément-le-contenu-du-script-">carrément le contenu du script !!!</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-k</span> <span class="nt">-u</span> user:passwd <span class="s2">"http://localhost:30080/api/job/getScript?id=JOB7f0000012b10ca88539f1cb4000000c2"</span>  <span class="nt">-X</span> GET  | python <span class="nt">-m</span> json.tool
</code></pre></div></div>

<h1 id="liste-des-logs-utiliser-le-job-xid-et-non-lid-tout-court">Liste des Logs (utiliser le job xid et non l’id tout court)</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-k</span> <span class="nt">-u</span> user:passwd <span class="s2">"http://localhost:30080/api/log/getLogList?id=JOBc2"</span>  <span class="nt">-X</span> GET  | python <span class="nt">-m</span> json.tool
</code></pre></div></div>

<h1 id="si-je-résume-">Si je résume :</h1>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Pour avoir toutes les informations détaillées d'un ensemble d'items (environment, application, job, date, host, instruction - pour info instruction c'est les consignes -  etc)
http://localhost:30080/api/&lt;item&gt;/getAll

Pour avoir toute la liste d'un ensemble d'items mais avec moins de détails 
http://localhost:30080/api/&lt;item&gt;/list

Pour avoir le détail d'un item en particulier
http://localhost:30080/api/&lt;item&gt;/getById?id=&lt;id&gt;

Pour filtrer la liste d'un ensemble d'item sur un attribut particulier
http://localhost:30080/api/&lt;item&gt;/list?&lt;attribut&gt;=&lt;valeur&gt;

Si l'attribut n'est pas présent dans l'item le plus bas (job), il faut remonter d'un cran (application) et encore d'un cran si besoin (environment). Notion de hiérarchie, notamment pour les dates, host, queue, user.
</code></pre></div></div>

<p>On peut aussi utiliser cette méthode pour s’authentifier, en passant par le header http :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># echo -n "user:password" | base64, ici TOM:TOM
curl -H 'Authorization: Basic VE9NOlRPTQ=='
</code></pre></div></div>

<p>On peut aussi se pré-authentifier avec <code class="language-plaintext highlighter-rouge">/api/utilities/login</code> POST { login: “xxx”, password: “xxx” }.
Ca renvoie un cookie avec <code class="language-plaintext highlighter-rouge">vtsession</code> et <code class="language-plaintext highlighter-rouge">webdoc_account_id</code> qu’il faudra rajouter aux futures requêtes.
Ce qui est bien avec cette méthode, c’est que les utilisateurs LDAP passent, alors que l’Authorization Basic ne fonctionne qu’avec des utilisateurs “locaux”.</p>

<h1 id="vous-en-voulez-plus-">Vous en voulez plus ?</h1>

<p>Aucune doc Absyss ne référence toutes les APIs. Donc petite astuce :</p>

<p>Ouvrez votre navigateur Chrome F12 et aller dans l’onglet Network pour voir les appels aux API. Baladez vous sur l’interface Web du web access et glannez les différentes adresses et requêtes XHR.</p>

<h1 id="petite-astuce-côté-client-pour-effectuer-une-request-rest-sur-lapi-vtom-sans-utiliser-jquery">Petite astuce côté client pour effectuer une request REST sur l’api VTOM sans utiliser jQuery</h1>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">serveurVtom</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://monserveurvtom:30080</span><span class="dl">"</span> <span class="p">;</span>
<span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="kd">var</span> <span class="nx">status</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span><span class="p">;</span>

      <span class="k">if </span><span class="p">(</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        
        <span class="k">if</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">response</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// toute la réponse avec les columns et les rows</span>
                <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">response</span> <span class="p">)</span> <span class="p">;</span>
                <span class="c1">// on récupère le nom par exemple et on l'affiche dans la console</span>
                <span class="nx">xhr</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">rows</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">entry</span><span class="p">){</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">entry</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
                <span class="p">});</span>
        <span class="p">}</span>
        
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">error</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">status</span><span class="p">);</span>
      <span class="p">}</span>
<span class="p">}</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span> <span class="nx">serveurVtom</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">/api/job/list</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">responseType</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">json</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// attention sous unix echo "user:passwdord" | base64 interprète le saut de ligne du echo et vous donne une mauvaise authentification</span>
<span class="c1">// il faut utiliser l'option -n, echo -n "user:password" | base64</span>
<span class="c1">// on peut utiliser un encodage base64 via javascript directement mais dans ce cas le user:mdp est en clair dans le code</span>
<span class="c1">// ex. VE9NOlRPTQ== =&gt; base64 pour TOM:TOM</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nf">setRequestHeader</span><span class="p">(</span><span class="dl">'</span><span class="s1">Authorization</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Basic VE9NOlRPTQ==</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nf">send</span><span class="p">();</span>
</code></pre></div></div>

<p><a href="https://virtual-thom.github.io/archives/wp-content/uploads/list_all_jobs.html">Un exemple pour lister tous les jobs, il faut changer l’ip, le port et encoder le user:password</a></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">fr"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

<span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">"refresh-button"</span><span class="nt">&gt;</span>Refresh<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;table</span> <span class="na">id=</span><span class="s">"list-jobs"</span><span class="nt">&gt;&lt;/table&gt;</span>

<span class="nt">&lt;script&gt;</span>
<span class="c1">// Variables Globales</span>
<span class="kd">var</span> <span class="nx">serveurVtom</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://192.168.99.100:30080</span><span class="dl">"</span> <span class="p">;</span> <span class="c1">// A changer !</span>
<span class="kd">var</span> <span class="nx">authVtom</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">VE9NOlRPTQ==</span><span class="dl">"</span> <span class="p">;</span> <span class="c1">//base64 user:password</span>
<span class="kd">var</span> <span class="nx">itemsVtom</span> <span class="o">=</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">environment</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">application</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">job</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">date</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">host</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">queue</span><span class="dl">"</span> <span class="p">]</span> <span class="p">;</span> 
<span class="nx">itemsVtom</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">){</span>
	<span class="nf">eval</span><span class="p">(</span><span class="dl">"</span><span class="s2">window.API_</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">item</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">_LIST = null ;</span><span class="dl">"</span><span class="p">)</span> <span class="p">;</span>
<span class="p">});</span>


<span class="c1">// Fonctions</span>
<span class="kd">function</span> <span class="nf">findItemById</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">id</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">source</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">obj</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">id</span> <span class="o">==</span> <span class="nx">id</span><span class="p">;</span>
    <span class="p">})[</span> <span class="mi">0</span> <span class="p">];</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nf">debutAffichage</span><span class="p">(){</span>
	
	<span class="nb">window</span><span class="p">.</span><span class="nx">API_job_LIST</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">entry</span><span class="p">){</span>
		<span class="kd">var</span> <span class="nx">application</span> <span class="o">=</span> <span class="nf">findItemById</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">API_application_LIST</span><span class="p">.</span><span class="nx">result</span><span class="p">,</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">applicationSId</span><span class="p">)</span> <span class="p">;</span>
		<span class="kd">var</span> <span class="nx">environment</span> <span class="o">=</span> <span class="nf">findItemById</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">API_environment_LIST</span><span class="p">.</span><span class="nx">result</span><span class="p">,</span> <span class="nx">application</span><span class="p">.</span><span class="nx">environmentSId</span><span class="p">)</span> <span class="p">;</span>
		<span class="kd">var</span> <span class="nx">host</span> <span class="o">=</span> <span class="nf">findItemById</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">API_host_LIST</span><span class="p">.</span><span class="nx">result</span><span class="p">,</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">host</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">host</span><span class="p">){</span>
			<span class="kd">var</span> <span class="nx">host</span> <span class="o">=</span> <span class="nf">findItemById</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">API_host_LIST</span><span class="p">.</span><span class="nx">result</span><span class="p">,</span> <span class="nx">application</span><span class="p">.</span><span class="nx">host</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">host</span><span class="p">){</span>
				<span class="kd">var</span> <span class="nx">host</span> <span class="o">=</span> <span class="nf">findItemById</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">API_host_LIST</span><span class="p">.</span><span class="nx">result</span><span class="p">,</span> <span class="nx">environment</span><span class="p">.</span><span class="nx">host</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="kd">var</span> <span class="nx">dateVtom</span> <span class="o">=</span> <span class="nf">findItemById</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">API_date_LIST</span><span class="p">.</span><span class="nx">result</span><span class="p">,</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">date</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">dateVtom</span><span class="p">){</span>
			<span class="kd">var</span> <span class="nx">dateVtom</span> <span class="o">=</span> <span class="nf">findItemById</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">API_date_LIST</span><span class="p">.</span><span class="nx">result</span><span class="p">,</span> <span class="nx">application</span><span class="p">.</span><span class="nx">date</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">dateVtom</span><span class="p">){</span>
				<span class="kd">var</span> <span class="nx">dateVtom</span> <span class="o">=</span> <span class="nf">findItemById</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">API_date_LIST</span><span class="p">.</span><span class="nx">result</span><span class="p">,</span> <span class="nx">environment</span><span class="p">.</span><span class="nx">date</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="kd">var</span> <span class="nx">queue</span> <span class="o">=</span> <span class="nf">findItemById</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">API_queue_LIST</span><span class="p">.</span><span class="nx">result</span><span class="p">,</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">queue</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">queue</span><span class="p">){</span>
			<span class="kd">var</span> <span class="nx">queue</span> <span class="o">=</span> <span class="nf">findItemById</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">API_queue_LIST</span><span class="p">.</span><span class="nx">result</span><span class="p">,</span> <span class="nx">application</span><span class="p">.</span><span class="nx">queue</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">queue</span><span class="p">){</span>
				<span class="kd">var</span> <span class="nx">queue</span> <span class="o">=</span> <span class="nf">findItemById</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">API_queue_LIST</span><span class="p">.</span><span class="nx">result</span><span class="p">,</span> <span class="nx">environment</span><span class="p">.</span><span class="nx">queue</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		
		<span class="kd">var</span> <span class="nx">tableListJobs</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">table#list-jobs</span><span class="dl">'</span><span class="p">)</span> <span class="p">;</span>
		<span class="kd">var</span> <span class="nx">this_tr</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">tr</span><span class="dl">"</span><span class="p">);</span>
		<span class="nx">this_tr</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">&lt;td&gt;</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">environment</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;/td&gt;</span><span class="dl">"</span> <span class="o">+</span>
			<span class="dl">"</span><span class="s2">&lt;td&gt;</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">application</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;/td&gt;</span><span class="dl">"</span> <span class="o">+</span>
			<span class="dl">"</span><span class="s2">&lt;td&gt;</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;/td&gt;</span><span class="dl">"</span> <span class="o">+</span>
			<span class="dl">"</span><span class="s2">&lt;td&gt;</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">dateVtom</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;/td&gt;</span><span class="dl">"</span> <span class="o">+</span>
			<span class="dl">"</span><span class="s2">&lt;td&gt;</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;/td&gt;</span><span class="dl">"</span> <span class="o">+</span>
			<span class="dl">"</span><span class="s2">&lt;td&gt;</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">host</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;/td&gt;</span><span class="dl">"</span> <span class="o">+</span>
			<span class="dl">"</span><span class="s2">&lt;td&gt;</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">Script</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;/td&gt;</span><span class="dl">"</span> <span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="nx">entry</span><span class="p">.</span><span class="nx">Parameters</span><span class="p">){</span>
			<span class="nx">this_tr</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">this_tr</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;td&gt;</span><span class="dl">"</span> <span class="p">;</span>
			<span class="nx">entry</span><span class="p">.</span><span class="nx">Parameters</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">parameter</span><span class="p">){</span>
				<span class="nx">this_tr</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">this_tr</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">+</span> <span class="nx">parameter</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;br&gt;</span><span class="dl">"</span> <span class="p">;</span>
			<span class="p">});</span>
			<span class="nx">this_tr</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">this_tr</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;/td&gt;</span><span class="dl">"</span> <span class="p">;</span>
		<span class="p">}</span>

		<span class="nx">tableListJobs</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">this_tr</span><span class="p">);</span>
	<span class="p">});</span> <span class="c1">//eof foreach job list</span>

<span class="p">}</span> <span class="c1">// eof debutAffichage</span>

<span class="kd">function</span> <span class="nf">getItemsVtom</span><span class="p">(){</span>
	<span class="k">if</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">Storage</span><span class="p">)</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">undefined</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">isAllItemsInStorage</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">;</span>
		<span class="nx">itemsVtom</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">){</span>
			<span class="k">if</span><span class="p">(</span><span class="nx">sessionStorage</span><span class="p">[</span><span class="dl">"</span><span class="s2">API_</span><span class="dl">"</span><span class="o">+</span><span class="nx">item</span><span class="o">+</span><span class="dl">"</span><span class="s2">_LIST</span><span class="dl">"</span><span class="p">]){</span>
				<span class="nf">eval</span><span class="p">(</span><span class="dl">'</span><span class="s1">window.API_</span><span class="dl">'</span><span class="o">+</span><span class="nx">item</span><span class="o">+</span><span class="dl">'</span><span class="s1">_LIST = JSON.parse(sessionStorage.getItem("API_</span><span class="dl">'</span><span class="o">+</span><span class="nx">item</span><span class="o">+</span><span class="dl">'</span><span class="s1">_LIST")) ;</span><span class="dl">'</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span><span class="k">else</span><span class="p">{</span>
				<span class="nx">isAllItemsInStorage</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">;</span>
			<span class="p">}</span>

		<span class="p">});</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span> <span class="nx">isAllItemsInStorage</span><span class="p">){</span>
			<span class="nf">getItemsVtomAPI</span><span class="p">()</span> <span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="nf">getItemsVtomAPI</span><span class="p">()</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span> <span class="c1">// eof getItemsVtom</span>

<span class="kd">function</span> <span class="nf">removeItemsFromSessionStorage</span><span class="p">(){</span>
	<span class="nx">itemsVtom</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">){</span>
		<span class="nx">sessionStorage</span><span class="p">.</span><span class="nf">removeItem</span><span class="p">(</span><span class="dl">"</span><span class="s2">API_</span><span class="dl">"</span><span class="o">+</span><span class="nx">item</span><span class="o">+</span><span class="dl">"</span><span class="s2">_LIST</span><span class="dl">"</span><span class="p">);</span>
	<span class="p">});</span>
<span class="p">}</span>

<span class="c1">// http://www.html5rocks.com/en/tutorials/cors/</span>
<span class="c1">// cross domain </span>
<span class="kd">function</span> <span class="nf">getItemsVtomAPI</span><span class="p">(){</span>
  
 <span class="nx">itemsVtom</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">){</span>

	<span class="nf">eval</span><span class="p">(</span><span class="dl">'</span><span class="s1">var xhr</span><span class="dl">'</span><span class="o">+</span><span class="nx">item</span><span class="o">+</span><span class="dl">'</span><span class="s1"> = new XMLHttpRequest();</span><span class="dl">'</span><span class="p">)</span> <span class="p">;</span> 
	<span class="kd">var</span> <span class="nx">strCode</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">xhr</span><span class="dl">'</span><span class="o">+</span><span class="nx">item</span><span class="o">+</span><span class="dl">'</span><span class="s1">.onreadystatechange = function(){</span><span class="dl">'</span> <span class="o">+</span> 
	      <span class="dl">'</span><span class="s1">var status = xhr</span><span class="dl">'</span><span class="o">+</span><span class="nx">item</span><span class="o">+</span><span class="dl">'</span><span class="s1">.status;</span><span class="dl">'</span> <span class="o">+</span>

	      <span class="dl">'</span><span class="s1">if (status == 200) {</span><span class="dl">'</span><span class="o">+</span>
		<span class="dl">'</span><span class="s1">if(xhr</span><span class="dl">'</span><span class="o">+</span><span class="nx">item</span><span class="o">+</span><span class="dl">'</span><span class="s1">.response != null) {</span><span class="dl">'</span> <span class="o">+</span>
			<span class="dl">'</span><span class="s1">window.API_</span><span class="dl">'</span><span class="o">+</span><span class="nx">item</span><span class="o">+</span><span class="dl">'</span><span class="s1">_LIST = xhr</span><span class="dl">'</span><span class="o">+</span><span class="nx">item</span><span class="o">+</span><span class="dl">'</span><span class="s1">.response ;</span><span class="dl">'</span> <span class="o">+</span>
			<span class="dl">'</span><span class="s1">if(typeof(Storage) !== "undefined") {</span><span class="dl">'</span> <span class="o">+</span>
				<span class="dl">'</span><span class="s1">sessionStorage.setItem("API_</span><span class="dl">'</span><span class="o">+</span><span class="nx">item</span><span class="o">+</span><span class="dl">'</span><span class="s1">_LIST",JSON.stringify(window.API_</span><span class="dl">'</span><span class="o">+</span><span class="nx">item</span><span class="o">+</span><span class="dl">'</span><span class="s1">_LIST)) ;</span><span class="dl">'</span> <span class="o">+</span>
			<span class="dl">'</span><span class="s1">}</span><span class="dl">'</span> <span class="o">+</span>
		<span class="dl">'</span><span class="s1">}</span><span class="dl">'</span> <span class="o">+</span> 
	      <span class="dl">'</span><span class="s1">}</span><span class="dl">'</span> <span class="o">+</span>

	<span class="dl">'</span><span class="s1">}</span><span class="dl">'</span> <span class="p">;</span>
	<span class="nf">eval</span><span class="p">(</span><span class="nx">strCode</span><span class="p">);</span>
	<span class="nf">eval</span><span class="p">(</span><span class="dl">'</span><span class="s1">xhr</span><span class="dl">'</span><span class="o">+</span><span class="nx">item</span><span class="o">+</span><span class="dl">"</span><span class="s2">.open('GET', serveurVtom + '/api/</span><span class="dl">"</span><span class="o">+</span><span class="nx">item</span><span class="o">+</span><span class="dl">"</span><span class="s2">/getAll',true);</span><span class="dl">"</span><span class="p">)</span> <span class="p">;</span>
	<span class="nf">eval</span><span class="p">(</span><span class="dl">'</span><span class="s1">xhr</span><span class="dl">'</span><span class="o">+</span><span class="nx">item</span><span class="o">+</span><span class="dl">"</span><span class="s2">.responseType = 'json';</span><span class="dl">"</span><span class="p">)</span> <span class="p">;</span>
	<span class="nf">eval</span><span class="p">(</span><span class="dl">'</span><span class="s1">xhr</span><span class="dl">'</span><span class="o">+</span><span class="nx">item</span><span class="o">+</span><span class="dl">"</span><span class="s2">.setRequestHeader('Authorization', 'Basic ' + authVtom);</span><span class="dl">"</span><span class="p">);</span>
	<span class="nf">eval</span><span class="p">(</span><span class="dl">'</span><span class="s1">xhr</span><span class="dl">'</span><span class="o">+</span><span class="nx">item</span><span class="o">+</span><span class="dl">'</span><span class="s1">.send();</span><span class="dl">'</span><span class="p">)</span> <span class="p">;</span>
 <span class="p">});</span>

<span class="p">}</span> <span class="c1">// eof getItemsVtomAPI</span>

<span class="c1">// On récupère les items</span>
<span class="nf">getItemsVtom</span><span class="p">()</span> <span class="p">;</span>

<span class="kd">function</span> <span class="nf">_isAllItemsLoaded</span><span class="p">(){</span>

 <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="k">new</span> <span class="nc">Date</span><span class="p">()).</span><span class="nf">getTime</span><span class="p">());</span> <span class="c1">// debug to make sure we pass through this</span>
 
 <span class="kd">var</span> <span class="nx">isAllItemsLoaded</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">;</span>
 <span class="nx">itemsVtom</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">){</span>
  
	<span class="k">if</span><span class="p">(</span><span class="nf">eval</span><span class="p">(</span><span class="dl">'</span><span class="s1">window.API_</span><span class="dl">'</span><span class="o">+</span><span class="nx">item</span><span class="o">+</span><span class="dl">'</span><span class="s1">_LIST</span><span class="dl">'</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span><span class="p">){</span>
		<span class="nx">isAllItemsLoaded</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">;</span>
	<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nf">eval</span><span class="p">(</span><span class="dl">'</span><span class="s1">window.API_</span><span class="dl">'</span><span class="o">+</span><span class="nx">item</span><span class="o">+</span><span class="dl">'</span><span class="s1">_LIST.rc</span><span class="dl">'</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">){</span>
		<span class="nx">isAllItemsLoaded</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nf">eval</span><span class="p">(</span><span class="dl">'</span><span class="s1">window.API_</span><span class="dl">'</span><span class="o">+</span><span class="nx">item</span><span class="o">+</span><span class="dl">'</span><span class="s1">_LIST.errmsg</span><span class="dl">'</span><span class="p">))</span> <span class="p">;</span>
    <span class="nf">clearInterval</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">intervalDebutAffichage</span><span class="p">);</span>
  <span class="p">}</span>
 <span class="p">});</span>
 <span class="k">if</span><span class="p">(</span> <span class="nx">isAllItemsLoaded</span> <span class="p">)</span>
 <span class="p">{</span> 
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">loaded</span><span class="dl">"</span><span class="p">);</span> <span class="c1">// debug to make sure we pass through this </span>
	<span class="nf">clearInterval</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">intervalDebutAffichage</span><span class="p">);</span>
	<span class="nf">debutAffichage</span><span class="p">();</span>
  <span class="k">return</span> <span class="kc">true</span> <span class="p">;</span>
 <span class="p">}</span><span class="k">else</span><span class="p">{</span>
  <span class="k">return</span> <span class="kc">false</span> <span class="p">;</span> 
 <span class="p">}</span>  
<span class="p">}</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span> <span class="nf">_isAllItemsLoaded</span><span class="p">()){</span> <span class="c1">// si les items ne sont pas chargés au démarrage, on lance une boucle interval</span>
  <span class="c1">// On vérifie qu'on a bien chargé toutes les données, on affiche quand c'est ok</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">intervalDebutAffichage</span> <span class="o">=</span> <span class="nf">setInterval</span><span class="p">(</span><span class="nx">_isAllItemsLoaded</span><span class="p">,</span><span class="mi">1000</span><span class="p">);</span> 

  <span class="c1">// quoi qu'il arrive on sort de la boucle au bout de x secondes</span>
  <span class="nf">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span> 
    <span class="nf">clearInterval</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">intervalDebutAffichage</span><span class="p">);</span>
  <span class="p">},</span> <span class="mi">60000</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Events</span>

<span class="c1">// Refresh data</span>
<span class="nb">document</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">#refresh-button</span><span class="dl">'</span><span class="p">).</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">click</span><span class="dl">'</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
	<span class="nf">removeItemsFromSessionStorage</span><span class="p">();</span>
	<span class="nb">window</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span> <span class="p">;</span>	
<span class="p">})</span> <span class="p">;</span>

<span class="nt">&lt;/script&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>Bon évidemment ça ne donnera rien mais importer cette page chez vous, et changer l’IP, le port et le mot de passe pour que ça fonctionne.</p>

<h2 id="exemple-pour-lister-toutes-les-consignes">Exemple pour lister toutes les consignes</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># on récupère les données en JSON depuis l'API web access VTOM
curl -k -u user:passwd "http://localhost:30080/api/instruction/getAll &gt; /var/tmp/instructions.json

# on créé le script qui va générer les consignes au format HTML
vi /var/tmp/create_instructions_html.py
#!/usr/bin/python
import json
import sys
import io

jdata = open(sys.argv[1])
data = json.load(jdata)

for result in data["result"]:
        with io.open(result["name"] + ".html", "w", encoding='utf-8') as f:
                f.write(result["content"])
                f.close()
jdata.close()


# On exécute le script 
chmod +x /var/tmp/create_instructions_html.py
/var/tmp/create_instructions_html.py /var/tmp/instructions.json
</code></pre></div></div>

  </article>
  
<nav>
  <ul class="pager">
    
     
    <li class="previous">
      <a href="https://virtual-thom.github.io/archives/documentations-vtom-absyss-telecharger-officielle/"><span aria-hidden="true">&larr;</span> Documentations VTOM, comment télécharger la doc officielle absyss</a> 
    </li>
    
     
     <li class="next">
      <a class="next" href="https://virtual-thom.github.io/archives/resnopla-vtom/">Exécuter une application si parent déplanifié <span aria-hidden="true">&rarr;</span></a> 
    </li>
     
    
  </ul>
</nav>


  <footer class="post-footer">
    
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>API</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>webaccess</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>Visual TOM</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>VTOM</a>
      
    
    <span  itemprop="author publisher" class="hidden">Virtual Thom</span>
  </footer>
  
  <div id="disqus_thread" ></div>
  <script>
      var disqus_shortname = atob('dGhvbWFzLWFzbmFy'); 
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
</div>

      <footer id="site-footer">
    <div>&copy;<a href="https://github.com/virtual-thom/" title="Github Virtual-Thom">Virtual-Thom</a></div>
    <div>
            <a href="https://virtual-thom.github.io/archives/plan" title="Plan du site">sitemap</a> | <a href="https://virtual-thom.github.io/about" rel="publisher author" title="Curriculum vitae Thom">A propos</a>
    </div>
    <div>
        <a id="goto-site-header" href="#site-header" title="Retourner au début">&uArr; Top</a>
    </div>
    <div id="footer-disclaimer">
        <p>Avertissement : vous ne devez pas prendre pour argent comptant le contenu de ce site. Testez toujours la solution en environnement de test.</p>
        <p>Malgré le sérieux que je m'efforce de mettre dans le contenu de ces billets, je ne pourrai être tenu responsable d'éventuelles erreurs que cela pourrait engendrer.</p>
    </div>
    <div>
        <a class="hidden" href="https://virtual-thom.github.io/archives/sitemap.xml" title="SiteMap">sitemap</a>
    </div>
</footer>

    </div>
  </body>

</html>