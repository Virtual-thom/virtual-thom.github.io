<!DOCTYPE html>
<html lang="fr">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="apple-touch-icon" href="https://virtual-thom.github.io/archives/apple-touch-icon.png">
  <link rel="icon" href="https://virtual-thom.github.io/archives/favicon.ico" />
  <!-- Remplacé par Jekyll SEO (sinon apparait en double)
  <title>vthttpd -dump et requêtes SQL - tlist ameliore - vtexport.xml to csv</title>
  <meta name="description" content="&lt;Article mis à jour&gt; J’ai rajouté pas mal de petites astuces sur cet article qui date de l’année dernière (filtre XSL - merci Joey pour l’inspiration !...">
  --> 
  
  <link rel="canonical" href="https://virtual-thom.github.io/archives/vthttpd-dump-requete-sql/">
  
  <link rel="stylesheet" media="screen" href="https://virtual-thom.github.io/archives/assets/main.css">
  
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>vthttpd -dump et requêtes SQL - tlist ameliore - vtexport.xml to csv | Virtual-Thom Blog-notes VTOM et informatique</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="vthttpd -dump et requêtes SQL - tlist ameliore - vtexport.xml to csv" />
<meta name="author" content="Virtual Thom" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="&lt;Article mis à jour&gt; J’ai rajouté pas mal de petites astuces sur cet article qui date de l’année dernière (filtre XSL - merci Joey pour l’inspiration !, parsing java, utilisation de Panda Python) Une autre astuce avec le Webaccess VTOM vthttpd : on peut dump tout le contenu de la base VTOM en un fichier exploitable par SQLITE ! L’utilisation principale est de lister tous les jobs, à la manière d’un tlistmais avec beaucoup plus d’informations (dont les paramètres et le script) Voici un petit exemple : vthttpd -dump /var/tmp/vthttpd.dat sqlite3 /var/tmp/vthttpd.dat &gt; .tables -- liste toutes les tables pragma table_info(JOBS) ; -- liste les champs de la table JOBS .schema JOBS ; -- idem mais avec le type de la colonne (varchar(35) par ex.) On peut exécuter un script .sql : sqlite3 /var/tmp/vthttpd.dat &lt; /var/tmp/monfichier.sql Et on grep sur ce qu’on souhaite select j.JOB_SID, e.NAME, a.NAME, j.NAME, j.COMMENT, j.FAMILY, j.SCRIPT, h.NAME, u.NAME, q.NAME, d.NAME, GROUP_CONCAT(p.VALUE,&#39;|&#39;) from jobs j left join applications a on j.APP_SID = a.APP_SID left join environments e on a.ENV_SID = e.ENV_SID left join hosts h on j.HOST_SID = h.HOST_SID or (ifnull(j.HOST_SID,&#39;&#39;) = &#39;&#39; and ( a.HOST_SID = h.HOST_SID or (ifnull(a.HOST_SID,&#39;&#39;) = &#39;&#39; and e.HOST_SID = h.HOST_SID) ) ) left join users u on j.USER_SID = u.USER_SID or (ifnull(j.USER_SID,&#39;&#39;) = &#39;&#39; and ( a.USER_SID = u.USER_SID or (ifnull(a.USER_SID,&#39;&#39;) = &#39;&#39; and e.USER_SID = u.USER_SID) ) ) left join queues q on j.QUEUE_SID = q.QUEUE_SID or (ifnull(j.QUEUE_SID,&#39;&#39;) = &#39;&#39; and ( a.QUEUE_SID = q.QUEUE_SID or (ifnull(a.QUEUE_SID,&#39;&#39;) = &#39;&#39; and e.QUEUE_SID = q.QUEUE_SID) ) ) left join dates d on j.DATE_SID = d.DATE_SID or (ifnull(j.DATE_SID,&#39;&#39;) = &#39;&#39; and ( a.DATE_SID = d.DATE_SID or (ifnull(a.DATE_SID,&#39;&#39;) = &#39;&#39; and e.DATE_SID = d.DATE_SID) ) ) left join job_parameters p on j.JOB_SID = p.JOB_SID group by j.JOB_SID ; ex. root@acf59c2005cf:/mnt/workspace/temp# sqlite3 vthttpd.dat &lt; all_jobs.sql JOBac1100030a411a8d570cf93000000004|exploitation|appli_test|job2|||jobok.bat|client_local|vtom|queue_ksh|date_exp| JOBac1100033f6aedb3570cf93000000002|exploitation|appli_test|job1|||jobok.bat|client_local|vtom|queue_ksh|date_exp|param1|param2|param3 JOBac1100036f024b9d570cf93000000006|exploitation|appli_test|job3|||jobok.bat|client_local|vtom|queue_ksh|date_exp| (exemple en Java, P.I je ne suis pas expert en Java - je suis tombé sur des machines qui n’avaient pas sqlite3 … Ca ne suit surement pas les bonnes pratiques JAva mais ça fonctionne) package top100_vthttpd_jobs_to_csv; import java.sql.Connection; import java.sql.DriverManager; import java.sql.ResultSet; import java.sql.Statement; public class Top100Main { public static void main(String[] args) { Connection c = null; Statement stmt = null; String sepCSV = &quot;,&quot; ; try { Class.forName(&quot;org.sqlite.JDBC&quot;); c = DriverManager.getConnection(&quot;jdbc:sqlite:D:\\workspace\\java\\top100_vthttpd_jobs_to_csv\\vthttpd.dat&quot;); c.setAutoCommit(false); stmt = c.createStatement(); String allJobs = &quot;select j.JOB_SID, e.NAME, a.NAME, j.NAME, j.COMMENT, j.FAMILY, j.SCRIPT, h.NAME, u.NAME, q.NAME, d.NAME, GROUP_CONCAT(p.VALUE,&#39;|&#39;)&quot; + &quot; from jobs j&quot; + &quot; left join applications a on j.APP_SID = a.APP_SID&quot; + &quot; left join environments e on a.ENV_SID = e.ENV_SID&quot; + &quot; left join hosts h on j.HOST_SID = h.HOST_SID or (ifnull(j.HOST_SID,&#39;&#39;) = &#39;&#39; and ( a.HOST_SID = h.HOST_SID or (ifnull(a.HOST_SID,&#39;&#39;) = &#39;&#39; and e.HOST_SID = h.HOST_SID) ) )&quot; + &quot; left join users u on j.USER_SID = u.USER_SID or (ifnull(j.USER_SID,&#39;&#39;) = &#39;&#39; and ( a.USER_SID = u.USER_SID or (ifnull(a.USER_SID,&#39;&#39;) = &#39;&#39; and e.USER_SID = u.USER_SID) ) )&quot; + &quot; left join queues q on j.QUEUE_SID = q.QUEUE_SID or (ifnull(j.QUEUE_SID,&#39;&#39;) = &#39;&#39; and ( a.QUEUE_SID = q.QUEUE_SID or (ifnull(a.QUEUE_SID,&#39;&#39;) = &#39;&#39; and e.QUEUE_SID = q.QUEUE_SID) ) )&quot; + &quot; left join dates d on j.DATE_SID = d.DATE_SID or (ifnull(j.DATE_SID,&#39;&#39;) = &#39;&#39; and ( a.DATE_SID = d.DATE_SID or (ifnull(a.DATE_SID,&#39;&#39;) = &#39;&#39; and e.DATE_SID = d.DATE_SID) ) )&quot; + &quot; left join job_parameters p on j.JOB_SID = p.JOB_SID&quot; + &quot; group by j.JOB_SID&quot; // + &quot; limit 10&quot; + &quot; ;&quot; ; ResultSet rs = stmt.executeQuery( allJobs ); while ( rs.next() ) { String jSID = rs.getString(1); String eName = rs.getString(2); String aName = rs.getString(3); String jName = rs.getString(4); String jComment = rs.getString(5); String jFamily = rs.getString(6); String jScript = rs.getString(7); String hName = rs.getString(8); String uName = rs.getString(9); String qName = rs.getString(10); String dName = rs.getString(11); String pValue = rs.getString(12); System.out.print( //jSID + sepCSV + eName + sepCSV + aName + sepCSV + jName + sepCSV + jComment + sepCSV + jFamily + sepCSV + jScript + sepCSV +hName + sepCSV + uName + sepCSV + qName + sepCSV + dName + sepCSV + pValue ); System.out.println(); } rs.close(); stmt.close(); c.close(); }catch ( Exception e ) { System.err.println( e.getClass().getName() + &quot;: &quot; + e.getMessage() ); System.exit(0); } } } Filtrer directement un fichier XML avec un fichier XSL et sortie en texte (pour du csv) J’avais déjà utilisé ce langage de transformation XSL mais il m’était complétement sorti de la tête. Merci à JOEY de m’avoir inspriré ! :) Fichier XSL de transformation (à adapter selon vos besoin) &lt;xsl:stylesheet version=&quot;2.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt; &lt;xsl:output method=&quot;text&quot; encoding=&quot;utf-8&quot; /&gt; &lt;!-- j&#39;utilise cette sortie pour constituer mon fichier CSV utilisé en tant que data pour load dans Oracle une table avec SQLLDR et un fichier de controle .ctl --&gt; &lt;!-- sqlldr do not set OPTIONALLY ENCLOSED BY &#39;&quot;&#39; because this char appears in comments and params LOAD DATA APPEND INTO TABLE nom_dela_table_oracle FIELDS TERMINATED BY &quot;£&quot; ( &quot;VTENVNAME&quot; CHAR, &quot;VTAPPLNAME&quot; CHAR, &quot;VTJOBNAME&quot; CHAR, &quot;APPMODE&quot; CHAR, &quot;JOBMODE&quot; CHAR, etc... ) --&gt; &lt;xsl:param name=&quot;delimCSV&quot; select=&quot;&#39;£&#39;&quot; /&gt;&lt;!-- j&#39;utilise ce char car il n&#39;est pas utilisé dans mon référentiel VTOM --&gt; &lt;xsl:param name=&quot;delimParam&quot; select=&quot;&#39;§&#39;&quot; /&gt; &lt;xsl:param name=&quot;break&quot; select=&quot;&#39;&amp;#xA;&#39;&quot; /&gt; &lt;!-- &lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; --&gt; &lt;xsl:template match=&quot;/&quot;&gt; &lt;xsl:apply-templates select=&quot;Domain/Environments/Environment/Applications/Application/Jobs/Job&quot; /&gt; &lt;/xsl:template&gt; &lt;!-- All Job node for root node --&gt; &lt;xsl:template match=&quot;Domain/Environments/Environment/Applications/Application/Jobs/Job&quot;&gt; &lt;xsl:value-of select=&quot;../../../../@name&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- EnvironmentName --&gt; &lt;xsl:value-of select=&quot;../../@name&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- ApplicationName --&gt; &lt;xsl:value-of select=&quot;@name&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- JobName --&gt; &lt;xsl:value-of select=&quot;../../@mode&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- ApplicationMode --&gt; &lt;xsl:value-of select=&quot;@mode&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- JobMode --&gt; &lt;xsl:value-of select=&quot;../../@onDemand&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- ApplicationOnDemand --&gt; &lt;xsl:value-of select=&quot;@onDemand&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- JobOnDemand --&gt; &lt;xsl:value-of select=&quot;Script/text()&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- Script --&gt; &lt;xsl:apply-templates select=&quot;Parameters/Parameter&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- Parameters --&gt; &lt;xsl:value-of select=&quot;../../../../../../@name&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- DomainName --&gt; &lt;xsl:value-of select=&quot;$break&quot; /&gt; &lt;/xsl:template&gt; &lt;!-- All Parameter node for Job node --&gt; &lt;xsl:template match=&quot;Parameters/Parameter&quot;&gt; &lt;xsl:value-of select=&quot;text()&quot; /&gt;&lt;xsl:value-of select=&quot;$delimParam&quot; /&gt; &lt;!-- Parameter --&gt; &lt;/xsl:template&gt; &lt;/xsl:stylesheet&gt; Pour appliquer le fichier XSL au fichier XML vtexport VTOM, on peut faire ça assez simplement avec une class Java (Stylizer) fournie par Oracle. Si vous voulez plus d’information sur la classe et la télécharger, voici le lien Oracle Transforming XML Data with XSLT. # Compiler le code source java pour créer votre class Stylizer.class, A ne faire qu&#39;une fois. La classe doit se trouver dans votre CLASSPATH (variable d&#39;environnement) javac Stylizer.java # Lancer la commande pour transformer votre XML avec le fichier XSL java Stylizer votrefichier.xsl vtorefichier.xml Parser le vtexport XML VTOM en “pur” Java (un peu long) package vtexport_xml_to_csv; import java.io.File; import java.io.FileWriter ; import java.io.IOException; import java.util.Date; import javax.xml.parsers.DocumentBuilder; import javax.xml.parsers.DocumentBuilderFactory; import javax.xml.parsers.ParserConfigurationException; import javax.xml.xpath.XPath; import javax.xml.xpath.XPathFactory; import javax.xml.xpath.XPathConstants ; import javax.xml.xpath.XPathExpressionException; import org.w3c.dom.Document; import org.w3c.dom.NodeList; import org.w3c.dom.Node; import org.xml.sax.SAXException; public class VtexportXML { private static String xmlPath ; private static Document document; private static final String separateurCSV = &quot;£&quot; ; private static final String separateurEscape = &quot;§&quot; ; private static String domainName; public static void main(String[] args) throws ParserConfigurationException, SAXException, IOException, XPathExpressionException { if (args.length == 1) { setXmlPath(args[0]); }else{ System.err.println(&quot;Usage : 1 paramètre nécessaire&quot;); System.err.println(&quot;1 : chemin complet du fichier xml&quot;); System.exit(1); } final DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance(); final DocumentBuilder builder = factory.newDocumentBuilder(); setDocument( builder.parse( new File( getXmlPath() ) ) ); listAllJobs(); } public static String getXmlPath() { return xmlPath; } public static void setXmlPath(String xmlPath) { VtexportXML.xmlPath = xmlPath; } public static Document getDocument() { return document; } public static void setDocument(Document document) { VtexportXML.document = document; } public static void listAllJobs() throws XPathExpressionException, IOException{ System.out.println(new Date()) ; File file = new File(getXmlPath() + &quot;.txt&quot;); // creates the file file.createNewFile(); // creates a FileWriter Object FileWriter writer = new FileWriter(file); // xPath instance XPath xPath = XPathFactory.newInstance().newXPath(); // set DomainName setDomainName((String) xPath.compile(&quot;/Domain/@name&quot;).evaluate( getDocument() ) ); // get all nodelist job NodeList nodeList = (NodeList) xPath.compile(&quot;/Domain/Environments/Environment/Applications/Application/Jobs/Job&quot;).evaluate(getDocument(),XPathConstants.NODESET); int percentDone = 1 ; System.out.print(&quot;0%.&quot;); // loop over nodelist job for(int i = 0; i &lt; nodeList.getLength() ; i++){ // print evolution running script % if(! ( (i * 100 / nodeList.getLength()) &lt; percentDone ) ){ percentDone++ ; if(percentDone % 10 == 0){ System.out.print(percentDone + &quot;%&quot;); }else{ System.out.print(&quot;.&quot;); } } // job node Node jobNode = (Node) nodeList.item(i) ; // nodelist parameters NodeList parametersNodes = (NodeList) xPath.evaluate(&quot;Parameters/Parameter&quot;,jobNode,XPathConstants.NODESET) ; String[] parameters = new String [ parametersNodes.getLength() ] ; // all parameters as an Array for(int j = 0 ; j &lt; parametersNodes.getLength() ; j++){ parameters[j] = ((Node) parametersNodes.item(j)).getTextContent() ; } writer.write( separateurEscape + xPath.evaluate(&quot;../../../../@name&quot;, jobNode) + separateurEscape + separateurCSV + // envName separateurEscape + xPath.evaluate(&quot;../../@name&quot;, jobNode) + separateurEscape + separateurCSV + // appName separateurEscape + xPath.evaluate(&quot;@name&quot;, jobNode) + separateurEscape + separateurCSV + // jobName separateurEscape + xPath.evaluate(&quot;../../@mode&quot;, jobNode) + separateurEscape + separateurCSV + // AppMode separateurEscape + xPath.evaluate(&quot;@mode&quot;, jobNode) + separateurEscape + separateurCSV + // JobMode separateurEscape + xPath.evaluate(&quot;../../@onDemand&quot;, jobNode) + separateurEscape + separateurCSV + // AppOnDemand separateurEscape + xPath.evaluate(&quot;@onDemand&quot;, jobNode) + separateurEscape + separateurCSV + // JobOnDemand separateurEscape + xPath.evaluate(&quot;Script&quot;,jobNode) + separateurEscape + separateurCSV + // Script separateurEscape + String.join(&quot;|&quot;, parameters) + separateurEscape + separateurCSV + // Parameters separateurEscape + getDomainName() + separateurEscape + separateurCSV // DomainName + &quot;\n&quot; ); } // Flush the content to the file writer.flush(); writer.close(); // print prompt running script System.out.println(); System.out.println(&quot;Fichier en sortie : &quot; + file.getAbsolutePath()); System.out.println(new Date() + &quot; The end&quot;); } public static String getDomainName() { return domainName; } public static void setDomainName(String domainName) { VtexportXML.domainName = domainName; } } Autre pour moi Reminder pour moi : consolidation des statistiques VTOM (en attendant que tout soit dans la base postgres, je passe par le vthttpd dump) plateforme=up2 vthttpdDat=vthttpd_${plateforme}.dat allJobsSQL=all_jobs.sql allJobs1to1=all_jobsSID_1to1Param_${plateforme}.txt allJobsManyTo1=all_jobsSID_manyTo1Param_${plateforme}.txt outputStats=stats_${plateforme} vtsgbdPort=30509 hostFilter=HOST1 test -f $vthttpdDat &amp;&amp; rm $vthttpdDat vthttpd -dump $vthttpdDat sqlite3 $vthttpdDat &lt; $allJobsSQL | awk &#39;BEGIN{ FS=&quot;|&quot; ; OFS=&quot;|&quot; } { l=length($10) ; if(l == 2) { $10=&quot;0&quot;$10 ;} ; if(l == 1){ $10=&quot;00&quot;$10 } ; print}&#39; | sort -g &gt; $allJobs1to1 ### All jobs manyto1 parameters awk -F &quot;|&quot; &#39;BEGIN{ job_sid=null;} {if($1 == job_sid){ printf &quot;|%s&quot;,$11 }else{ if(job_sid != null){ printf &quot;\n&quot; } ; printf &quot;%s|%s|%s|%s|%s|%s|%s|%s|%s|%s&quot;,$1,$2,$3,$4,$5,$6,$7,$8,$9,$11 } ; job_sid=$1 ;}&#39; $allJobs1to1 | sort &gt; $allJobsManyTo1 # get stats with filters (modify where clauses) # select vtobjectsid,vtenvname, vtapplname, vtjobname, vtbegin, (vtend::timestamp - vtbegin::timestamp), vtend, vtexpdatevalue, vthostname, vtusername, vtbqueuename, vtdatename,vtstatus, vterrmess ~/sgbd/bin/psql -d vtom -p $vtsgbdPort &lt;&lt; EOF \pset tuples_only \pset footer off \a \o $outputStats select vtobjectsid,vtbegin,(vtend::timestamp - vtbegin::timestamp),vtend,vtexpdatevalue,vtstatus,vterrmess from vt_stats_job where vthostname = &#39;$hostFilter&#39; and (vtend::timestamp - vtbegin::timestamp) &gt;= &#39;00:10:00&#39; order by (vtend::timestamp - vtbegin::timestamp) ; EOF Très long avec Awk (beaucoup d’itération :x) awk -v fic=$allJobsManyTo1 &#39;BEGIN{ OFS=&quot;|&quot;;FS=&quot;|&quot;; i=0 ; while ((getline line &lt; fic ) &gt; 0){ tAllJobsManyTo1[i]=line ; i++ ; } close (fic) ; }{ if($1 ~ /^APP/){ print $0; next } jobSID=$1 ; lineStats=$0 ; for (i in tAllJobsManyTo1){ split(tAllJobsManyTo1[i],tLine,&quot;|&quot;); if( tLine[1] == jobSID ){ script=tLine[5] ; printf &quot;%s|%s\n&quot;,lineStats,script ; delete tAllJobsManyTo1[i] ; break; } } }&#39; /var/tmp/stats Beaucoup plus rapide avec Pandas - Python : import pandas my_cols_csv1 = [ &quot;vtobjectsid&quot;,&quot;vtbegin&quot;,&quot;vtduration&quot;,&quot;vtend&quot;,&quot;vtexpdatevalue&quot;,&quot;vtstatus&quot;,&quot;vterrmess&quot; ] csv1 = pandas.read_csv(&#39;stats_up2&#39;,delimiter=r&quot;|&quot;,names=my_cols_csv1) my_cols=[&quot;vtobjectsid&quot;,&quot;env&quot;,&quot;app&quot;,&quot;job&quot;,&quot;script&quot;,&quot;host&quot;,&quot;user&quot;,&quot;queue&quot;,&quot;vtdatename&quot;,&quot;param&quot;] my_cols=my_cols + range(150) csv2 = pandas.read_csv(&#39;all_jobsSID_manyTo1Param_up2.txt&#39;,names=my_cols, sep=&quot;|&quot;) merge = pandas.merge(csv1,csv2, on=&#39;vtobjectsid&#39;) merge.to_csv(&quot;output.csv&quot;) vtobjectsid vtbegin vtduration vtend vtexpdatevalue vtstatus vterrmess env app job script host user queue vtdatename param 0 JOB7ef5b39400006ad956a6113e00014e22 19/03/2016 03:58 00:10:00 19/03/2016 04:08 19/03/2016 3 Termine a 04:08:30 ENV1 poz12daj1 p800ostp1 PATH_DWH_SHELL/OSEF_odi.ksh HOST1 prdwh12 queue_ksh ENV1J_12_rdwh 1 JOB7ef5b39400006ad956a6113e00014e22 03/03/2016 03:29 00:12:24 03/03/2016 03:42 03/03/2016 3 Termine a 03:42:17 ENV1 poz12daj1 p800ostp1 PATH_DWH_SHELL/OSEF_odi.ksh HOST1 prdwh12 queue_ksh ENV1_12_rdwh" />
<meta property="og:description" content="&lt;Article mis à jour&gt; J’ai rajouté pas mal de petites astuces sur cet article qui date de l’année dernière (filtre XSL - merci Joey pour l’inspiration !, parsing java, utilisation de Panda Python) Une autre astuce avec le Webaccess VTOM vthttpd : on peut dump tout le contenu de la base VTOM en un fichier exploitable par SQLITE ! L’utilisation principale est de lister tous les jobs, à la manière d’un tlistmais avec beaucoup plus d’informations (dont les paramètres et le script) Voici un petit exemple : vthttpd -dump /var/tmp/vthttpd.dat sqlite3 /var/tmp/vthttpd.dat &gt; .tables -- liste toutes les tables pragma table_info(JOBS) ; -- liste les champs de la table JOBS .schema JOBS ; -- idem mais avec le type de la colonne (varchar(35) par ex.) On peut exécuter un script .sql : sqlite3 /var/tmp/vthttpd.dat &lt; /var/tmp/monfichier.sql Et on grep sur ce qu’on souhaite select j.JOB_SID, e.NAME, a.NAME, j.NAME, j.COMMENT, j.FAMILY, j.SCRIPT, h.NAME, u.NAME, q.NAME, d.NAME, GROUP_CONCAT(p.VALUE,&#39;|&#39;) from jobs j left join applications a on j.APP_SID = a.APP_SID left join environments e on a.ENV_SID = e.ENV_SID left join hosts h on j.HOST_SID = h.HOST_SID or (ifnull(j.HOST_SID,&#39;&#39;) = &#39;&#39; and ( a.HOST_SID = h.HOST_SID or (ifnull(a.HOST_SID,&#39;&#39;) = &#39;&#39; and e.HOST_SID = h.HOST_SID) ) ) left join users u on j.USER_SID = u.USER_SID or (ifnull(j.USER_SID,&#39;&#39;) = &#39;&#39; and ( a.USER_SID = u.USER_SID or (ifnull(a.USER_SID,&#39;&#39;) = &#39;&#39; and e.USER_SID = u.USER_SID) ) ) left join queues q on j.QUEUE_SID = q.QUEUE_SID or (ifnull(j.QUEUE_SID,&#39;&#39;) = &#39;&#39; and ( a.QUEUE_SID = q.QUEUE_SID or (ifnull(a.QUEUE_SID,&#39;&#39;) = &#39;&#39; and e.QUEUE_SID = q.QUEUE_SID) ) ) left join dates d on j.DATE_SID = d.DATE_SID or (ifnull(j.DATE_SID,&#39;&#39;) = &#39;&#39; and ( a.DATE_SID = d.DATE_SID or (ifnull(a.DATE_SID,&#39;&#39;) = &#39;&#39; and e.DATE_SID = d.DATE_SID) ) ) left join job_parameters p on j.JOB_SID = p.JOB_SID group by j.JOB_SID ; ex. root@acf59c2005cf:/mnt/workspace/temp# sqlite3 vthttpd.dat &lt; all_jobs.sql JOBac1100030a411a8d570cf93000000004|exploitation|appli_test|job2|||jobok.bat|client_local|vtom|queue_ksh|date_exp| JOBac1100033f6aedb3570cf93000000002|exploitation|appli_test|job1|||jobok.bat|client_local|vtom|queue_ksh|date_exp|param1|param2|param3 JOBac1100036f024b9d570cf93000000006|exploitation|appli_test|job3|||jobok.bat|client_local|vtom|queue_ksh|date_exp| (exemple en Java, P.I je ne suis pas expert en Java - je suis tombé sur des machines qui n’avaient pas sqlite3 … Ca ne suit surement pas les bonnes pratiques JAva mais ça fonctionne) package top100_vthttpd_jobs_to_csv; import java.sql.Connection; import java.sql.DriverManager; import java.sql.ResultSet; import java.sql.Statement; public class Top100Main { public static void main(String[] args) { Connection c = null; Statement stmt = null; String sepCSV = &quot;,&quot; ; try { Class.forName(&quot;org.sqlite.JDBC&quot;); c = DriverManager.getConnection(&quot;jdbc:sqlite:D:\\workspace\\java\\top100_vthttpd_jobs_to_csv\\vthttpd.dat&quot;); c.setAutoCommit(false); stmt = c.createStatement(); String allJobs = &quot;select j.JOB_SID, e.NAME, a.NAME, j.NAME, j.COMMENT, j.FAMILY, j.SCRIPT, h.NAME, u.NAME, q.NAME, d.NAME, GROUP_CONCAT(p.VALUE,&#39;|&#39;)&quot; + &quot; from jobs j&quot; + &quot; left join applications a on j.APP_SID = a.APP_SID&quot; + &quot; left join environments e on a.ENV_SID = e.ENV_SID&quot; + &quot; left join hosts h on j.HOST_SID = h.HOST_SID or (ifnull(j.HOST_SID,&#39;&#39;) = &#39;&#39; and ( a.HOST_SID = h.HOST_SID or (ifnull(a.HOST_SID,&#39;&#39;) = &#39;&#39; and e.HOST_SID = h.HOST_SID) ) )&quot; + &quot; left join users u on j.USER_SID = u.USER_SID or (ifnull(j.USER_SID,&#39;&#39;) = &#39;&#39; and ( a.USER_SID = u.USER_SID or (ifnull(a.USER_SID,&#39;&#39;) = &#39;&#39; and e.USER_SID = u.USER_SID) ) )&quot; + &quot; left join queues q on j.QUEUE_SID = q.QUEUE_SID or (ifnull(j.QUEUE_SID,&#39;&#39;) = &#39;&#39; and ( a.QUEUE_SID = q.QUEUE_SID or (ifnull(a.QUEUE_SID,&#39;&#39;) = &#39;&#39; and e.QUEUE_SID = q.QUEUE_SID) ) )&quot; + &quot; left join dates d on j.DATE_SID = d.DATE_SID or (ifnull(j.DATE_SID,&#39;&#39;) = &#39;&#39; and ( a.DATE_SID = d.DATE_SID or (ifnull(a.DATE_SID,&#39;&#39;) = &#39;&#39; and e.DATE_SID = d.DATE_SID) ) )&quot; + &quot; left join job_parameters p on j.JOB_SID = p.JOB_SID&quot; + &quot; group by j.JOB_SID&quot; // + &quot; limit 10&quot; + &quot; ;&quot; ; ResultSet rs = stmt.executeQuery( allJobs ); while ( rs.next() ) { String jSID = rs.getString(1); String eName = rs.getString(2); String aName = rs.getString(3); String jName = rs.getString(4); String jComment = rs.getString(5); String jFamily = rs.getString(6); String jScript = rs.getString(7); String hName = rs.getString(8); String uName = rs.getString(9); String qName = rs.getString(10); String dName = rs.getString(11); String pValue = rs.getString(12); System.out.print( //jSID + sepCSV + eName + sepCSV + aName + sepCSV + jName + sepCSV + jComment + sepCSV + jFamily + sepCSV + jScript + sepCSV +hName + sepCSV + uName + sepCSV + qName + sepCSV + dName + sepCSV + pValue ); System.out.println(); } rs.close(); stmt.close(); c.close(); }catch ( Exception e ) { System.err.println( e.getClass().getName() + &quot;: &quot; + e.getMessage() ); System.exit(0); } } } Filtrer directement un fichier XML avec un fichier XSL et sortie en texte (pour du csv) J’avais déjà utilisé ce langage de transformation XSL mais il m’était complétement sorti de la tête. Merci à JOEY de m’avoir inspriré ! :) Fichier XSL de transformation (à adapter selon vos besoin) &lt;xsl:stylesheet version=&quot;2.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt; &lt;xsl:output method=&quot;text&quot; encoding=&quot;utf-8&quot; /&gt; &lt;!-- j&#39;utilise cette sortie pour constituer mon fichier CSV utilisé en tant que data pour load dans Oracle une table avec SQLLDR et un fichier de controle .ctl --&gt; &lt;!-- sqlldr do not set OPTIONALLY ENCLOSED BY &#39;&quot;&#39; because this char appears in comments and params LOAD DATA APPEND INTO TABLE nom_dela_table_oracle FIELDS TERMINATED BY &quot;£&quot; ( &quot;VTENVNAME&quot; CHAR, &quot;VTAPPLNAME&quot; CHAR, &quot;VTJOBNAME&quot; CHAR, &quot;APPMODE&quot; CHAR, &quot;JOBMODE&quot; CHAR, etc... ) --&gt; &lt;xsl:param name=&quot;delimCSV&quot; select=&quot;&#39;£&#39;&quot; /&gt;&lt;!-- j&#39;utilise ce char car il n&#39;est pas utilisé dans mon référentiel VTOM --&gt; &lt;xsl:param name=&quot;delimParam&quot; select=&quot;&#39;§&#39;&quot; /&gt; &lt;xsl:param name=&quot;break&quot; select=&quot;&#39;&amp;#xA;&#39;&quot; /&gt; &lt;!-- &lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; --&gt; &lt;xsl:template match=&quot;/&quot;&gt; &lt;xsl:apply-templates select=&quot;Domain/Environments/Environment/Applications/Application/Jobs/Job&quot; /&gt; &lt;/xsl:template&gt; &lt;!-- All Job node for root node --&gt; &lt;xsl:template match=&quot;Domain/Environments/Environment/Applications/Application/Jobs/Job&quot;&gt; &lt;xsl:value-of select=&quot;../../../../@name&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- EnvironmentName --&gt; &lt;xsl:value-of select=&quot;../../@name&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- ApplicationName --&gt; &lt;xsl:value-of select=&quot;@name&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- JobName --&gt; &lt;xsl:value-of select=&quot;../../@mode&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- ApplicationMode --&gt; &lt;xsl:value-of select=&quot;@mode&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- JobMode --&gt; &lt;xsl:value-of select=&quot;../../@onDemand&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- ApplicationOnDemand --&gt; &lt;xsl:value-of select=&quot;@onDemand&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- JobOnDemand --&gt; &lt;xsl:value-of select=&quot;Script/text()&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- Script --&gt; &lt;xsl:apply-templates select=&quot;Parameters/Parameter&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- Parameters --&gt; &lt;xsl:value-of select=&quot;../../../../../../@name&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- DomainName --&gt; &lt;xsl:value-of select=&quot;$break&quot; /&gt; &lt;/xsl:template&gt; &lt;!-- All Parameter node for Job node --&gt; &lt;xsl:template match=&quot;Parameters/Parameter&quot;&gt; &lt;xsl:value-of select=&quot;text()&quot; /&gt;&lt;xsl:value-of select=&quot;$delimParam&quot; /&gt; &lt;!-- Parameter --&gt; &lt;/xsl:template&gt; &lt;/xsl:stylesheet&gt; Pour appliquer le fichier XSL au fichier XML vtexport VTOM, on peut faire ça assez simplement avec une class Java (Stylizer) fournie par Oracle. Si vous voulez plus d’information sur la classe et la télécharger, voici le lien Oracle Transforming XML Data with XSLT. # Compiler le code source java pour créer votre class Stylizer.class, A ne faire qu&#39;une fois. La classe doit se trouver dans votre CLASSPATH (variable d&#39;environnement) javac Stylizer.java # Lancer la commande pour transformer votre XML avec le fichier XSL java Stylizer votrefichier.xsl vtorefichier.xml Parser le vtexport XML VTOM en “pur” Java (un peu long) package vtexport_xml_to_csv; import java.io.File; import java.io.FileWriter ; import java.io.IOException; import java.util.Date; import javax.xml.parsers.DocumentBuilder; import javax.xml.parsers.DocumentBuilderFactory; import javax.xml.parsers.ParserConfigurationException; import javax.xml.xpath.XPath; import javax.xml.xpath.XPathFactory; import javax.xml.xpath.XPathConstants ; import javax.xml.xpath.XPathExpressionException; import org.w3c.dom.Document; import org.w3c.dom.NodeList; import org.w3c.dom.Node; import org.xml.sax.SAXException; public class VtexportXML { private static String xmlPath ; private static Document document; private static final String separateurCSV = &quot;£&quot; ; private static final String separateurEscape = &quot;§&quot; ; private static String domainName; public static void main(String[] args) throws ParserConfigurationException, SAXException, IOException, XPathExpressionException { if (args.length == 1) { setXmlPath(args[0]); }else{ System.err.println(&quot;Usage : 1 paramètre nécessaire&quot;); System.err.println(&quot;1 : chemin complet du fichier xml&quot;); System.exit(1); } final DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance(); final DocumentBuilder builder = factory.newDocumentBuilder(); setDocument( builder.parse( new File( getXmlPath() ) ) ); listAllJobs(); } public static String getXmlPath() { return xmlPath; } public static void setXmlPath(String xmlPath) { VtexportXML.xmlPath = xmlPath; } public static Document getDocument() { return document; } public static void setDocument(Document document) { VtexportXML.document = document; } public static void listAllJobs() throws XPathExpressionException, IOException{ System.out.println(new Date()) ; File file = new File(getXmlPath() + &quot;.txt&quot;); // creates the file file.createNewFile(); // creates a FileWriter Object FileWriter writer = new FileWriter(file); // xPath instance XPath xPath = XPathFactory.newInstance().newXPath(); // set DomainName setDomainName((String) xPath.compile(&quot;/Domain/@name&quot;).evaluate( getDocument() ) ); // get all nodelist job NodeList nodeList = (NodeList) xPath.compile(&quot;/Domain/Environments/Environment/Applications/Application/Jobs/Job&quot;).evaluate(getDocument(),XPathConstants.NODESET); int percentDone = 1 ; System.out.print(&quot;0%.&quot;); // loop over nodelist job for(int i = 0; i &lt; nodeList.getLength() ; i++){ // print evolution running script % if(! ( (i * 100 / nodeList.getLength()) &lt; percentDone ) ){ percentDone++ ; if(percentDone % 10 == 0){ System.out.print(percentDone + &quot;%&quot;); }else{ System.out.print(&quot;.&quot;); } } // job node Node jobNode = (Node) nodeList.item(i) ; // nodelist parameters NodeList parametersNodes = (NodeList) xPath.evaluate(&quot;Parameters/Parameter&quot;,jobNode,XPathConstants.NODESET) ; String[] parameters = new String [ parametersNodes.getLength() ] ; // all parameters as an Array for(int j = 0 ; j &lt; parametersNodes.getLength() ; j++){ parameters[j] = ((Node) parametersNodes.item(j)).getTextContent() ; } writer.write( separateurEscape + xPath.evaluate(&quot;../../../../@name&quot;, jobNode) + separateurEscape + separateurCSV + // envName separateurEscape + xPath.evaluate(&quot;../../@name&quot;, jobNode) + separateurEscape + separateurCSV + // appName separateurEscape + xPath.evaluate(&quot;@name&quot;, jobNode) + separateurEscape + separateurCSV + // jobName separateurEscape + xPath.evaluate(&quot;../../@mode&quot;, jobNode) + separateurEscape + separateurCSV + // AppMode separateurEscape + xPath.evaluate(&quot;@mode&quot;, jobNode) + separateurEscape + separateurCSV + // JobMode separateurEscape + xPath.evaluate(&quot;../../@onDemand&quot;, jobNode) + separateurEscape + separateurCSV + // AppOnDemand separateurEscape + xPath.evaluate(&quot;@onDemand&quot;, jobNode) + separateurEscape + separateurCSV + // JobOnDemand separateurEscape + xPath.evaluate(&quot;Script&quot;,jobNode) + separateurEscape + separateurCSV + // Script separateurEscape + String.join(&quot;|&quot;, parameters) + separateurEscape + separateurCSV + // Parameters separateurEscape + getDomainName() + separateurEscape + separateurCSV // DomainName + &quot;\n&quot; ); } // Flush the content to the file writer.flush(); writer.close(); // print prompt running script System.out.println(); System.out.println(&quot;Fichier en sortie : &quot; + file.getAbsolutePath()); System.out.println(new Date() + &quot; The end&quot;); } public static String getDomainName() { return domainName; } public static void setDomainName(String domainName) { VtexportXML.domainName = domainName; } } Autre pour moi Reminder pour moi : consolidation des statistiques VTOM (en attendant que tout soit dans la base postgres, je passe par le vthttpd dump) plateforme=up2 vthttpdDat=vthttpd_${plateforme}.dat allJobsSQL=all_jobs.sql allJobs1to1=all_jobsSID_1to1Param_${plateforme}.txt allJobsManyTo1=all_jobsSID_manyTo1Param_${plateforme}.txt outputStats=stats_${plateforme} vtsgbdPort=30509 hostFilter=HOST1 test -f $vthttpdDat &amp;&amp; rm $vthttpdDat vthttpd -dump $vthttpdDat sqlite3 $vthttpdDat &lt; $allJobsSQL | awk &#39;BEGIN{ FS=&quot;|&quot; ; OFS=&quot;|&quot; } { l=length($10) ; if(l == 2) { $10=&quot;0&quot;$10 ;} ; if(l == 1){ $10=&quot;00&quot;$10 } ; print}&#39; | sort -g &gt; $allJobs1to1 ### All jobs manyto1 parameters awk -F &quot;|&quot; &#39;BEGIN{ job_sid=null;} {if($1 == job_sid){ printf &quot;|%s&quot;,$11 }else{ if(job_sid != null){ printf &quot;\n&quot; } ; printf &quot;%s|%s|%s|%s|%s|%s|%s|%s|%s|%s&quot;,$1,$2,$3,$4,$5,$6,$7,$8,$9,$11 } ; job_sid=$1 ;}&#39; $allJobs1to1 | sort &gt; $allJobsManyTo1 # get stats with filters (modify where clauses) # select vtobjectsid,vtenvname, vtapplname, vtjobname, vtbegin, (vtend::timestamp - vtbegin::timestamp), vtend, vtexpdatevalue, vthostname, vtusername, vtbqueuename, vtdatename,vtstatus, vterrmess ~/sgbd/bin/psql -d vtom -p $vtsgbdPort &lt;&lt; EOF \pset tuples_only \pset footer off \a \o $outputStats select vtobjectsid,vtbegin,(vtend::timestamp - vtbegin::timestamp),vtend,vtexpdatevalue,vtstatus,vterrmess from vt_stats_job where vthostname = &#39;$hostFilter&#39; and (vtend::timestamp - vtbegin::timestamp) &gt;= &#39;00:10:00&#39; order by (vtend::timestamp - vtbegin::timestamp) ; EOF Très long avec Awk (beaucoup d’itération :x) awk -v fic=$allJobsManyTo1 &#39;BEGIN{ OFS=&quot;|&quot;;FS=&quot;|&quot;; i=0 ; while ((getline line &lt; fic ) &gt; 0){ tAllJobsManyTo1[i]=line ; i++ ; } close (fic) ; }{ if($1 ~ /^APP/){ print $0; next } jobSID=$1 ; lineStats=$0 ; for (i in tAllJobsManyTo1){ split(tAllJobsManyTo1[i],tLine,&quot;|&quot;); if( tLine[1] == jobSID ){ script=tLine[5] ; printf &quot;%s|%s\n&quot;,lineStats,script ; delete tAllJobsManyTo1[i] ; break; } } }&#39; /var/tmp/stats Beaucoup plus rapide avec Pandas - Python : import pandas my_cols_csv1 = [ &quot;vtobjectsid&quot;,&quot;vtbegin&quot;,&quot;vtduration&quot;,&quot;vtend&quot;,&quot;vtexpdatevalue&quot;,&quot;vtstatus&quot;,&quot;vterrmess&quot; ] csv1 = pandas.read_csv(&#39;stats_up2&#39;,delimiter=r&quot;|&quot;,names=my_cols_csv1) my_cols=[&quot;vtobjectsid&quot;,&quot;env&quot;,&quot;app&quot;,&quot;job&quot;,&quot;script&quot;,&quot;host&quot;,&quot;user&quot;,&quot;queue&quot;,&quot;vtdatename&quot;,&quot;param&quot;] my_cols=my_cols + range(150) csv2 = pandas.read_csv(&#39;all_jobsSID_manyTo1Param_up2.txt&#39;,names=my_cols, sep=&quot;|&quot;) merge = pandas.merge(csv1,csv2, on=&#39;vtobjectsid&#39;) merge.to_csv(&quot;output.csv&quot;) vtobjectsid vtbegin vtduration vtend vtexpdatevalue vtstatus vterrmess env app job script host user queue vtdatename param 0 JOB7ef5b39400006ad956a6113e00014e22 19/03/2016 03:58 00:10:00 19/03/2016 04:08 19/03/2016 3 Termine a 04:08:30 ENV1 poz12daj1 p800ostp1 PATH_DWH_SHELL/OSEF_odi.ksh HOST1 prdwh12 queue_ksh ENV1J_12_rdwh 1 JOB7ef5b39400006ad956a6113e00014e22 03/03/2016 03:29 00:12:24 03/03/2016 03:42 03/03/2016 3 Termine a 03:42:17 ENV1 poz12daj1 p800ostp1 PATH_DWH_SHELL/OSEF_odi.ksh HOST1 prdwh12 queue_ksh ENV1_12_rdwh" />
<link rel="canonical" href="https://virtual-thom.github.io/archives/vthttpd-dump-requete-sql/" />
<meta property="og:url" content="https://virtual-thom.github.io/archives/vthttpd-dump-requete-sql/" />
<meta property="og:site_name" content="Virtual-Thom Blog-notes VTOM et informatique" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-09-21T22:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="vthttpd -dump et requêtes SQL - tlist ameliore - vtexport.xml to csv" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Virtual Thom"},"dateModified":"2016-09-21T22:00:00+00:00","datePublished":"2016-09-21T22:00:00+00:00","description":"&lt;Article mis à jour&gt; J’ai rajouté pas mal de petites astuces sur cet article qui date de l’année dernière (filtre XSL - merci Joey pour l’inspiration !, parsing java, utilisation de Panda Python) Une autre astuce avec le Webaccess VTOM vthttpd : on peut dump tout le contenu de la base VTOM en un fichier exploitable par SQLITE ! L’utilisation principale est de lister tous les jobs, à la manière d’un tlistmais avec beaucoup plus d’informations (dont les paramètres et le script) Voici un petit exemple : vthttpd -dump /var/tmp/vthttpd.dat sqlite3 /var/tmp/vthttpd.dat &gt; .tables -- liste toutes les tables pragma table_info(JOBS) ; -- liste les champs de la table JOBS .schema JOBS ; -- idem mais avec le type de la colonne (varchar(35) par ex.) On peut exécuter un script .sql : sqlite3 /var/tmp/vthttpd.dat &lt; /var/tmp/monfichier.sql Et on grep sur ce qu’on souhaite select j.JOB_SID, e.NAME, a.NAME, j.NAME, j.COMMENT, j.FAMILY, j.SCRIPT, h.NAME, u.NAME, q.NAME, d.NAME, GROUP_CONCAT(p.VALUE,&#39;|&#39;) from jobs j left join applications a on j.APP_SID = a.APP_SID left join environments e on a.ENV_SID = e.ENV_SID left join hosts h on j.HOST_SID = h.HOST_SID or (ifnull(j.HOST_SID,&#39;&#39;) = &#39;&#39; and ( a.HOST_SID = h.HOST_SID or (ifnull(a.HOST_SID,&#39;&#39;) = &#39;&#39; and e.HOST_SID = h.HOST_SID) ) ) left join users u on j.USER_SID = u.USER_SID or (ifnull(j.USER_SID,&#39;&#39;) = &#39;&#39; and ( a.USER_SID = u.USER_SID or (ifnull(a.USER_SID,&#39;&#39;) = &#39;&#39; and e.USER_SID = u.USER_SID) ) ) left join queues q on j.QUEUE_SID = q.QUEUE_SID or (ifnull(j.QUEUE_SID,&#39;&#39;) = &#39;&#39; and ( a.QUEUE_SID = q.QUEUE_SID or (ifnull(a.QUEUE_SID,&#39;&#39;) = &#39;&#39; and e.QUEUE_SID = q.QUEUE_SID) ) ) left join dates d on j.DATE_SID = d.DATE_SID or (ifnull(j.DATE_SID,&#39;&#39;) = &#39;&#39; and ( a.DATE_SID = d.DATE_SID or (ifnull(a.DATE_SID,&#39;&#39;) = &#39;&#39; and e.DATE_SID = d.DATE_SID) ) ) left join job_parameters p on j.JOB_SID = p.JOB_SID group by j.JOB_SID ; ex. root@acf59c2005cf:/mnt/workspace/temp# sqlite3 vthttpd.dat &lt; all_jobs.sql JOBac1100030a411a8d570cf93000000004|exploitation|appli_test|job2|||jobok.bat|client_local|vtom|queue_ksh|date_exp| JOBac1100033f6aedb3570cf93000000002|exploitation|appli_test|job1|||jobok.bat|client_local|vtom|queue_ksh|date_exp|param1|param2|param3 JOBac1100036f024b9d570cf93000000006|exploitation|appli_test|job3|||jobok.bat|client_local|vtom|queue_ksh|date_exp| (exemple en Java, P.I je ne suis pas expert en Java - je suis tombé sur des machines qui n’avaient pas sqlite3 … Ca ne suit surement pas les bonnes pratiques JAva mais ça fonctionne) package top100_vthttpd_jobs_to_csv; import java.sql.Connection; import java.sql.DriverManager; import java.sql.ResultSet; import java.sql.Statement; public class Top100Main { public static void main(String[] args) { Connection c = null; Statement stmt = null; String sepCSV = &quot;,&quot; ; try { Class.forName(&quot;org.sqlite.JDBC&quot;); c = DriverManager.getConnection(&quot;jdbc:sqlite:D:\\\\workspace\\\\java\\\\top100_vthttpd_jobs_to_csv\\\\vthttpd.dat&quot;); c.setAutoCommit(false); stmt = c.createStatement(); String allJobs = &quot;select j.JOB_SID, e.NAME, a.NAME, j.NAME, j.COMMENT, j.FAMILY, j.SCRIPT, h.NAME, u.NAME, q.NAME, d.NAME, GROUP_CONCAT(p.VALUE,&#39;|&#39;)&quot; + &quot; from jobs j&quot; + &quot; left join applications a on j.APP_SID = a.APP_SID&quot; + &quot; left join environments e on a.ENV_SID = e.ENV_SID&quot; + &quot; left join hosts h on j.HOST_SID = h.HOST_SID or (ifnull(j.HOST_SID,&#39;&#39;) = &#39;&#39; and ( a.HOST_SID = h.HOST_SID or (ifnull(a.HOST_SID,&#39;&#39;) = &#39;&#39; and e.HOST_SID = h.HOST_SID) ) )&quot; + &quot; left join users u on j.USER_SID = u.USER_SID or (ifnull(j.USER_SID,&#39;&#39;) = &#39;&#39; and ( a.USER_SID = u.USER_SID or (ifnull(a.USER_SID,&#39;&#39;) = &#39;&#39; and e.USER_SID = u.USER_SID) ) )&quot; + &quot; left join queues q on j.QUEUE_SID = q.QUEUE_SID or (ifnull(j.QUEUE_SID,&#39;&#39;) = &#39;&#39; and ( a.QUEUE_SID = q.QUEUE_SID or (ifnull(a.QUEUE_SID,&#39;&#39;) = &#39;&#39; and e.QUEUE_SID = q.QUEUE_SID) ) )&quot; + &quot; left join dates d on j.DATE_SID = d.DATE_SID or (ifnull(j.DATE_SID,&#39;&#39;) = &#39;&#39; and ( a.DATE_SID = d.DATE_SID or (ifnull(a.DATE_SID,&#39;&#39;) = &#39;&#39; and e.DATE_SID = d.DATE_SID) ) )&quot; + &quot; left join job_parameters p on j.JOB_SID = p.JOB_SID&quot; + &quot; group by j.JOB_SID&quot; // + &quot; limit 10&quot; + &quot; ;&quot; ; ResultSet rs = stmt.executeQuery( allJobs ); while ( rs.next() ) { String jSID = rs.getString(1); String eName = rs.getString(2); String aName = rs.getString(3); String jName = rs.getString(4); String jComment = rs.getString(5); String jFamily = rs.getString(6); String jScript = rs.getString(7); String hName = rs.getString(8); String uName = rs.getString(9); String qName = rs.getString(10); String dName = rs.getString(11); String pValue = rs.getString(12); System.out.print( //jSID + sepCSV + eName + sepCSV + aName + sepCSV + jName + sepCSV + jComment + sepCSV + jFamily + sepCSV + jScript + sepCSV +hName + sepCSV + uName + sepCSV + qName + sepCSV + dName + sepCSV + pValue ); System.out.println(); } rs.close(); stmt.close(); c.close(); }catch ( Exception e ) { System.err.println( e.getClass().getName() + &quot;: &quot; + e.getMessage() ); System.exit(0); } } } Filtrer directement un fichier XML avec un fichier XSL et sortie en texte (pour du csv) J’avais déjà utilisé ce langage de transformation XSL mais il m’était complétement sorti de la tête. Merci à JOEY de m’avoir inspriré ! :) Fichier XSL de transformation (à adapter selon vos besoin) &lt;xsl:stylesheet version=&quot;2.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt; &lt;xsl:output method=&quot;text&quot; encoding=&quot;utf-8&quot; /&gt; &lt;!-- j&#39;utilise cette sortie pour constituer mon fichier CSV utilisé en tant que data pour load dans Oracle une table avec SQLLDR et un fichier de controle .ctl --&gt; &lt;!-- sqlldr do not set OPTIONALLY ENCLOSED BY &#39;&quot;&#39; because this char appears in comments and params LOAD DATA APPEND INTO TABLE nom_dela_table_oracle FIELDS TERMINATED BY &quot;£&quot; ( &quot;VTENVNAME&quot; CHAR, &quot;VTAPPLNAME&quot; CHAR, &quot;VTJOBNAME&quot; CHAR, &quot;APPMODE&quot; CHAR, &quot;JOBMODE&quot; CHAR, etc... ) --&gt; &lt;xsl:param name=&quot;delimCSV&quot; select=&quot;&#39;£&#39;&quot; /&gt;&lt;!-- j&#39;utilise ce char car il n&#39;est pas utilisé dans mon référentiel VTOM --&gt; &lt;xsl:param name=&quot;delimParam&quot; select=&quot;&#39;§&#39;&quot; /&gt; &lt;xsl:param name=&quot;break&quot; select=&quot;&#39;&amp;#xA;&#39;&quot; /&gt; &lt;!-- &lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; --&gt; &lt;xsl:template match=&quot;/&quot;&gt; &lt;xsl:apply-templates select=&quot;Domain/Environments/Environment/Applications/Application/Jobs/Job&quot; /&gt; &lt;/xsl:template&gt; &lt;!-- All Job node for root node --&gt; &lt;xsl:template match=&quot;Domain/Environments/Environment/Applications/Application/Jobs/Job&quot;&gt; &lt;xsl:value-of select=&quot;../../../../@name&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- EnvironmentName --&gt; &lt;xsl:value-of select=&quot;../../@name&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- ApplicationName --&gt; &lt;xsl:value-of select=&quot;@name&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- JobName --&gt; &lt;xsl:value-of select=&quot;../../@mode&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- ApplicationMode --&gt; &lt;xsl:value-of select=&quot;@mode&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- JobMode --&gt; &lt;xsl:value-of select=&quot;../../@onDemand&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- ApplicationOnDemand --&gt; &lt;xsl:value-of select=&quot;@onDemand&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- JobOnDemand --&gt; &lt;xsl:value-of select=&quot;Script/text()&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- Script --&gt; &lt;xsl:apply-templates select=&quot;Parameters/Parameter&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- Parameters --&gt; &lt;xsl:value-of select=&quot;../../../../../../@name&quot; /&gt;&lt;xsl:value-of select=&quot;$delimCSV&quot; /&gt; &lt;!-- DomainName --&gt; &lt;xsl:value-of select=&quot;$break&quot; /&gt; &lt;/xsl:template&gt; &lt;!-- All Parameter node for Job node --&gt; &lt;xsl:template match=&quot;Parameters/Parameter&quot;&gt; &lt;xsl:value-of select=&quot;text()&quot; /&gt;&lt;xsl:value-of select=&quot;$delimParam&quot; /&gt; &lt;!-- Parameter --&gt; &lt;/xsl:template&gt; &lt;/xsl:stylesheet&gt; Pour appliquer le fichier XSL au fichier XML vtexport VTOM, on peut faire ça assez simplement avec une class Java (Stylizer) fournie par Oracle. Si vous voulez plus d’information sur la classe et la télécharger, voici le lien Oracle Transforming XML Data with XSLT. # Compiler le code source java pour créer votre class Stylizer.class, A ne faire qu&#39;une fois. La classe doit se trouver dans votre CLASSPATH (variable d&#39;environnement) javac Stylizer.java # Lancer la commande pour transformer votre XML avec le fichier XSL java Stylizer votrefichier.xsl vtorefichier.xml Parser le vtexport XML VTOM en “pur” Java (un peu long) package vtexport_xml_to_csv; import java.io.File; import java.io.FileWriter ; import java.io.IOException; import java.util.Date; import javax.xml.parsers.DocumentBuilder; import javax.xml.parsers.DocumentBuilderFactory; import javax.xml.parsers.ParserConfigurationException; import javax.xml.xpath.XPath; import javax.xml.xpath.XPathFactory; import javax.xml.xpath.XPathConstants ; import javax.xml.xpath.XPathExpressionException; import org.w3c.dom.Document; import org.w3c.dom.NodeList; import org.w3c.dom.Node; import org.xml.sax.SAXException; public class VtexportXML { private static String xmlPath ; private static Document document; private static final String separateurCSV = &quot;£&quot; ; private static final String separateurEscape = &quot;§&quot; ; private static String domainName; public static void main(String[] args) throws ParserConfigurationException, SAXException, IOException, XPathExpressionException { if (args.length == 1) { setXmlPath(args[0]); }else{ System.err.println(&quot;Usage : 1 paramètre nécessaire&quot;); System.err.println(&quot;1 : chemin complet du fichier xml&quot;); System.exit(1); } final DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance(); final DocumentBuilder builder = factory.newDocumentBuilder(); setDocument( builder.parse( new File( getXmlPath() ) ) ); listAllJobs(); } public static String getXmlPath() { return xmlPath; } public static void setXmlPath(String xmlPath) { VtexportXML.xmlPath = xmlPath; } public static Document getDocument() { return document; } public static void setDocument(Document document) { VtexportXML.document = document; } public static void listAllJobs() throws XPathExpressionException, IOException{ System.out.println(new Date()) ; File file = new File(getXmlPath() + &quot;.txt&quot;); // creates the file file.createNewFile(); // creates a FileWriter Object FileWriter writer = new FileWriter(file); // xPath instance XPath xPath = XPathFactory.newInstance().newXPath(); // set DomainName setDomainName((String) xPath.compile(&quot;/Domain/@name&quot;).evaluate( getDocument() ) ); // get all nodelist job NodeList nodeList = (NodeList) xPath.compile(&quot;/Domain/Environments/Environment/Applications/Application/Jobs/Job&quot;).evaluate(getDocument(),XPathConstants.NODESET); int percentDone = 1 ; System.out.print(&quot;0%.&quot;); // loop over nodelist job for(int i = 0; i &lt; nodeList.getLength() ; i++){ // print evolution running script % if(! ( (i * 100 / nodeList.getLength()) &lt; percentDone ) ){ percentDone++ ; if(percentDone % 10 == 0){ System.out.print(percentDone + &quot;%&quot;); }else{ System.out.print(&quot;.&quot;); } } // job node Node jobNode = (Node) nodeList.item(i) ; // nodelist parameters NodeList parametersNodes = (NodeList) xPath.evaluate(&quot;Parameters/Parameter&quot;,jobNode,XPathConstants.NODESET) ; String[] parameters = new String [ parametersNodes.getLength() ] ; // all parameters as an Array for(int j = 0 ; j &lt; parametersNodes.getLength() ; j++){ parameters[j] = ((Node) parametersNodes.item(j)).getTextContent() ; } writer.write( separateurEscape + xPath.evaluate(&quot;../../../../@name&quot;, jobNode) + separateurEscape + separateurCSV + // envName separateurEscape + xPath.evaluate(&quot;../../@name&quot;, jobNode) + separateurEscape + separateurCSV + // appName separateurEscape + xPath.evaluate(&quot;@name&quot;, jobNode) + separateurEscape + separateurCSV + // jobName separateurEscape + xPath.evaluate(&quot;../../@mode&quot;, jobNode) + separateurEscape + separateurCSV + // AppMode separateurEscape + xPath.evaluate(&quot;@mode&quot;, jobNode) + separateurEscape + separateurCSV + // JobMode separateurEscape + xPath.evaluate(&quot;../../@onDemand&quot;, jobNode) + separateurEscape + separateurCSV + // AppOnDemand separateurEscape + xPath.evaluate(&quot;@onDemand&quot;, jobNode) + separateurEscape + separateurCSV + // JobOnDemand separateurEscape + xPath.evaluate(&quot;Script&quot;,jobNode) + separateurEscape + separateurCSV + // Script separateurEscape + String.join(&quot;|&quot;, parameters) + separateurEscape + separateurCSV + // Parameters separateurEscape + getDomainName() + separateurEscape + separateurCSV // DomainName + &quot;\\n&quot; ); } // Flush the content to the file writer.flush(); writer.close(); // print prompt running script System.out.println(); System.out.println(&quot;Fichier en sortie : &quot; + file.getAbsolutePath()); System.out.println(new Date() + &quot; The end&quot;); } public static String getDomainName() { return domainName; } public static void setDomainName(String domainName) { VtexportXML.domainName = domainName; } } Autre pour moi Reminder pour moi : consolidation des statistiques VTOM (en attendant que tout soit dans la base postgres, je passe par le vthttpd dump) plateforme=up2 vthttpdDat=vthttpd_${plateforme}.dat allJobsSQL=all_jobs.sql allJobs1to1=all_jobsSID_1to1Param_${plateforme}.txt allJobsManyTo1=all_jobsSID_manyTo1Param_${plateforme}.txt outputStats=stats_${plateforme} vtsgbdPort=30509 hostFilter=HOST1 test -f $vthttpdDat &amp;&amp; rm $vthttpdDat vthttpd -dump $vthttpdDat sqlite3 $vthttpdDat &lt; $allJobsSQL | awk &#39;BEGIN{ FS=&quot;|&quot; ; OFS=&quot;|&quot; } { l=length($10) ; if(l == 2) { $10=&quot;0&quot;$10 ;} ; if(l == 1){ $10=&quot;00&quot;$10 } ; print}&#39; | sort -g &gt; $allJobs1to1 ### All jobs manyto1 parameters awk -F &quot;|&quot; &#39;BEGIN{ job_sid=null;} {if($1 == job_sid){ printf &quot;|%s&quot;,$11 }else{ if(job_sid != null){ printf &quot;\\n&quot; } ; printf &quot;%s|%s|%s|%s|%s|%s|%s|%s|%s|%s&quot;,$1,$2,$3,$4,$5,$6,$7,$8,$9,$11 } ; job_sid=$1 ;}&#39; $allJobs1to1 | sort &gt; $allJobsManyTo1 # get stats with filters (modify where clauses) # select vtobjectsid,vtenvname, vtapplname, vtjobname, vtbegin, (vtend::timestamp - vtbegin::timestamp), vtend, vtexpdatevalue, vthostname, vtusername, vtbqueuename, vtdatename,vtstatus, vterrmess ~/sgbd/bin/psql -d vtom -p $vtsgbdPort &lt;&lt; EOF \\pset tuples_only \\pset footer off \\a \\o $outputStats select vtobjectsid,vtbegin,(vtend::timestamp - vtbegin::timestamp),vtend,vtexpdatevalue,vtstatus,vterrmess from vt_stats_job where vthostname = &#39;$hostFilter&#39; and (vtend::timestamp - vtbegin::timestamp) &gt;= &#39;00:10:00&#39; order by (vtend::timestamp - vtbegin::timestamp) ; EOF Très long avec Awk (beaucoup d’itération :x) awk -v fic=$allJobsManyTo1 &#39;BEGIN{ OFS=&quot;|&quot;;FS=&quot;|&quot;; i=0 ; while ((getline line &lt; fic ) &gt; 0){ tAllJobsManyTo1[i]=line ; i++ ; } close (fic) ; }{ if($1 ~ /^APP/){ print $0; next } jobSID=$1 ; lineStats=$0 ; for (i in tAllJobsManyTo1){ split(tAllJobsManyTo1[i],tLine,&quot;|&quot;); if( tLine[1] == jobSID ){ script=tLine[5] ; printf &quot;%s|%s\\n&quot;,lineStats,script ; delete tAllJobsManyTo1[i] ; break; } } }&#39; /var/tmp/stats Beaucoup plus rapide avec Pandas - Python : import pandas my_cols_csv1 = [ &quot;vtobjectsid&quot;,&quot;vtbegin&quot;,&quot;vtduration&quot;,&quot;vtend&quot;,&quot;vtexpdatevalue&quot;,&quot;vtstatus&quot;,&quot;vterrmess&quot; ] csv1 = pandas.read_csv(&#39;stats_up2&#39;,delimiter=r&quot;|&quot;,names=my_cols_csv1) my_cols=[&quot;vtobjectsid&quot;,&quot;env&quot;,&quot;app&quot;,&quot;job&quot;,&quot;script&quot;,&quot;host&quot;,&quot;user&quot;,&quot;queue&quot;,&quot;vtdatename&quot;,&quot;param&quot;] my_cols=my_cols + range(150) csv2 = pandas.read_csv(&#39;all_jobsSID_manyTo1Param_up2.txt&#39;,names=my_cols, sep=&quot;|&quot;) merge = pandas.merge(csv1,csv2, on=&#39;vtobjectsid&#39;) merge.to_csv(&quot;output.csv&quot;) vtobjectsid vtbegin vtduration vtend vtexpdatevalue vtstatus vterrmess env app job script host user queue vtdatename param 0 JOB7ef5b39400006ad956a6113e00014e22 19/03/2016 03:58 00:10:00 19/03/2016 04:08 19/03/2016 3 Termine a 04:08:30 ENV1 poz12daj1 p800ostp1 PATH_DWH_SHELL/OSEF_odi.ksh HOST1 prdwh12 queue_ksh ENV1J_12_rdwh 1 JOB7ef5b39400006ad956a6113e00014e22 03/03/2016 03:29 00:12:24 03/03/2016 03:42 03/03/2016 3 Termine a 03:42:17 ENV1 poz12daj1 p800ostp1 PATH_DWH_SHELL/OSEF_odi.ksh HOST1 prdwh12 queue_ksh ENV1_12_rdwh","headline":"vthttpd -dump et requêtes SQL - tlist ameliore - vtexport.xml to csv","mainEntityOfPage":{"@type":"WebPage","@id":"https://virtual-thom.github.io/archives/vthttpd-dump-requete-sql/"},"url":"https://virtual-thom.github.io/archives/vthttpd-dump-requete-sql/"}</script>
<!-- End Jekyll SEO tag -->

  
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z8Y7902GRV"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Z8Y7902GRV');
</script>


  <body>
    <div class="container">
      <header id="site-header">
  <h1>Blog-notes VTOM, informatique, industrialisation, ordonnancement, DevOps</h1>
  <nav>
    <ul>
      <li>
        <a href="https://virtual-thom.github.io/archives" title="Home">
          <svg class="svg-icon" viewBox="0 0 20 20">
            <path d="M18.121,9.88l-7.832-7.836c-0.155-0.158-0.428-0.155-0.584,0L1.842,9.913c-0.262,0.263-0.073,0.705,0.292,0.705h2.069v7.042c0,0.227,0.187,0.414,0.414,0.414h3.725c0.228,0,0.414-0.188,0.414-0.414v-3.313h2.483v3.313c0,0.227,0.187,0.414,0.413,0.414h3.726c0.229,0,0.414-0.188,0.414-0.414v-7.042h2.068h0.004C18.331,10.617,18.389,10.146,18.121,9.88 M14.963,17.245h-2.896v-3.313c0-0.229-0.186-0.415-0.414-0.415H8.342c-0.228,0-0.414,0.187-0.414,0.415v3.313H5.032v-6.628h9.931V17.245z M3.133,9.79l6.864-6.868l6.867,6.868H3.133z"></path>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://virtual-thom.github.io/archives/vos-commentaires-livre-d-or/" title="Commentaires - livre d'or">
          <svg class="svg-icon" viewBox="0 0 20 20">
            <path d="M17.657,2.982H2.342c-0.234,0-0.425,0.191-0.425,0.426v10.21c0,0.234,0.191,0.426,0.425,0.426h3.404v2.553c0,0.397,0.48,0.547,0.725,0.302l2.889-2.854h8.298c0.234,0,0.426-0.191,0.426-0.426V3.408C18.083,3.174,17.892,2.982,17.657,2.982M17.232,13.192H9.185c-0.113,0-0.219,0.045-0.3,0.124l-2.289,2.262v-1.96c0-0.233-0.191-0.426-0.425-0.426H2.767V3.833h14.465V13.192z M10,7.237c-0.821,0-1.489,0.668-1.489,1.489c0,0.821,0.668,1.489,1.489,1.489c0.821,0,1.488-0.668,1.488-1.489C11.488,7.905,10.821,7.237,10,7.237 M10,9.364c-0.352,0-0.638-0.288-0.638-0.638c0-0.351,0.287-0.638,0.638-0.638c0.351,0,0.638,0.287,0.638,0.638C10.638,9.077,10.351,9.364,10,9.364 M14.254,7.237c-0.821,0-1.489,0.668-1.489,1.489c0,0.821,0.668,1.489,1.489,1.489s1.489-0.668,1.489-1.489C15.743,7.905,15.075,7.237,14.254,7.237 M14.254,9.364c-0.351,0-0.638-0.288-0.638-0.638c0-0.351,0.287-0.638,0.638-0.638c0.352,0,0.639,0.287,0.639,0.638C14.893,9.077,14.605,9.364,14.254,9.364 M5.746,7.237c-0.821,0-1.489,0.668-1.489,1.489c0,0.821,0.668,1.489,1.489,1.489c0.821,0,1.489-0.668,1.489-1.489C7.234,7.905,6.566,7.237,5.746,7.237 M5.746,9.364c-0.351,0-0.638-0.288-0.638-0.638c0-0.351,0.287-0.638,0.638-0.638c0.351,0,0.638,0.287,0.638,0.638C6.384,9.077,6.096,9.364,5.746,9.364"></path>
          </svg>
        </a>
      </li>
      
      <li>
        <a href="https://virtual-thom.github.io/about" title="Curriculum Vitae Thom">
          <svg class="svg-icon" viewBox="0 0 20 20">
            <path d="M12.075,10.812c1.358-0.853,2.242-2.507,2.242-4.037c0-2.181-1.795-4.618-4.198-4.618S5.921,4.594,5.921,6.775c0,1.53,0.884,3.185,2.242,4.037c-3.222,0.865-5.6,3.807-5.6,7.298c0,0.23,0.189,0.42,0.42,0.42h14.273c0.23,0,0.42-0.189,0.42-0.42C17.676,14.619,15.297,11.677,12.075,10.812 M6.761,6.775c0-2.162,1.773-3.778,3.358-3.778s3.359,1.616,3.359,3.778c0,2.162-1.774,3.778-3.359,3.778S6.761,8.937,6.761,6.775 M3.415,17.69c0.218-3.51,3.142-6.297,6.704-6.297c3.562,0,6.486,2.787,6.705,6.297H3.415z"></path>
          </svg>
        </a>
      </li>
    </ul>
  </nav>
</header>

      <div itemscope itemtype ="http://schema.org/Article" class="post">
  
  <header class="post-header">
    <h1 itemprop="name about headline" class="post-title">vthttpd -dump et requêtes SQL - tlist ameliore - vtexport.xml to csv</h1>
    <p class="post-meta">
      <time itemprop="datePublished dateModified" datetime="2016-09-21T22:00:00+00:00">21-09-2016</time></p>
  </header>

  <article class="post-content" itemprop="articleBody">
    <h1 class="hidden">vthttpd -dump et requêtes SQL - tlist ameliore - vtexport.xml to csv</h1>
    <p>&lt;Article mis à jour&gt; J’ai rajouté pas mal de petites astuces sur cet article qui date de l’année dernière (filtre XSL - merci Joey pour l’inspiration !, parsing java, utilisation de Panda Python)</p>

<p>Une autre astuce avec le Webaccess VTOM vthttpd : on peut dump tout le contenu de la base VTOM en un fichier exploitable par SQLITE !</p>

<p>L’utilisation principale est de lister tous les jobs, à la manière d’un <code class="language-plaintext highlighter-rouge">tlist</code>mais avec beaucoup plus d’informations (dont les paramètres et le script)</p>

<p>Voici un petit exemple :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vthttpd -dump /var/tmp/vthttpd.dat
sqlite3 /var/tmp/vthttpd.dat
&gt;
.tables  -- liste toutes les tables
pragma table_info(JOBS) ; -- liste les champs de la table JOBS
.schema JOBS ; -- idem mais avec le type de la colonne (varchar(35) par ex.)
</code></pre></div></div>

<p>On peut exécuter un script .sql :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sqlite3 /var/tmp/vthttpd.dat &lt; /var/tmp/monfichier.sql
</code></pre></div></div>

<p>Et on grep sur ce qu’on souhaite</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">j</span><span class="p">.</span><span class="n">JOB_SID</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">j</span><span class="p">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">j</span><span class="p">.</span><span class="k">COMMENT</span><span class="p">,</span> <span class="n">j</span><span class="p">.</span><span class="n">FAMILY</span><span class="p">,</span> <span class="n">j</span><span class="p">.</span><span class="n">SCRIPT</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">q</span><span class="p">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">d</span><span class="p">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">GROUP_CONCAT</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">VALUE</span><span class="p">,</span><span class="s1">'|'</span><span class="p">)</span>
<span class="k">from</span> <span class="n">jobs</span> <span class="n">j</span>
<span class="k">left</span> <span class="k">join</span> <span class="n">applications</span> <span class="n">a</span> <span class="k">on</span> <span class="n">j</span><span class="p">.</span><span class="n">APP_SID</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">APP_SID</span>
<span class="k">left</span> <span class="k">join</span> <span class="n">environments</span> <span class="n">e</span> <span class="k">on</span> <span class="n">a</span><span class="p">.</span><span class="n">ENV_SID</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">ENV_SID</span>
<span class="k">left</span> <span class="k">join</span> <span class="n">hosts</span> <span class="n">h</span> <span class="k">on</span> <span class="n">j</span><span class="p">.</span><span class="n">HOST_SID</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">HOST_SID</span> <span class="k">or</span> <span class="p">(</span><span class="n">ifnull</span><span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">HOST_SID</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">and</span> <span class="p">(</span> <span class="n">a</span><span class="p">.</span><span class="n">HOST_SID</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">HOST_SID</span> <span class="k">or</span> <span class="p">(</span><span class="n">ifnull</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">HOST_SID</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">and</span> <span class="n">e</span><span class="p">.</span><span class="n">HOST_SID</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">HOST_SID</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
<span class="k">left</span> <span class="k">join</span> <span class="n">users</span> <span class="n">u</span> <span class="k">on</span> <span class="n">j</span><span class="p">.</span><span class="n">USER_SID</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">USER_SID</span> <span class="k">or</span> <span class="p">(</span><span class="n">ifnull</span><span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">USER_SID</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">and</span> <span class="p">(</span> <span class="n">a</span><span class="p">.</span><span class="n">USER_SID</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">USER_SID</span> <span class="k">or</span> <span class="p">(</span><span class="n">ifnull</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">USER_SID</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">and</span> <span class="n">e</span><span class="p">.</span><span class="n">USER_SID</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">USER_SID</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
<span class="k">left</span> <span class="k">join</span> <span class="n">queues</span> <span class="n">q</span> <span class="k">on</span> <span class="n">j</span><span class="p">.</span><span class="n">QUEUE_SID</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">QUEUE_SID</span> <span class="k">or</span> <span class="p">(</span><span class="n">ifnull</span><span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">QUEUE_SID</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">and</span> <span class="p">(</span> <span class="n">a</span><span class="p">.</span><span class="n">QUEUE_SID</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">QUEUE_SID</span> <span class="k">or</span> <span class="p">(</span><span class="n">ifnull</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">QUEUE_SID</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">and</span> <span class="n">e</span><span class="p">.</span><span class="n">QUEUE_SID</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">QUEUE_SID</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
<span class="k">left</span> <span class="k">join</span> <span class="n">dates</span> <span class="n">d</span> <span class="k">on</span> <span class="n">j</span><span class="p">.</span><span class="n">DATE_SID</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="n">DATE_SID</span> <span class="k">or</span> <span class="p">(</span><span class="n">ifnull</span><span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">DATE_SID</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">and</span> <span class="p">(</span> <span class="n">a</span><span class="p">.</span><span class="n">DATE_SID</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="n">DATE_SID</span> <span class="k">or</span> <span class="p">(</span><span class="n">ifnull</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">DATE_SID</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">and</span> <span class="n">e</span><span class="p">.</span><span class="n">DATE_SID</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="n">DATE_SID</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
<span class="k">left</span> <span class="k">join</span> <span class="n">job_parameters</span> <span class="n">p</span> <span class="k">on</span> <span class="n">j</span><span class="p">.</span><span class="n">JOB_SID</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">JOB_SID</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">j</span><span class="p">.</span><span class="n">JOB_SID</span>
<span class="p">;</span>
</code></pre></div></div>

<p>ex.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@acf59c2005cf:/mnt/workspace/temp# sqlite3 vthttpd.dat &lt; all_jobs.sql
JOBac1100030a411a8d570cf93000000004|exploitation|appli_test|job2|||jobok.bat|client_local|vtom|queue_ksh|date_exp|
JOBac1100033f6aedb3570cf93000000002|exploitation|appli_test|job1|||jobok.bat|client_local|vtom|queue_ksh|date_exp|param1|param2|param3
JOBac1100036f024b9d570cf93000000006|exploitation|appli_test|job3|||jobok.bat|client_local|vtom|queue_ksh|date_exp|
</code></pre></div></div>

<p>(exemple en Java, P.I je ne suis pas expert en Java - je suis tombé sur des machines qui n’avaient pas sqlite3 … Ca ne suit surement pas les bonnes pratiques JAva mais ça fonctionne)</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">top100_vthttpd_jobs_to_csv</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.sql.Connection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.DriverManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.ResultSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.Statement</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Top100Main</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Connection</span> <span class="n">c</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="nc">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="nc">String</span> <span class="n">sepCSV</span> <span class="o">=</span> <span class="s">","</span> <span class="o">;</span>
		
		<span class="k">try</span> <span class="o">{</span>
			<span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"org.sqlite.JDBC"</span><span class="o">);</span>
			<span class="n">c</span> <span class="o">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="s">"jdbc:sqlite:D:\\workspace\\java\\top100_vthttpd_jobs_to_csv\\vthttpd.dat"</span><span class="o">);</span>
			<span class="n">c</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
			<span class="n">stmt</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
			
			<span class="nc">String</span> <span class="n">allJobs</span> <span class="o">=</span> <span class="s">"select j.JOB_SID, e.NAME, a.NAME, j.NAME, j.COMMENT, j.FAMILY, j.SCRIPT, h.NAME, u.NAME, q.NAME, d.NAME, GROUP_CONCAT(p.VALUE,'|')"</span>
					<span class="o">+</span> <span class="s">" from jobs j"</span>
					<span class="o">+</span> <span class="s">" left join applications a on j.APP_SID = a.APP_SID"</span>
					<span class="o">+</span> <span class="s">" left join environments e on a.ENV_SID = e.ENV_SID"</span>
					<span class="o">+</span> <span class="s">" left join hosts h on j.HOST_SID = h.HOST_SID or (ifnull(j.HOST_SID,'') = '' and ( a.HOST_SID = h.HOST_SID or (ifnull(a.HOST_SID,'') = '' and e.HOST_SID = h.HOST_SID) ) )"</span>
					<span class="o">+</span> <span class="s">" left join users u on j.USER_SID = u.USER_SID or (ifnull(j.USER_SID,'') = '' and ( a.USER_SID = u.USER_SID or (ifnull(a.USER_SID,'') = '' and e.USER_SID = u.USER_SID) ) )"</span>
					<span class="o">+</span> <span class="s">" left join queues q on j.QUEUE_SID = q.QUEUE_SID or (ifnull(j.QUEUE_SID,'') = '' and ( a.QUEUE_SID = q.QUEUE_SID or (ifnull(a.QUEUE_SID,'') = '' and e.QUEUE_SID = q.QUEUE_SID) ) )"</span>
					<span class="o">+</span> <span class="s">" left join dates d on j.DATE_SID = d.DATE_SID or (ifnull(j.DATE_SID,'') = '' and ( a.DATE_SID = d.DATE_SID or (ifnull(a.DATE_SID,'') = '' and e.DATE_SID = d.DATE_SID) ) )"</span>
					<span class="o">+</span> <span class="s">" left join job_parameters p on j.JOB_SID = p.JOB_SID"</span>
					<span class="o">+</span> <span class="s">" group by j.JOB_SID"</span>
				<span class="c1">//	+ " limit 10"</span>
					<span class="o">+</span> <span class="s">" ;"</span>
			<span class="o">;</span>

			<span class="nc">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span> <span class="n">allJobs</span> <span class="o">);</span>
			
			
			<span class="k">while</span> <span class="o">(</span> <span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">()</span> <span class="o">)</span> <span class="o">{</span>
			   <span class="nc">String</span> <span class="n">jSID</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
			   <span class="nc">String</span> <span class="n">eName</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
			   <span class="nc">String</span> <span class="n">aName</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
			   <span class="nc">String</span> <span class="n">jName</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
			   <span class="nc">String</span> <span class="n">jComment</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
			   <span class="nc">String</span> <span class="n">jFamily</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">6</span><span class="o">);</span>
			   <span class="nc">String</span> <span class="n">jScript</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">7</span><span class="o">);</span>
			   <span class="nc">String</span> <span class="n">hName</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">8</span><span class="o">);</span>
			   <span class="nc">String</span> <span class="n">uName</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">9</span><span class="o">);</span>
			   <span class="nc">String</span> <span class="n">qName</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
			   <span class="nc">String</span> <span class="n">dName</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">11</span><span class="o">);</span>
			   <span class="nc">String</span> <span class="n">pValue</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">12</span><span class="o">);</span>
			   <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span> 
					   <span class="c1">//jSID + sepCSV + </span>
					   <span class="n">eName</span> <span class="o">+</span> <span class="n">sepCSV</span> <span class="o">+</span> <span class="n">aName</span> <span class="o">+</span> <span class="n">sepCSV</span> <span class="o">+</span> <span class="n">jName</span> <span class="o">+</span> <span class="n">sepCSV</span> <span class="o">+</span> <span class="n">jComment</span> <span class="o">+</span> <span class="n">sepCSV</span> <span class="o">+</span>
					   <span class="n">jFamily</span> <span class="o">+</span> <span class="n">sepCSV</span> <span class="o">+</span> <span class="n">jScript</span> <span class="o">+</span> <span class="n">sepCSV</span> <span class="o">+</span><span class="n">hName</span> <span class="o">+</span> <span class="n">sepCSV</span> <span class="o">+</span> <span class="n">uName</span> <span class="o">+</span> <span class="n">sepCSV</span> <span class="o">+</span>
					   <span class="n">qName</span> <span class="o">+</span> <span class="n">sepCSV</span> <span class="o">+</span> <span class="n">dName</span> <span class="o">+</span> <span class="n">sepCSV</span> <span class="o">+</span> <span class="n">pValue</span>
					<span class="o">);</span>
			   <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
			<span class="o">}</span>
		
			<span class="n">rs</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
			<span class="n">stmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
			<span class="n">c</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
			
		<span class="o">}</span><span class="k">catch</span> <span class="o">(</span> <span class="nc">Exception</span> <span class="n">e</span> <span class="o">)</span> <span class="o">{</span>
		  <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">e</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">()</span> <span class="o">);</span>
		  <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
		<span class="o">}</span>

	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="filtrer-directement-un-fichier-xml-avec-un-fichier-xsl-et-sortie-en-texte-pour-du-csv">Filtrer directement un fichier XML avec un fichier XSL et sortie en texte (pour du csv)</h3>

<p>J’avais déjà utilisé ce langage de transformation XSL mais il m’était complétement sorti de la tête. Merci à JOEY de m’avoir inspriré ! :)</p>

<p>Fichier XSL de transformation (à adapter selon vos besoin)</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;xsl:stylesheet</span> <span class="na">version=</span><span class="s">"2.0"</span> <span class="na">xmlns:xsl=</span><span class="s">"http://www.w3.org/1999/XSL/Transform"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;xsl:output</span> <span class="na">method=</span><span class="s">"text"</span> <span class="na">encoding=</span><span class="s">"utf-8"</span> <span class="nt">/&gt;</span>
  
  <span class="c">&lt;!-- j'utilise cette sortie pour constituer mon fichier CSV utilisé en tant que data pour load dans Oracle une table avec SQLLDR et un fichier de controle .ctl --&gt;</span>
  <span class="c">&lt;!--
  sqlldr do not set OPTIONALLY ENCLOSED BY '"' because this char appears in comments and params 

        LOAD DATA APPEND
        INTO TABLE nom_dela_table_oracle
        FIELDS TERMINATED BY "£"
        
        (
          "VTENVNAME"                     CHAR,
          "VTAPPLNAME"                    CHAR,
          "VTJOBNAME"                     CHAR,
          "APPMODE"                     CHAR,
          "JOBMODE"                     CHAR, 
          etc...
        )
  --&gt;</span>
  
  <span class="nt">&lt;xsl:param</span> <span class="na">name=</span><span class="s">"delimCSV"</span> <span class="na">select=</span><span class="s">"'£'"</span> <span class="nt">/&gt;</span><span class="c">&lt;!-- j'utilise ce char car il n'est pas utilisé dans mon référentiel VTOM --&gt;</span>
  <span class="nt">&lt;xsl:param</span> <span class="na">name=</span><span class="s">"delimParam"</span> <span class="na">select=</span><span class="s">"'§'"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;xsl:param</span> <span class="na">name=</span><span class="s">"break"</span> <span class="na">select=</span><span class="s">"'&amp;#xA;'"</span> <span class="nt">/&gt;</span>
  <span class="c">&lt;!--
  &lt;xsl:value-of select="$delimCSV" /&gt;
   --&gt;</span>

  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">"/"</span><span class="nt">&gt;</span>
	  <span class="nt">&lt;xsl:apply-templates</span> <span class="na">select=</span><span class="s">"Domain/Environments/Environment/Applications/Application/Jobs/Job"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/xsl:template&gt;</span>

  <span class="c">&lt;!-- All Job node for root node --&gt;</span>
  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">"Domain/Environments/Environment/Applications/Application/Jobs/Job"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"../../../../@name"</span> <span class="nt">/&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$delimCSV"</span> <span class="nt">/&gt;</span>              <span class="c">&lt;!-- EnvironmentName --&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"../../@name"</span> <span class="nt">/&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$delimCSV"</span> <span class="nt">/&gt;</span>                    <span class="c">&lt;!-- ApplicationName --&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"@name"</span> <span class="nt">/&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$delimCSV"</span> <span class="nt">/&gt;</span>                          <span class="c">&lt;!-- JobName --&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"../../@mode"</span> <span class="nt">/&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$delimCSV"</span> <span class="nt">/&gt;</span>                    <span class="c">&lt;!-- ApplicationMode --&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"@mode"</span> <span class="nt">/&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$delimCSV"</span> <span class="nt">/&gt;</span>                          <span class="c">&lt;!-- JobMode --&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"../../@onDemand"</span> <span class="nt">/&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$delimCSV"</span> <span class="nt">/&gt;</span>                <span class="c">&lt;!-- ApplicationOnDemand --&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"@onDemand"</span> <span class="nt">/&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$delimCSV"</span> <span class="nt">/&gt;</span>                      <span class="c">&lt;!-- JobOnDemand --&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"Script/text()"</span> <span class="nt">/&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$delimCSV"</span> <span class="nt">/&gt;</span>                  <span class="c">&lt;!-- Script --&gt;</span>
    <span class="nt">&lt;xsl:apply-templates</span> <span class="na">select=</span><span class="s">"Parameters/Parameter"</span> <span class="nt">/&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$delimCSV"</span> <span class="nt">/&gt;</span>    <span class="c">&lt;!-- Parameters --&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"../../../../../../@name"</span> <span class="nt">/&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$delimCSV"</span> <span class="nt">/&gt;</span>        <span class="c">&lt;!-- DomainName --&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$break"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/xsl:template&gt;</span>

  <span class="c">&lt;!-- All Parameter node for Job node --&gt;</span>
  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">"Parameters/Parameter"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"text()"</span> <span class="nt">/&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"$delimParam"</span> <span class="nt">/&gt;</span>                       <span class="c">&lt;!-- Parameter --&gt;</span>
  <span class="nt">&lt;/xsl:template&gt;</span>  

<span class="nt">&lt;/xsl:stylesheet&gt;</span>
</code></pre></div></div>

<p>Pour appliquer le fichier XSL au fichier XML vtexport VTOM, on peut faire ça assez simplement avec une class Java (Stylizer) fournie par Oracle.</p>

<p>Si vous voulez plus d’information sur la classe et la télécharger, voici le lien Oracle <a href="https://docs.oracle.com/javase/tutorial/jaxp/xslt/transformingXML.html">Transforming XML Data with XSLT</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Compiler le code source java pour créer votre class Stylizer.class, A ne faire qu'une fois. La classe doit se trouver dans votre CLASSPATH (variable d'environnement)</span>
javac Stylizer.java

<span class="c"># Lancer la commande pour transformer votre XML avec le fichier XSL</span>
java Stylizer votrefichier.xsl vtorefichier.xml
</code></pre></div></div>

<h3 id="parser-le-vtexport-xml-vtom-en-pur-java-un-peu-long">Parser le vtexport XML VTOM en “pur” Java (un peu long)</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">vtexport_xml_to_csv</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileWriter</span> <span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.xml.parsers.DocumentBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.parsers.DocumentBuilderFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.parsers.ParserConfigurationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.xpath.XPath</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.xpath.XPathFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.xpath.XPathConstants</span> <span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.xpath.XPathExpressionException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.w3c.dom.Document</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.w3c.dom.NodeList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.w3c.dom.Node</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xml.sax.SAXException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">VtexportXML</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="nc">String</span> <span class="n">xmlPath</span> <span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="nc">Document</span> <span class="n">document</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">separateurCSV</span> <span class="o">=</span> <span class="s">"£"</span> <span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">separateurEscape</span> <span class="o">=</span> <span class="s">"§"</span> <span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="nc">String</span> <span class="n">domainName</span><span class="o">;</span>
	
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ParserConfigurationException</span><span class="o">,</span> <span class="nc">SAXException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">XPathExpressionException</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">setXmlPath</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
		<span class="o">}</span><span class="k">else</span><span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Usage : 1 paramètre nécessaire"</span><span class="o">);</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"1 : chemin complet du fichier xml"</span><span class="o">);</span>
	        <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
		<span class="o">}</span>

        <span class="kd">final</span> <span class="nc">DocumentBuilderFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="nc">DocumentBuilderFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>    	
        <span class="kd">final</span> <span class="nc">DocumentBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">newDocumentBuilder</span><span class="o">();</span>
	    <span class="n">setDocument</span><span class="o">(</span> <span class="n">builder</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span> <span class="n">getXmlPath</span><span class="o">()</span> <span class="o">)</span> <span class="o">)</span> <span class="o">);</span>
    	<span class="n">listAllJobs</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">getXmlPath</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">xmlPath</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setXmlPath</span><span class="o">(</span><span class="nc">String</span> <span class="n">xmlPath</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">VtexportXML</span><span class="o">.</span><span class="na">xmlPath</span> <span class="o">=</span> <span class="n">xmlPath</span><span class="o">;</span>
	<span class="o">}</span>
	
	<span class="kd">public</span> <span class="kd">static</span> <span class="nc">Document</span> <span class="nf">getDocument</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">document</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setDocument</span><span class="o">(</span><span class="nc">Document</span> <span class="n">document</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">VtexportXML</span><span class="o">.</span><span class="na">document</span> <span class="o">=</span> <span class="n">document</span><span class="o">;</span>
	<span class="o">}</span>
	
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">listAllJobs</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">XPathExpressionException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">{</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">())</span> <span class="o">;</span>
		
		<span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">getXmlPath</span><span class="o">()</span> <span class="o">+</span> <span class="s">".txt"</span><span class="o">);</span>
		<span class="c1">// creates the file</span>
		<span class="n">file</span><span class="o">.</span><span class="na">createNewFile</span><span class="o">();</span>
		<span class="c1">// creates a FileWriter Object</span>
		<span class="nc">FileWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileWriter</span><span class="o">(</span><span class="n">file</span><span class="o">);</span> 
		
		<span class="c1">// xPath instance</span>
		<span class="nc">XPath</span> <span class="n">xPath</span> <span class="o">=</span>  <span class="nc">XPathFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">().</span><span class="na">newXPath</span><span class="o">();</span>
		<span class="c1">// set DomainName </span>
		<span class="n">setDomainName</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">xPath</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">"/Domain/@name"</span><span class="o">).</span><span class="na">evaluate</span><span class="o">(</span> <span class="n">getDocument</span><span class="o">()</span> <span class="o">)</span> <span class="o">);</span>
		
		<span class="c1">// get all nodelist job</span>
		<span class="nc">NodeList</span> <span class="n">nodeList</span> <span class="o">=</span> <span class="o">(</span><span class="nc">NodeList</span><span class="o">)</span> <span class="n">xPath</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">"/Domain/Environments/Environment/Applications/Application/Jobs/Job"</span><span class="o">).</span><span class="na">evaluate</span><span class="o">(</span><span class="n">getDocument</span><span class="o">(),</span><span class="nc">XPathConstants</span><span class="o">.</span><span class="na">NODESET</span><span class="o">);</span>	
		
		<span class="kt">int</span> <span class="n">percentDone</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">;</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"0%."</span><span class="o">);</span>
		
		<span class="c1">// loop over nodelist job</span>
		<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nodeList</span><span class="o">.</span><span class="na">getLength</span><span class="o">()</span> <span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
			
			<span class="c1">// print evolution running script %</span>
			<span class="k">if</span><span class="o">(!</span> <span class="o">(</span> <span class="o">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">nodeList</span><span class="o">.</span><span class="na">getLength</span><span class="o">())</span> <span class="o">&lt;</span> <span class="n">percentDone</span> <span class="o">)</span> <span class="o">){</span>
				<span class="n">percentDone</span><span class="o">++</span> <span class="o">;</span>
				<span class="k">if</span><span class="o">(</span><span class="n">percentDone</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
					<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">percentDone</span> <span class="o">+</span> <span class="s">"%"</span><span class="o">);</span>
				<span class="o">}</span><span class="k">else</span><span class="o">{</span>
					<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"."</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			
			<span class="c1">// job node</span>
			<span class="nc">Node</span> <span class="n">jobNode</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Node</span><span class="o">)</span> <span class="n">nodeList</span><span class="o">.</span><span class="na">item</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">;</span>
			
			<span class="c1">// nodelist parameters</span>
			<span class="nc">NodeList</span> <span class="n">parametersNodes</span> <span class="o">=</span> <span class="o">(</span><span class="nc">NodeList</span><span class="o">)</span> <span class="n">xPath</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="s">"Parameters/Parameter"</span><span class="o">,</span><span class="n">jobNode</span><span class="o">,</span><span class="nc">XPathConstants</span><span class="o">.</span><span class="na">NODESET</span><span class="o">)</span> <span class="o">;</span>
			<span class="nc">String</span><span class="o">[]</span> <span class="n">parameters</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span> <span class="o">[</span> <span class="n">parametersNodes</span><span class="o">.</span><span class="na">getLength</span><span class="o">()</span> <span class="o">]</span> <span class="o">;</span>
			
			<span class="c1">// all parameters as an Array</span>
			<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">parametersNodes</span><span class="o">.</span><span class="na">getLength</span><span class="o">()</span> <span class="o">;</span> <span class="n">j</span><span class="o">++){</span>
				<span class="n">parameters</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="o">((</span><span class="nc">Node</span><span class="o">)</span> <span class="n">parametersNodes</span><span class="o">.</span><span class="na">item</span><span class="o">(</span><span class="n">j</span><span class="o">)).</span><span class="na">getTextContent</span><span class="o">()</span> <span class="o">;</span>
			<span class="o">}</span>
			
			<span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span>
				
				<span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">xPath</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="s">"../../../../@name"</span><span class="o">,</span> <span class="n">jobNode</span><span class="o">)</span> <span class="o">+</span> <span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">separateurCSV</span> <span class="o">+</span>	<span class="c1">// envName</span>
				<span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">xPath</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="s">"../../@name"</span><span class="o">,</span> <span class="n">jobNode</span><span class="o">)</span> <span class="o">+</span> <span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">separateurCSV</span> <span class="o">+</span>			<span class="c1">// appName</span>
				<span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">xPath</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="s">"@name"</span><span class="o">,</span> <span class="n">jobNode</span><span class="o">)</span> <span class="o">+</span> <span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">separateurCSV</span> <span class="o">+</span>				<span class="c1">// jobName</span>
				<span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">xPath</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="s">"../../@mode"</span><span class="o">,</span> <span class="n">jobNode</span><span class="o">)</span> <span class="o">+</span> <span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">separateurCSV</span> <span class="o">+</span>			<span class="c1">// AppMode</span>
				<span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">xPath</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="s">"@mode"</span><span class="o">,</span> <span class="n">jobNode</span><span class="o">)</span> <span class="o">+</span> <span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">separateurCSV</span> <span class="o">+</span>				<span class="c1">// JobMode</span>
				<span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">xPath</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="s">"../../@onDemand"</span><span class="o">,</span> <span class="n">jobNode</span><span class="o">)</span> <span class="o">+</span> <span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">separateurCSV</span> <span class="o">+</span>		<span class="c1">// AppOnDemand</span>
				<span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">xPath</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="s">"@onDemand"</span><span class="o">,</span> <span class="n">jobNode</span><span class="o">)</span> <span class="o">+</span> <span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">separateurCSV</span> <span class="o">+</span>			<span class="c1">// JobOnDemand</span>
				<span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">xPath</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="s">"Script"</span><span class="o">,</span><span class="n">jobNode</span><span class="o">)</span> <span class="o">+</span> <span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">separateurCSV</span> <span class="o">+</span>				<span class="c1">// Script</span>
				<span class="n">separateurEscape</span> <span class="o">+</span> <span class="nc">String</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"|"</span><span class="o">,</span> <span class="n">parameters</span><span class="o">)</span> <span class="o">+</span> <span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">separateurCSV</span> <span class="o">+</span> 					<span class="c1">// Parameters</span>
				<span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">getDomainName</span><span class="o">()</span> <span class="o">+</span> <span class="n">separateurEscape</span> <span class="o">+</span> <span class="n">separateurCSV</span>									<span class="c1">// DomainName</span>
				<span class="o">+</span> <span class="s">"\n"</span>
			<span class="o">);</span>
			
		<span class="o">}</span>

		<span class="c1">// Flush the content to the file</span>
		<span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
		<span class="n">writer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		
		<span class="c1">// print prompt running script</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Fichier en sortie : "</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">());</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">()</span> <span class="o">+</span> <span class="s">" The end"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">getDomainName</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">domainName</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setDomainName</span><span class="o">(</span><span class="nc">String</span> <span class="n">domainName</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">VtexportXML</span><span class="o">.</span><span class="na">domainName</span> <span class="o">=</span> <span class="n">domainName</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h3 id="autre-pour-moi">Autre pour moi</h3>

<p>Reminder pour moi : consolidation des statistiques VTOM (en attendant que tout soit dans la base postgres, je passe par le vthttpd dump)</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">plateforme</span><span class="o">=</span>up2
<span class="nv">vthttpdDat</span><span class="o">=</span>vthttpd_<span class="k">${</span><span class="nv">plateforme</span><span class="k">}</span>.dat
<span class="nv">allJobsSQL</span><span class="o">=</span>all_jobs.sql
<span class="nv">allJobs1to1</span><span class="o">=</span>all_jobsSID_1to1Param_<span class="k">${</span><span class="nv">plateforme</span><span class="k">}</span>.txt
<span class="nv">allJobsManyTo1</span><span class="o">=</span>all_jobsSID_manyTo1Param_<span class="k">${</span><span class="nv">plateforme</span><span class="k">}</span>.txt
<span class="nv">outputStats</span><span class="o">=</span>stats_<span class="k">${</span><span class="nv">plateforme</span><span class="k">}</span>
<span class="nv">vtsgbdPort</span><span class="o">=</span>30509
<span class="nv">hostFilter</span><span class="o">=</span>HOST1

<span class="nb">test</span> <span class="nt">-f</span> <span class="nv">$vthttpdDat</span> <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nv">$vthttpdDat</span>
vthttpd <span class="nt">-dump</span> <span class="nv">$vthttpdDat</span>
sqlite3 <span class="nv">$vthttpdDat</span> &lt; <span class="nv">$allJobsSQL</span> |  <span class="nb">awk</span> <span class="s1">'BEGIN{ FS="|" ; OFS="|" } { l=length($10) ; if(l == 2) { $10="0"$10 ;} ;  if(l == 1){ $10="00"$10 }  ; print}'</span> | <span class="nb">sort</span> <span class="nt">-g</span>  <span class="o">&gt;</span>  <span class="nv">$allJobs1to1</span>

<span class="c">### All jobs manyto1 parameters</span>
<span class="nb">awk</span> <span class="nt">-F</span> <span class="s2">"|"</span> <span class="s1">'BEGIN{ job_sid=null;} {if($1 == job_sid){ printf "|%s",$11 }else{ if(job_sid != null){ printf "\n" } ; printf "%s|%s|%s|%s|%s|%s|%s|%s|%s|%s",$1,$2,$3,$4,$5,$6,$7,$8,$9,$11 } ; job_sid=$1 ;}'</span> <span class="nv">$allJobs1to1</span> | <span class="nb">sort</span> <span class="o">&gt;</span> <span class="nv">$allJobsManyTo1</span>

<span class="c"># get stats with filters (modify where clauses)   </span>
<span class="c"># select vtobjectsid,vtenvname, vtapplname, vtjobname, vtbegin, (vtend::timestamp - vtbegin::timestamp), vtend, vtexpdatevalue, vthostname, vtusername, vtbqueuename, vtdatename,vtstatus, vterrmess  </span>
~/sgbd/bin/psql <span class="nt">-d</span> vtom <span class="nt">-p</span> <span class="nv">$vtsgbdPort</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
</span><span class="se">\p</span><span class="sh">set tuples_only
</span><span class="se">\p</span><span class="sh">set footer off
</span><span class="se">\a</span><span class="sh">
</span><span class="se">\o</span><span class="sh"> </span><span class="nv">$outputStats</span><span class="sh">
select vtobjectsid,vtbegin,(vtend::timestamp - vtbegin::timestamp),vtend,vtexpdatevalue,vtstatus,vterrmess
from vt_stats_job 
where vthostname = '</span><span class="nv">$hostFilter</span><span class="sh">' 
and (vtend::timestamp - vtbegin::timestamp) &gt;= '00:10:00'
order by (vtend::timestamp - vtbegin::timestamp) 
;
</span><span class="no">EOF
</span></code></pre></div></div>

<p>Très long avec Awk (beaucoup d’itération :x)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk -v fic=$allJobsManyTo1 'BEGIN{
    OFS="|";FS="|";
    i=0 ;
    while ((getline line &lt; fic ) &gt; 0){
        tAllJobsManyTo1[i]=line ;
        i++ ;
    }
    close (fic) ;
    
}{
    if($1 ~ /^APP/){
      print $0;
      next
    }
    jobSID=$1 ;
    lineStats=$0 ;
    
    for (i in tAllJobsManyTo1){
        split(tAllJobsManyTo1[i],tLine,"|");
   
        if( tLine[1] == jobSID ){
          script=tLine[5] ;
          printf "%s|%s\n",lineStats,script ;
          delete  tAllJobsManyTo1[i] ;
          break; 
        }
    }
    
}' /var/tmp/stats
</code></pre></div></div>

<p>Beaucoup plus rapide avec Pandas - Python :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pandas</span>

<span class="n">my_cols_csv1</span> <span class="o">=</span> <span class="p">[</span> <span class="sh">"</span><span class="s">vtobjectsid</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">vtbegin</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">vtduration</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">vtend</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">vtexpdatevalue</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">vtstatus</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">vterrmess</span><span class="sh">"</span> <span class="p">]</span>
<span class="n">csv1</span> <span class="o">=</span> <span class="n">pandas</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">stats_up2</span><span class="sh">'</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="sa">r</span><span class="sh">"</span><span class="s">|</span><span class="sh">"</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">my_cols_csv1</span><span class="p">)</span>
<span class="n">my_cols</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">vtobjectsid</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">env</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">app</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">job</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">script</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">host</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">vtdatename</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">param</span><span class="sh">"</span><span class="p">]</span>
<span class="n">my_cols</span><span class="o">=</span><span class="n">my_cols</span> <span class="o">+</span> <span class="nf">range</span><span class="p">(</span><span class="mi">150</span><span class="p">)</span>
<span class="n">csv2</span> <span class="o">=</span> <span class="n">pandas</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">all_jobsSID_manyTo1Param_up2.txt</span><span class="sh">'</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">my_cols</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sh">"</span><span class="s">|</span><span class="sh">"</span><span class="p">)</span>
<span class="n">merge</span> <span class="o">=</span> <span class="n">pandas</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">csv1</span><span class="p">,</span><span class="n">csv2</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="sh">'</span><span class="s">vtobjectsid</span><span class="sh">'</span><span class="p">)</span>
<span class="n">merge</span><span class="p">.</span><span class="nf">to_csv</span><span class="p">(</span><span class="sh">"</span><span class="s">output.csv</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	vtobjectsid	vtbegin	vtduration	vtend	vtexpdatevalue	vtstatus	vterrmess	env	app	job	script	host	user	queue	vtdatename	param
0	JOB7ef5b39400006ad956a6113e00014e22	19/03/2016 03:58	00:10:00	19/03/2016 04:08	19/03/2016	3	Termine a 04:08:30	ENV1	poz12daj1	p800ostp1	PATH_DWH_SHELL/OSEF_odi.ksh	HOST1	prdwh12	queue_ksh	ENV1J_12_rdwh	
1	JOB7ef5b39400006ad956a6113e00014e22	03/03/2016 03:29	00:12:24	03/03/2016 03:42	03/03/2016	3	Termine a 03:42:17	ENV1	poz12daj1	p800ostp1	PATH_DWH_SHELL/OSEF_odi.ksh	HOST1	prdwh12	queue_ksh	ENV1_12_rdwh	
</code></pre></div></div>

  </article>
  
<nav>
  <ul class="pager">
    
     
    <li class="previous">
      <a href="https://virtual-thom.github.io/archives/ressource-pile/"><span aria-hidden="true">&larr;</span> Ressource pile</a> 
    </li>
    
     
     <li class="next">
      <a class="next" href="https://virtual-thom.github.io/archives/javascript-fonction-unique-distinct/">Javascript fonction unique (distinct) sur un tableau d'objet <span aria-hidden="true">&rarr;</span></a> 
    </li>
     
    
  </ul>
</nav>


  <footer class="post-footer">
    
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>vthttpd</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>dump</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>SQL</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>Visual TOM</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>VTOM</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>tlist</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>java</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>XSL</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>XML</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>vtexport</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>vtexport.xml</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>csv</a>
      
    
    <span  itemprop="author publisher" class="hidden">Virtual Thom</span>
  </footer>
  
  <div id="disqus_thread" ></div>
  <script>
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'thomas-asnar'; // required: replace example with your forum shortname
  
      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
</div>

      <footer id="site-footer">
    <div>&copy;<a href="https://github.com/virtual-thom/" title="Github Virtual-Thom">Virtual-Thom</a></div>
    <div>
            <a href="https://virtual-thom.github.io/archives/plan" title="Plan du site">sitemap</a> | <a href="https://virtual-thom.github.io/about" rel="publisher author" title="Curriculum vitae Thom">A propos</a>
    </div>
    <div>
        <a id="goto-site-header" href="#site-header" title="Retourner au début">&uArr; Top</a>
    </div>
    <div id="footer-disclaimer">
        <p>Avertissement : vous ne devez pas prendre pour argent comptant le contenu de ce site. Testez toujours la solution en environnement de test.</p>
        <p>Malgré le sérieux que je m'efforce de mettre dans le contenu de ces billets, je ne pourrai être tenu responsable d'éventuelles erreurs que cela pourrait engendrer.</p>
    </div>
    <div>
        <a class="hidden" href="https://virtual-thom.github.io/archives/sitemap.xml" title="SiteMap">sitemap</a>
    </div>
</footer>

    </div>
  </body>

</html>