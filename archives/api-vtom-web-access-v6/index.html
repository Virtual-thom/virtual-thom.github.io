<!DOCTYPE html>
<html lang="fr">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="apple-touch-icon" href="https://virtual-thom.github.io/archives/apple-touch-icon.png">
  <link rel="icon" href="https://virtual-thom.github.io/archives/favicon.ico" />
  <!-- Remplacé par Jekyll SEO (sinon apparait en double)
  <title>API VTOM webaccess (update)</title>
  <meta name="description" content="Avertissement  Les APIs ne sont pas soutenues pas Absyss pour le moment (ni documentées). Vous pouvez les utiliser mais on ne vous fournira aucune aide, assi...">
  --> 
  
  <link rel="canonical" href="https://virtual-thom.github.io/archives/api-vtom-web-access-v6/">
  
  <link rel="stylesheet" media="screen" href="https://virtual-thom.github.io/archives/assets/main.css">
  
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>API VTOM webaccess (update) | Virtual-Thom Blog-notes VTOM et informatique</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="API VTOM webaccess (update)" />
<meta name="author" content="Virtual Thom" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Avertissement Les APIs ne sont pas soutenues pas Absyss pour le moment (ni documentées). Vous pouvez les utiliser mais on ne vous fournira aucune aide, assistance, ou débuggage d’après moi. (maj 11/05/20 à priori, les API seront supportées dès la v6.4.5) Il n’y a aucune garantie que ce qui fonctionne aujourd’hui fonctionnera de la même manière avec la prochaine version. Il est donc actuellement déconseillé de les exploiter en environnement productif. Petite update du 1 er post API VTOM via le WebAccess ici. Rappels importants sur le portail web et les API Côté serveur : Démarrez le service vthttpd et tapez vtping pour voir son état et son port. (le port est défini dans /etc/services). Le démarrage automatique peut être décommenté du script $TOM_ADMIN/start_servers Côté client : Interface web type client léger afin d’explorer, piloter, et suivre l’exploitation d’un serveur VTOM. Rendez-vous sur l’url http://&lt;nomdevotreserveur ou sonIP&gt;:&lt;port&gt; et authentifiez-vous. Ouvrez votre navigateur Chrome F12 et allez dans l’onglet Network pour voir les appels aux API. Baladez dans les menus du portail web et glannez les différentes adresses et requêtes XHR. Requêter : Rajouter dans le header des requêtes le user:mdp en base64 (voir mon premier post pour les détails) : ex. pour une XMLHttpRequest xhr.setRequestHeader(&#39;Authorization&#39;, &#39;Basic VE9NOlRPTQ==&#39;) En local depuis le même serveur VTOM, les appels directs XMLHttpRequest Chrome passent sans soucis. En revanche, je n’ai pas réussi à faire fonctionner depuis un autre domaine (à cause du Cross-origin resource sharing - CORS) sinon les appels en back-end fonctionnent très bien de n’importe où : curl, node js, php etc." />
<meta property="og:description" content="Avertissement Les APIs ne sont pas soutenues pas Absyss pour le moment (ni documentées). Vous pouvez les utiliser mais on ne vous fournira aucune aide, assistance, ou débuggage d’après moi. (maj 11/05/20 à priori, les API seront supportées dès la v6.4.5) Il n’y a aucune garantie que ce qui fonctionne aujourd’hui fonctionnera de la même manière avec la prochaine version. Il est donc actuellement déconseillé de les exploiter en environnement productif. Petite update du 1 er post API VTOM via le WebAccess ici. Rappels importants sur le portail web et les API Côté serveur : Démarrez le service vthttpd et tapez vtping pour voir son état et son port. (le port est défini dans /etc/services). Le démarrage automatique peut être décommenté du script $TOM_ADMIN/start_servers Côté client : Interface web type client léger afin d’explorer, piloter, et suivre l’exploitation d’un serveur VTOM. Rendez-vous sur l’url http://&lt;nomdevotreserveur ou sonIP&gt;:&lt;port&gt; et authentifiez-vous. Ouvrez votre navigateur Chrome F12 et allez dans l’onglet Network pour voir les appels aux API. Baladez dans les menus du portail web et glannez les différentes adresses et requêtes XHR. Requêter : Rajouter dans le header des requêtes le user:mdp en base64 (voir mon premier post pour les détails) : ex. pour une XMLHttpRequest xhr.setRequestHeader(&#39;Authorization&#39;, &#39;Basic VE9NOlRPTQ==&#39;) En local depuis le même serveur VTOM, les appels directs XMLHttpRequest Chrome passent sans soucis. En revanche, je n’ai pas réussi à faire fonctionner depuis un autre domaine (à cause du Cross-origin resource sharing - CORS) sinon les appels en back-end fonctionnent très bien de n’importe où : curl, node js, php etc." />
<link rel="canonical" href="https://virtual-thom.github.io/archives/api-vtom-web-access-v6/" />
<meta property="og:url" content="https://virtual-thom.github.io/archives/api-vtom-web-access-v6/" />
<meta property="og:site_name" content="Virtual-Thom Blog-notes VTOM et informatique" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-05-01T20:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="API VTOM webaccess (update)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Virtual Thom"},"dateModified":"2018-05-01T20:00:00+00:00","datePublished":"2018-05-01T20:00:00+00:00","description":"Avertissement Les APIs ne sont pas soutenues pas Absyss pour le moment (ni documentées). Vous pouvez les utiliser mais on ne vous fournira aucune aide, assistance, ou débuggage d’après moi. (maj 11/05/20 à priori, les API seront supportées dès la v6.4.5) Il n’y a aucune garantie que ce qui fonctionne aujourd’hui fonctionnera de la même manière avec la prochaine version. Il est donc actuellement déconseillé de les exploiter en environnement productif. Petite update du 1 er post API VTOM via le WebAccess ici. Rappels importants sur le portail web et les API Côté serveur : Démarrez le service vthttpd et tapez vtping pour voir son état et son port. (le port est défini dans /etc/services). Le démarrage automatique peut être décommenté du script $TOM_ADMIN/start_servers Côté client : Interface web type client léger afin d’explorer, piloter, et suivre l’exploitation d’un serveur VTOM. Rendez-vous sur l’url http://&lt;nomdevotreserveur ou sonIP&gt;:&lt;port&gt; et authentifiez-vous. Ouvrez votre navigateur Chrome F12 et allez dans l’onglet Network pour voir les appels aux API. Baladez dans les menus du portail web et glannez les différentes adresses et requêtes XHR. Requêter : Rajouter dans le header des requêtes le user:mdp en base64 (voir mon premier post pour les détails) : ex. pour une XMLHttpRequest xhr.setRequestHeader(&#39;Authorization&#39;, &#39;Basic VE9NOlRPTQ==&#39;) En local depuis le même serveur VTOM, les appels directs XMLHttpRequest Chrome passent sans soucis. En revanche, je n’ai pas réussi à faire fonctionner depuis un autre domaine (à cause du Cross-origin resource sharing - CORS) sinon les appels en back-end fonctionnent très bien de n’importe où : curl, node js, php etc.","headline":"API VTOM webaccess (update)","mainEntityOfPage":{"@type":"WebPage","@id":"https://virtual-thom.github.io/archives/api-vtom-web-access-v6/"},"url":"https://virtual-thom.github.io/archives/api-vtom-web-access-v6/"}</script>
<!-- End Jekyll SEO tag -->

  
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z8Y7902GRV"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Z8Y7902GRV');
</script>


  <body>
    <div class="container">
      <header id="site-header">
  <h1>Blog-notes VTOM, informatique, industrialisation, ordonnancement, DevOps</h1>
  <nav>
    <ul>
      <li>
        <a href="https://virtual-thom.github.io/archives" title="Home">
          <svg class="svg-icon" viewBox="0 0 20 20">
            <path d="M18.121,9.88l-7.832-7.836c-0.155-0.158-0.428-0.155-0.584,0L1.842,9.913c-0.262,0.263-0.073,0.705,0.292,0.705h2.069v7.042c0,0.227,0.187,0.414,0.414,0.414h3.725c0.228,0,0.414-0.188,0.414-0.414v-3.313h2.483v3.313c0,0.227,0.187,0.414,0.413,0.414h3.726c0.229,0,0.414-0.188,0.414-0.414v-7.042h2.068h0.004C18.331,10.617,18.389,10.146,18.121,9.88 M14.963,17.245h-2.896v-3.313c0-0.229-0.186-0.415-0.414-0.415H8.342c-0.228,0-0.414,0.187-0.414,0.415v3.313H5.032v-6.628h9.931V17.245z M3.133,9.79l6.864-6.868l6.867,6.868H3.133z"></path>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://virtual-thom.github.io/archives/vos-commentaires-livre-d-or/" title="Commentaires - livre d'or">
          <svg class="svg-icon" viewBox="0 0 20 20">
            <path d="M17.657,2.982H2.342c-0.234,0-0.425,0.191-0.425,0.426v10.21c0,0.234,0.191,0.426,0.425,0.426h3.404v2.553c0,0.397,0.48,0.547,0.725,0.302l2.889-2.854h8.298c0.234,0,0.426-0.191,0.426-0.426V3.408C18.083,3.174,17.892,2.982,17.657,2.982M17.232,13.192H9.185c-0.113,0-0.219,0.045-0.3,0.124l-2.289,2.262v-1.96c0-0.233-0.191-0.426-0.425-0.426H2.767V3.833h14.465V13.192z M10,7.237c-0.821,0-1.489,0.668-1.489,1.489c0,0.821,0.668,1.489,1.489,1.489c0.821,0,1.488-0.668,1.488-1.489C11.488,7.905,10.821,7.237,10,7.237 M10,9.364c-0.352,0-0.638-0.288-0.638-0.638c0-0.351,0.287-0.638,0.638-0.638c0.351,0,0.638,0.287,0.638,0.638C10.638,9.077,10.351,9.364,10,9.364 M14.254,7.237c-0.821,0-1.489,0.668-1.489,1.489c0,0.821,0.668,1.489,1.489,1.489s1.489-0.668,1.489-1.489C15.743,7.905,15.075,7.237,14.254,7.237 M14.254,9.364c-0.351,0-0.638-0.288-0.638-0.638c0-0.351,0.287-0.638,0.638-0.638c0.352,0,0.639,0.287,0.639,0.638C14.893,9.077,14.605,9.364,14.254,9.364 M5.746,7.237c-0.821,0-1.489,0.668-1.489,1.489c0,0.821,0.668,1.489,1.489,1.489c0.821,0,1.489-0.668,1.489-1.489C7.234,7.905,6.566,7.237,5.746,7.237 M5.746,9.364c-0.351,0-0.638-0.288-0.638-0.638c0-0.351,0.287-0.638,0.638-0.638c0.351,0,0.638,0.287,0.638,0.638C6.384,9.077,6.096,9.364,5.746,9.364"></path>
          </svg>
        </a>
      </li>
      
      <li>
        <a href="https://virtual-thom.github.io/about" title="Curriculum Vitae Thom">
          <svg class="svg-icon" viewBox="0 0 20 20">
            <path d="M12.075,10.812c1.358-0.853,2.242-2.507,2.242-4.037c0-2.181-1.795-4.618-4.198-4.618S5.921,4.594,5.921,6.775c0,1.53,0.884,3.185,2.242,4.037c-3.222,0.865-5.6,3.807-5.6,7.298c0,0.23,0.189,0.42,0.42,0.42h14.273c0.23,0,0.42-0.189,0.42-0.42C17.676,14.619,15.297,11.677,12.075,10.812 M6.761,6.775c0-2.162,1.773-3.778,3.358-3.778s3.359,1.616,3.359,3.778c0,2.162-1.774,3.778-3.359,3.778S6.761,8.937,6.761,6.775 M3.415,17.69c0.218-3.51,3.142-6.297,6.704-6.297c3.562,0,6.486,2.787,6.705,6.297H3.415z"></path>
          </svg>
        </a>
      </li>
    </ul>
  </nav>
</header>

      <div itemscope itemtype ="http://schema.org/Article" class="post">
  
  <header class="post-header">
    <h1 itemprop="name about headline" class="post-title">API VTOM webaccess (update)</h1>
    <p class="post-meta">
      <time itemprop="datePublished dateModified" datetime="2018-05-01T20:00:00+00:00">01-05-2018</time></p>
  </header>

  <article class="post-content" itemprop="articleBody">
    <h1 class="hidden">API VTOM webaccess (update)</h1>
    <h2 id="avertissement">Avertissement</h2>
<ul>
  <li>Les APIs ne sont pas soutenues pas Absyss pour le moment (ni documentées). Vous pouvez les utiliser mais on ne vous fournira aucune aide, assistance, ou débuggage d’après moi. (maj 11/05/20 à priori, les API seront supportées dès la v6.4.5)</li>
  <li>Il n’y a aucune garantie que ce qui fonctionne aujourd’hui fonctionnera de la même manière avec la prochaine version.</li>
  <li>Il est donc actuellement déconseillé de les exploiter en environnement productif.</li>
</ul>

<p>Petite update du <a href="/api-vtom-web-access">1 er post API VTOM via le WebAccess ici</a>.</p>

<h2 id="rappels-importants-sur-le-portail-web-et-les-api">Rappels importants sur le portail web et les API</h2>

<ul>
  <li>Côté serveur : Démarrez le service <code class="language-plaintext highlighter-rouge">vthttpd</code> et tapez <code class="language-plaintext highlighter-rouge">vtping</code> pour voir son état et son port. (le port est défini dans <code class="language-plaintext highlighter-rouge">/etc/services</code>). Le démarrage automatique peut être décommenté du script <code class="language-plaintext highlighter-rouge">$TOM_ADMIN/start_servers</code></li>
  <li>Côté client : Interface web type client léger afin d’explorer, piloter, et suivre l’exploitation d’un serveur VTOM. Rendez-vous sur l’url http://&lt;nomdevotreserveur ou sonIP&gt;:&lt;port&gt; et authentifiez-vous.</li>
  <li>Ouvrez votre navigateur Chrome F12 et allez dans l’onglet Network pour voir les appels aux API. Baladez dans les menus du portail web et glannez les différentes adresses et requêtes XHR.</li>
  <li>Requêter :
    <ul>
      <li>Rajouter dans le header des requêtes le user:mdp en base64 (voir mon premier post pour les détails) : ex. pour une XMLHttpRequest <code class="language-plaintext highlighter-rouge">xhr.setRequestHeader('Authorization', 'Basic VE9NOlRPTQ==')</code></li>
      <li>En local depuis le même serveur VTOM, les appels directs XMLHttpRequest Chrome passent sans soucis. En revanche, je n’ai pas réussi à faire fonctionner depuis un autre domaine (à cause du Cross-origin resource sharing - <a href="https://developer.mozilla.org/fr/docs/Web/HTTP/CORS">CORS</a>)</li>
      <li>sinon les appels en back-end fonctionnent très bien de n’importe où : <code class="language-plaintext highlighter-rouge">curl</code>, <code class="language-plaintext highlighter-rouge">node js</code>, <code class="language-plaintext highlighter-rouge">php</code> etc. 
<!--more-->
Exemple avec NodeJS</li>
    </ul>
  </li>
</ul>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ./vtom-api-client.js</span>
<span class="kd">const</span> <span class="nx">rp</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">request-promise-native</span><span class="dl">'</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">class</span> <span class="nc">VtomApiClient</span> <span class="p">{</span>
    <span class="nf">constructor</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">token</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">url</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">token</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{}</span>
    <span class="p">}</span>
    
    <span class="nf">getJob</span><span class="p">(</span><span class="nx">env</span><span class="p">,</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">job</span><span class="p">){</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nf">_request</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">/api/job/list?</span><span class="dl">"</span><span class="o">+</span>
            <span class="dl">"</span><span class="s2">environmentName=</span><span class="dl">"</span><span class="o">+</span><span class="nx">env</span><span class="o">+</span>
            <span class="dl">"</span><span class="s2">&amp;applicationName=</span><span class="dl">"</span><span class="o">+</span><span class="nx">app</span><span class="o">+</span>
            <span class="dl">"</span><span class="s2">&amp;name=</span><span class="dl">"</span><span class="o">+</span><span class="nx">job</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="nf">_buildOptions</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">endpoint</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="na">method</span><span class="p">:</span> <span class="nx">method</span><span class="p">,</span>
            <span class="na">uri</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">+</span> <span class="nx">endpoint</span><span class="p">,</span>
            <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
                <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">Authorization</span><span class="dl">'</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">token</span> <span class="p">?</span> <span class="s2">`Basic </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">token</span><span class="p">}</span><span class="s2">`</span> <span class="p">:</span> <span class="kc">undefined</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="na">body</span><span class="p">:</span> <span class="nx">data</span><span class="p">,</span>
            <span class="na">json</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="na">strictSSL</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">strictSSL</span><span class="p">,</span>
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="nf">_request</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">endpoint</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">_buildOptions</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">endpoint</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
        <span class="c1">//console.log(options);</span>
        <span class="k">return</span> <span class="nf">rp</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ./server.js </span>
<span class="c1">// (...)</span>
<span class="kd">const</span> <span class="nx">VtomApiClient</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./vtom-api-client.js</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">makeBasicToken</span> <span class="o">=</span> <span class="p">(</span><span class="nx">user</span><span class="p">,</span><span class="nx">password</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Buffer</span><span class="p">.</span><span class="k">from</span><span class="p">(</span>
    <span class="nx">user</span><span class="o">+</span><span class="dl">"</span><span class="s2">:</span><span class="dl">"</span><span class="o">+</span><span class="nx">Buffer</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="dl">'</span><span class="s1">base64</span><span class="dl">'</span><span class="p">).</span><span class="nf">toString</span><span class="p">(</span><span class="dl">'</span><span class="s1">ascii</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">).</span><span class="nf">toString</span><span class="p">(</span><span class="dl">'</span><span class="s1">base64</span><span class="dl">'</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">let</span> <span class="nx">monVtomApiClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">VtomApiClient</span><span class="p">(</span>
  <span class="nx">Config</span><span class="p">.</span><span class="nx">vthttpd</span><span class="p">[</span><span class="nx">domaine</span><span class="p">].</span><span class="nx">url</span><span class="p">,</span>
  <span class="nf">makeBasicToken</span><span class="p">(</span><span class="nx">Config</span><span class="p">.</span><span class="nx">vthttpd</span><span class="p">[</span><span class="nx">domaine</span><span class="p">].</span><span class="nx">user</span><span class="p">,</span><span class="nx">Config</span><span class="p">.</span><span class="nx">vthttpd</span><span class="p">[</span><span class="nx">domaine</span><span class="p">].</span><span class="nx">password</span><span class="p">),</span>
  <span class="p">{</span><span class="na">strictSSL</span><span class="p">:</span> <span class="kc">false</span><span class="p">}</span>
<span class="p">)</span>
<span class="c1">// (...)</span>
<span class="nx">monVtomApiClient</span><span class="p">.</span><span class="nf">getJob</span><span class="p">(</span><span class="nx">Jalon</span><span class="p">.</span><span class="nx">env</span><span class="p">,</span><span class="nx">Jalon</span><span class="p">.</span><span class="nx">app</span><span class="p">,</span><span class="nx">Jalon</span><span class="p">.</span><span class="nx">job</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">then</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
              <span class="c1">// data resultat de la requête API webaccess</span>
              <span class="nx">io</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">updateAllStatus</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Error: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">e</span><span class="p">))</span>
<span class="c1">// (...)</span>
</code></pre></div></div>

<h2 id="la-grosse-nouveauté-que-jattendais-">La grosse nouveauté que j’attendais !</h2>

<p>Le Suivi en temps réel du WebAccess était pas trop mal pour avoir les statuts en temps réel sur VTOM. Malheureusement, on était limité à 1000 jobs dans la requête (très peu donc). Bref, ça n’allait pas.</p>

<p>Maintenant, on a une nouvelle fonctionnalité depuis la v6.2, le “Suivi d’exploitation”. On peut filtrer par env, app, ou job. C’est excellent. On a tout ce qu’il faut pour un suivi météo : vtbegin, vtend, status etc.</p>

<p>Voici un exemple (notez qu’on n’est pas obligé de mettre les noms en entier, genre de LIKE %) :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/api/suiviExploit?environmentName=thom&amp;name=te
</code></pre></div></div>

<p>Et une capture d’écran :</p>

<p><img src="https://virtual-thom.github.io/archives/wp-content/uploads/suivi_exploitation_webaccess.png" alt="Suivi d'exploitation VTOM WebAccess API" /></p>

<h2 id="pour-mes-collègues-de-la-89c3--est-il-possible-de-déclencher-un-job-vtom-par-api-">Pour mes collègues de la 89C3 : Est-il possible de déclencher un job VTOM par API ?</h2>

<p>Of course !</p>

<ul>
  <li>Lister les applications/jobs à la demande :</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">/api/status/getOnDemand</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"result"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"jobSId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"JOBc0a8178000001547559555ab00000010"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"environmentSId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ENVc0a8178000000029559555a900000001"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"applicationSId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"APPc0a81780000041bb559555a900000009"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isAsked"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"retained"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"F"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"environmentName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"exploitation"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"comment"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Traitement termine (0)"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"timeEnd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1536755283"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"applicationName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"APPLICATION"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"jobName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"JOB_Unix"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"onDemand"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"executionMode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"E"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"timeBegin"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1536755282"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"exploited"</span><span class="p">:</span><span class="w"> </span><span class="s2">"E"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"cycleEnabled"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"jobSId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"JOBc0a8178000004d06559555ab0000000e"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"environmentSId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ENVc0a8178000000029559555a900000001"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"applicationSId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"APPc0a81780000041bb559555a900000009"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isAsked"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"retained"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"F"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"environmentName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"exploitation"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"comment"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Job en simulation, considere termine"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"timeEnd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1536710401"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"applicationName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"APPLICATION"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"jobName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"JOB_Windows"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"onDemand"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"executionMode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"S"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"timeBegin"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1536710400"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"exploited"</span><span class="p">:</span><span class="w"> </span><span class="s2">"E"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"cycleEnabled"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"rc"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>On récupère <code class="language-plaintext highlighter-rouge">jobSId</code> et on le demande (en changeant les paramètres si nécessaire) <code class="language-plaintext highlighter-rouge">/api/utilities/setObjectAction?id=JOBc0a8178000001547559555ab00000010&amp;action=JOB_ACTION_ASK&amp;parameters=%5B%22aurevoir+luke%22%5D</code></li>
</ul>

<p>(il faut faire des requêtes authentifiées bien sûr)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Pour le test dans la définition du « Type » dans XLR :
http://url:port/api/utilities/login
Il faut passer en clair les clés :
{ login : "logintest", password : "logintest" }
(user sans aucun droit)
Et attendre un retour comme ça : 
{
    "rc": 0,
    "result": {
        "rc": "0"
    }
}
 


Dans la tâche, ça sera des appels de ce type :

avec en Header : 
Authorization   Basic 
Avec user XLRTest et mdp XLRTest
Ou directement :
Authorization : Basic WExSVGVzdDpYTFJUZXN0
Ce user n’aura que les droits qu’on lui donne dans VTOM


Pour tout un tas de raison, il faut récupérer le jobSId, applicationSId et environmentSId.
Dans tous les cas, on devra connaître le nom du job VTOM à lancer : environmentName/applicationName/jobName

Deux possibilités,  : 
•	Soit on liste tous les jobs à la demande (le user ne voit que ce qu’on lui donne dans les droits du profil)
Je ne peux pas filtrer les tâches à la demande VTOM. Il faudra le faire sur le retour JSON.
Liste des tâches à la demande : 
/api/status/getOnDemand
{
    "rc": 0,
    "result": [
        {
            "jobSId": "",
            "jobName": "",
            "environmentName": "89C3",
            "environmentSId": "ENV7ef670af000006df5b990a310000000f",
            "exploited": "E",
            "status": "F",
            "comment": "",
            "applicationName": "APPTEST01",
            "applicationSId": "APP7ef670af00007faa5b990a4e000013bb",
            "timeEnd": "0",
            "timeBegin": "0",
            "onDemand": "1",
            "retained": "0",
            "isAsked": "1",
            "cycleEnabled": "0",
            "executionMode": "J"
        },
        {
            "jobSId": "JOB7ef670af0000053b5b990a95000062e4",
            "jobName": "JOB01",
            "environmentName": "89C3",
            "environmentSId": "ENV7ef670af000006df5b990a310000000f",
            "exploited": "E",
            "status": "F",
            "comment": "termine (0)",
            "applicationName": "APPTEST01",
            "applicationSId": "APP7ef670af00007faa5b990a4e000013bb",
            "timeEnd": "0",
            "timeBegin": "1537966364",
            "onDemand": "1",
            "retained": "0",
            "isAsked": "0",
            "cycleEnabled": "0",
            "executionMode": "E"
        }
    ]
}

•	Soit on sait que le job est bien un job à la demande VTOM, dans ce cas, on peut filtrer et on récupère les SId :
/api/job/list/?environmentName=89C3&amp;applicationName=APPTEST01&amp;name=JOB01
{
    "rc": 0,
    "result": {
        "rows": [
            {
                "envSId": "ENV7ef670af000006df5b990a310000000f",
                "exploited": "E",
                "status": "F",
                "comment": "",
                "applicationName": "APPTEST01",
                "environmentName": "89C3",
                "isAsked": "0",
                "retained": "0",
                "appSId": "APP7ef670af00007faa5b990a4e000013bb",
                "onDemand": "1",
                "id": "JOB7ef670af0000053b5b990a95000062e4",
                "name": "JOB01",
                "message": "termine (0)",
                "cycleEnabled": "0",
                "execMode": "E"
            }
        ],
        "columns": [
            "envSId",
            "environmentName",
            "appSId",
            "applicationName",
            "id",
            "name",
            "comment",
            "message",
            "status",
            "exploited",
            "retained",
            "onDemand",
            "isAsked",
            "cycleEnabled",
            "execMode"
        ]
    }
}


(a voir si on fait cette étape)
Il faut s’assurer que le moteur de l’environnement est bien démarré (result.rows[0].enginePid = 1): 
/api/environment/list?id=environmentSId
{
    "rc": 0,
    "result": {
        "rows": [
            {
                "id": "ENV7ef670af000006df5b990a310000000f",
                "enginePid": "1",
                "name": "89C3"
            }
        ],
        "columns": [
            "id",
            "name",
            "enginePid"
        ]
    }
}


Si status différent de W, Remettre AVENIR l’application - si tous les jobs à l’intérieur sont à lancer - et le job – si un job en particulier dans une application VTOM plus globale : 
/api/utilities/setObjectAction?id=applicationSId&amp;action=APP_ACTION_SET_WAIT
/api/utilities/setObjectAction?id=jobSId&amp;action=JOB_ACTION_SET_WAIT

Pour « demander » l’application VTOM : 
/api/utilities/setObjectAction?id=applicationSId&amp;action=APP_ACTION_ASK

Dans tous les cas, on demande le job avec les paramètres :
/api/utilities/setObjectAction
1.	id: 
JOB7ef670af0000053b5b990a95000062e4
2.	action: 
JOB_ACTION_ASK
3.	parameters: 
["taskIdXLR"]
</code></pre></div></div>

<p>Forcer un statut sur APP ou JOB_ACTION_SET_XXX, on remplace XXX
(ce qui vaut pour JOB, vaut pour APP)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>JOB_ACTION_SET_FINISHED ==&gt; TERMINE
JOB_ACTION_SET_ERROR ==&gt; EN ERREUR
JOB_ACTION_SET_RUNNING ==&gt; EN COURS
JOB_ACTION_SET_WAIT ==&gt; A VENIR
JOB_ACTION_SET_UNSCHEDULED ==&gt; NON PLANIFIE
</code></pre></div></div>

<p>Forcer une action</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>JOB_ACTION_RETAIN ==&gt; RETENIR
JOB_ACTION_CONTINUE ==&gt; RETENIR
JOB_ACTION_ASK ==&gt; DEMANDER
</code></pre></div></div>

  </article>
  
<nav>
  <ul class="pager">
    
     
    <li class="previous">
      <a href="https://virtual-thom.github.io/archives/parcel-bundler-dev-web/"><span aria-hidden="true">&larr;</span> Parcel bundler - Dev Web</a> 
    </li>
    
     
     <li class="next">
      <a class="next" href="https://virtual-thom.github.io/archives/modele-job-vtom-api-rest-webservice/">Webservice / Modele Job VTOM REST <span aria-hidden="true">&rarr;</span></a> 
    </li>
     
    
  </ul>
</nav>


  <footer class="post-footer">
    
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>API</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>webaccess</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>Visual TOM</a>
      
        <a itemprop="articleSection" class="btn btn-default btn-xs btn-categories" href="https://virtual-thom.github.io/archives"><span class="glyphicon glyphicon-asterisk"></span>VTOM</a>
      
    
    <span  itemprop="author publisher" class="hidden">Virtual Thom</span>
  </footer>
  
  <div id="disqus_thread" ></div>
  <script>
      var disqus_shortname = atob('dGhvbWFzLWFzbmFy'); 
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
</div>

      <footer id="site-footer">
    <div>&copy;<a href="https://github.com/virtual-thom/" title="Github Virtual-Thom">Virtual-Thom</a></div>
    <div>
            <a href="https://virtual-thom.github.io/archives/plan" title="Plan du site">sitemap</a> | <a href="https://virtual-thom.github.io/about" rel="publisher author" title="Curriculum vitae Thom">A propos</a>
    </div>
    <div>
        <a id="goto-site-header" href="#site-header" title="Retourner au début">&uArr; Top</a>
    </div>
    <div id="footer-disclaimer">
        <p>Avertissement : vous ne devez pas prendre pour argent comptant le contenu de ce site. Testez toujours la solution en environnement de test.</p>
        <p>Malgré le sérieux que je m'efforce de mettre dans le contenu de ces billets, je ne pourrai être tenu responsable d'éventuelles erreurs que cela pourrait engendrer.</p>
    </div>
    <div>
        <a class="hidden" href="https://virtual-thom.github.io/archives/sitemap.xml" title="SiteMap">sitemap</a>
    </div>
</footer>

    </div>
  </body>

</html>